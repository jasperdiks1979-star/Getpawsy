<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta name="description" content="<%= seoMeta.description %>">
  <link rel="canonical" href="<%= seoMeta.canonical %>">
  <title><%= seoMeta.title %></title>
  
  <meta property="og:title" content="<%= seoMeta.title %>">
  <meta property="og:description" content="<%= seoMeta.description %>">
  <meta property="og:type" content="website">
  <meta property="og:url" content="<%= seoMeta.canonical %>">
  
  <link rel="stylesheet" href="/styles.css?v=<%= typeof assetVersion !== 'undefined' ? assetVersion : 'dev' %>">
  <style>
    .category-page-header {
      background: var(--bg);
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
    }
    .category-page-header .wrap {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }
    .category-page-header .brand {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      text-decoration: none;
    }
    .category-page-header .main-nav {
      display: flex;
      gap: 24px;
    }
    .category-page-header .nav-link {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }
    .category-page-header .nav-link:hover {
      color: var(--brand);
    }
    .category-page-header .cartbtn {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: var(--radius-full);
      cursor: pointer;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <header class="category-page-header">
    <div class="wrap">
      <a class="brand" href="/">üêæ GetPawsy</a>
      <nav class="main-nav" aria-label="Main navigation">
        <a href="/dogs" class="nav-link">Dogs</a>
        <a href="/cats" class="nav-link">Cats</a>
        <a href="/toys" class="nav-link">Toys</a>
        <a href="/feeding" class="nav-link">Feeding</a>
        <a href="/accessories" class="nav-link">Accessories</a>
      </nav>
      <button id="cartBtn" class="cartbtn">Cart <span id="cartCount">0</span></button>
    </div>
  </header>
  
  <main class="wrap">
    <section class="category-hero" style="background: var(--hero-gradient); padding: var(--space-12) 0; text-align: center; margin: 0 calc(-1 * var(--space-4)); border-radius: var(--radius-lg);">
      <nav class="breadcrumbs" style="margin-bottom: var(--space-4);">
        <a href="/" style="color: var(--text-secondary);">Home</a>
        <span style="color: var(--muted); margin: 0 var(--space-2);">/</span>
        <% if (petType === 'dog') { %>
          <a href="/dogs" style="color: var(--text-secondary);">Dogs</a>
        <% } else if (petType === 'cat') { %>
          <a href="/cats" style="color: var(--text-secondary);">Cats</a>
        <% } else { %>
          <a href="/collections" style="color: var(--text-secondary);">Collections</a>
        <% } %>
        <span style="color: var(--muted); margin: 0 var(--space-2);">/</span>
        <span style="color: var(--text);"><%= bucketName %></span>
      </nav>
      <h1 style="font-size: var(--text-4xl); color: var(--text); margin-bottom: var(--space-3);">
        <% if (typeof bucketIcon !== 'undefined') { %><%= bucketIcon %><% } else if (petType === 'dog') { %>üê∂<% } else if (petType === 'cat') { %>üê±<% } else { %>üêæ<% } %> <%= bucketName %>
      </h1>
      <% if (typeof bucketDescription !== 'undefined') { %>
        <p style="font-size: var(--text-lg); color: var(--text-secondary); margin-bottom: var(--space-2);"><%= bucketDescription %></p>
      <% } %>
      <p style="font-size: var(--text-base); color: var(--muted);">
        <%= products.length %> product<%= products.length !== 1 ? 's' : '' %>
      </p>
    </section>

    <section style="padding: var(--space-8) 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6); flex-wrap: wrap; gap: var(--space-3);">
        <h2 style="font-size: var(--text-xl); color: var(--text);">All Products</h2>
        <div class="sort-dropdown">
          <label for="sortSelect" style="color: var(--text-secondary); font-size: var(--text-sm); margin-right: var(--space-2);">Sort by:</label>
          <select id="sortSelect" onchange="window.location.href='?sort=' + this.value" style="padding: var(--space-2) var(--space-3); border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--surface); color: var(--text); cursor: pointer;">
            <option value="newest" <%= (typeof currentSort !== 'undefined' && currentSort === 'newest') ? 'selected' : '' %>>Newest</option>
            <option value="price-low" <%= (typeof currentSort !== 'undefined' && currentSort === 'price-low') ? 'selected' : '' %>>Price: Low to High</option>
            <option value="price-high" <%= (typeof currentSort !== 'undefined' && currentSort === 'price-high') ? 'selected' : '' %>>Price: High to Low</option>
          </select>
        </div>
      </div>

      <% if (!products || products.length === 0) { %>
        <div style="text-align: center; padding: var(--space-12); color: var(--muted);">
          <p style="font-size: var(--text-lg); margin-bottom: var(--space-4);">No products available in this category yet.</p>
          <a href="/" class="btn">Back to Home</a>
        </div>
      <% } else { %>
        <div class="grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--space-6);">
          <% products.forEach((product, pIdx) => { %>
            <% 
              // Use resolved_image if available (set by backend), fallback to legacy resolution
              const catImgSrc = product.resolved_image || product.image || (product.images && product.images[0]) || '/images/placeholder-pawsy.webp';
              const optimizedCatSrc = catImgSrc.startsWith('/') ? catImgSrc : '/api/img?u=' + encodeURIComponent(catImgSrc) + '&w=400&fm=webp';
            %>
            <article class="card" style="background: var(--surface); border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-card); transition: box-shadow var(--dur) var(--ease-out), transform var(--dur) var(--ease-out);">
              <a href="/product/<%= product.slug || product.id %>" style="text-decoration: none;">
                <div style="position: relative; aspect-ratio: 1; overflow: hidden; background: var(--surface-2);">
                  <img 
                    src="<%= optimizedCatSrc %>" 
                    alt="<%= product.title || product.name %>"
                    style="width: 100%; height: 100%; object-fit: contain; opacity: 0; transition: opacity .3s, transform var(--dur-slow) var(--ease-out);"
                    loading="<%= pIdx < 8 ? 'eager' : 'lazy' %>"
                    decoding="async"
                    onerror="this.onerror=null;this.src='/images/placeholder-pawsy.webp'"
                    onload="this.style.opacity=1"
                  >
                  <% if (product.pet_score >= 10 || product.badge === 'Top Pick') { %>
                    <span style="position: absolute; top: var(--space-2); left: var(--space-2); background: var(--accent); color: white; padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--text-xs); font-weight: var(--font-weight-semibold);">Top Pick</span>
                  <% } %>
                </div>
                <div style="padding: var(--space-4);">
                  <h3 style="color: var(--text); font-size: var(--text-base); font-weight: var(--font-weight-medium); margin-bottom: var(--space-2); line-height: var(--leading-snug); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"><%= product.title || product.name %></h3>
                  <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-3);">
                    <span style="color: var(--brand); font-size: 0.75rem;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                    <span style="color: var(--muted); font-size: var(--text-xs);">(<%= product.reviews || Math.floor(Math.random() * 40) + 10 %>)</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text); font-size: var(--text-lg); font-weight: var(--font-weight-bold);">$<%= parseFloat(product.price || 0).toFixed(2) %></span>
                    <span class="btn btn-sm" style="font-size: var(--text-sm);">View</span>
                  </div>
                </div>
              </a>
            </article>
          <% }) %>
        </div>
      <% } %>
    </section>
  </main>

  <footer style="background: var(--surface-2); padding: var(--space-8) 0; margin-top: var(--space-12); text-align: center;">
    <p style="color: var(--muted); margin-bottom: var(--space-2);">&copy; 2025 GetPawsy. All rights reserved.</p>
    <nav style="display: flex; justify-content: center; gap: var(--space-4); flex-wrap: wrap;">
      <a href="/legal/privacy" style="color: var(--text-secondary); text-decoration: none;">Privacy</a>
      <a href="/legal/terms" style="color: var(--text-secondary); text-decoration: none;">Terms</a>
      <a href="/legal/returns" style="color: var(--text-secondary); text-decoration: none;">Returns</a>
      <a href="/contact" style="color: var(--text-secondary); text-decoration: none;">Contact</a>
    </nav>
    <span style="opacity:0.6;font-size:11px; display: block; margin-top: var(--space-2);">v2.2</span>
  </footer>

  <script src="/app.js?v=<%= typeof assetVersion !== 'undefined' ? assetVersion : 'dev' %>" defer></script>
  <!-- Fingerprint Badge (debug mode only) -->
  <% if (typeof debug !== 'undefined' && debug) { %>
  <div id="fpBadge" style="position:fixed;bottom:8px;left:8px;z-index:99999;background:rgba(0,0,0,0.9);color:#0f0;font-family:monospace;font-size:10px;padding:4px 8px;border-radius:4px;pointer-events:none;">LIVE: <%= typeof BUILD_FINGERPRINT !== 'undefined' ? BUILD_FINGERPRINT : 'unknown' %></div>
  <% } %>
</body>
</html>
