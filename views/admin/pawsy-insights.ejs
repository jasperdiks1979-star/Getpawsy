<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Pawsy Insights | GetPawsy Admin</title>
  <link rel="stylesheet" href="/css/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #0f0f0f; color: #eaeaea; }
    .admin-container { display: flex; min-height: 100vh; }
    .admin-main { margin-left: 260px; padding: 0; flex: 1; background: #1a1a1a; min-height: 100vh; }
    .admin-content { padding: 25px; }
    h1 { margin-bottom: 25px; color: #fff; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #252525; border-radius: 12px; padding: 20px; border: 1px solid #333; }
    .stat-card .value { font-size: 2rem; font-weight: 700; color: #00c4a7; }
    .stat-card .label { color: #999; font-size: 14px; margin-top: 5px; }
    .section { background: #252525; border-radius: 12px; padding: 25px; border: 1px solid #333; margin-bottom: 20px; }
    .section h2 { color: #00c4a7; margin-bottom: 20px; font-size: 1.1rem; }
    .question-list { list-style: none; }
    .question-list li { padding: 12px 0; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
    .question-list li:last-child { border-bottom: none; }
    .question-text { color: #ccc; flex: 1; }
    .question-count { color: #00c4a7; font-weight: 600; }
    .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .product-item { background: #333; border-radius: 8px; padding: 12px; text-align: center; }
    .product-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; margin-bottom: 8px; }
    .product-item .name { font-size: 12px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .product-item .recs { color: #00c4a7; font-size: 14px; font-weight: 600; }
  </style>
</head>
<body>
  <div class="admin-container">
    <%- include("../partials/admin/admin_sidebar", { active: 'pawsy-insights' }) %>
    
    <main class="admin-main">
      <%- include("../partials/admin/admin_header", { pageTitle: 'Pawsy Insights' }) %>
      
      <div class="admin-content">
        <h1>üêæ Pawsy Conversation Insights</h1>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="value" id="total-conversations">-</div>
            <div class="label">Total Conversations</div>
          </div>
          <div class="stat-card">
            <div class="value" id="products-recommended">-</div>
            <div class="label">Products Recommended</div>
          </div>
          <div class="stat-card">
            <div class="value" id="add-to-cart">-</div>
            <div class="label">Add to Cart Clicks</div>
          </div>
          <div class="stat-card">
            <div class="value" id="conversion-rate">-</div>
            <div class="label">Conversion Rate</div>
          </div>
        </div>
        
        <div class="section">
          <h2>üìä Top Questions</h2>
          <ul class="question-list" id="top-questions">
            <li style="color: #666;">Loading...</li>
          </ul>
        </div>
        
        <div class="section">
          <h2>üõçÔ∏è Most Recommended Products</h2>
          <div class="product-list" id="top-products">
            <div style="color: #666;">Loading...</div>
          </div>
        </div>
        
        <div class="section">
          <h2>‚ùì "I Don't Know" Responses</h2>
          <ul class="question-list" id="unknown-questions">
            <li style="color: #666;">Loading...</li>
          </ul>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    async function loadInsights() {
      try {
        const res = await fetch('/api/admin/pawsy/insights');
        const data = await res.json();
        
        if (data.ok) {
          document.getElementById('total-conversations').textContent = data.totalConversations || 0;
          document.getElementById('products-recommended').textContent = data.productsRecommended || 0;
          document.getElementById('add-to-cart').textContent = data.addToCartClicks || 0;
          document.getElementById('conversion-rate').textContent = (data.conversionRate || 0).toFixed(1) + '%';
          
          renderTopQuestions(data.topQuestions || []);
          renderTopProducts(data.topProducts || []);
          renderUnknownQuestions(data.unknownQuestions || []);
        }
      } catch (err) {
        console.error('Error loading insights:', err);
      }
    }
    
    function renderTopQuestions(questions) {
      const el = document.getElementById('top-questions');
      if (!questions.length) {
        el.innerHTML = '<li style="color: #666;">No data yet</li>';
        return;
      }
      el.innerHTML = questions.map(q => `
        <li>
          <span class="question-text">"${q.question}"</span>
          <span class="question-count">${q.count}x</span>
        </li>
      `).join('');
    }
    
    function renderTopProducts(products) {
      const el = document.getElementById('top-products');
      if (!products.length) {
        el.innerHTML = '<div style="color: #666;">No data yet</div>';
        return;
      }
      el.innerHTML = products.map(p => `
        <div class="product-item">
          <img src="${p.image || '/images/placeholder.png'}" alt="${p.title}" onerror="this.src='/images/placeholder.png'">
          <div class="name">${p.title}</div>
          <div class="recs">${p.recommendations}x</div>
        </div>
      `).join('');
    }
    
    function renderUnknownQuestions(questions) {
      const el = document.getElementById('unknown-questions');
      if (!questions.length) {
        el.innerHTML = '<li style="color: #6ee7b7;">No "I don\'t know" responses - great!</li>';
        return;
      }
      el.innerHTML = questions.map(q => `
        <li>
          <span class="question-text">"${q.question}"</span>
          <span class="question-count">${q.count}x</span>
        </li>
      `).join('');
    }
    
    loadInsights();
  </script>
</body>
</html>
