const fs = require('fs');
const path = require('path');

function generateQAReport() {
  const resultsPath = path.join(__dirname, 'results.json');
  
  if (!fs.existsSync(resultsPath)) {
    console.log('No test results found. Run tests first.');
    return;
  }
  
  const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
  const suites = results.suites || [];
  
  let totalTests = 0;
  let passed = 0;
  let failed = 0;
  let skipped = 0;
  const failures = [];
  const allTests = [];
  
  function processSpecs(specs, suiteName) {
    for (const spec of specs) {
      totalTests++;
      const testResult = {
        suite: suiteName,
        name: spec.title,
        status: spec.ok ? 'passed' : 'failed',
        duration: spec.tests?.[0]?.results?.[0]?.duration || 0,
        error: null
      };
      
      if (spec.ok) {
        passed++;
      } else {
        failed++;
        const error = spec.tests?.[0]?.results?.[0]?.error;
        testResult.error = error?.message || 'Unknown error';
        failures.push({
          suite: suiteName,
          test: spec.title,
          error: testResult.error,
          location: spec.file || 'unknown'
        });
      }
      
      allTests.push(testResult);
    }
  }
  
  function processSuites(suiteList, parentName = '') {
    for (const suite of suiteList) {
      const suiteName = parentName ? `${parentName} > ${suite.title}` : suite.title;
      
      if (suite.specs) {
        processSpecs(suite.specs, suiteName);
      }
      
      if (suite.suites) {
        processSuites(suite.suites, suiteName);
      }
    }
  }
  
  processSuites(suites);
  
  const timestamp = new Date().toISOString();
  const passRate = totalTests > 0 ? ((passed / totalTests) * 100).toFixed(1) : 0;
  
  const jsonReport = {
    meta: {
      timestamp,
      baseUrl: process.env.BASE_URL || 'http://localhost:5000',
      totalTests,
      passed,
      failed,
      skipped,
      passRate: `${passRate}%`
    },
    summary: {
      status: failed === 0 ? 'PASS' : 'FAIL',
      criticalFailures: failures.slice(0, 10)
    },
    tests: allTests,
    failures
  };
  
  const mdReport = `# GetPawsy QA Report

## Summary
- **Generated:** ${timestamp}
- **Base URL:** ${jsonReport.meta.baseUrl}
- **Status:** ${jsonReport.summary.status}

## Test Results
| Metric | Count |
|--------|-------|
| Total Tests | ${totalTests} |
| Passed | ${passed} |
| Failed | ${failed} |
| Skipped | ${skipped} |
| Pass Rate | ${passRate}% |

## Failures
${failures.length === 0 ? 'No failures! All tests passed.' : ''}
${failures.map((f, i) => `
### ${i + 1}. ${f.test}
- **Suite:** ${f.suite}
- **Error:** ${f.error}
- **Location:** ${f.location}
`).join('\n')}

## Test Details
| Suite | Test | Status | Duration |
|-------|------|--------|----------|
${allTests.map(t => `| ${t.suite.substring(0, 40)} | ${t.name.substring(0, 40)} | ${t.status} | ${t.duration}ms |`).join('\n')}

## Top 10 Critical Issues
${failures.slice(0, 10).map((f, i) => `${i + 1}. **${f.test}**: ${f.error.substring(0, 100)}`).join('\n') || 'None'}

---
*Report generated by GetPawsy QA System*
`;

  fs.writeFileSync(path.join(process.cwd(), 'qa-report.json'), JSON.stringify(jsonReport, null, 2));
  fs.writeFileSync(path.join(process.cwd(), 'qa-report.md'), mdReport);
  
  console.log('\n========================================');
  console.log('       GETPAWSY QA REPORT SUMMARY');
  console.log('========================================');
  console.log(`Status: ${jsonReport.summary.status}`);
  console.log(`Tests: ${passed}/${totalTests} passed (${passRate}%)`);
  console.log(`Failures: ${failed}`);
  console.log('----------------------------------------');
  console.log('Reports written to:');
  console.log('  - qa-report.json');
  console.log('  - qa-report.md');
  console.log('========================================\n');
  
  return jsonReport;
}

if (require.main === module) {
  generateQAReport();
}

module.exports = { generateQAReport };
