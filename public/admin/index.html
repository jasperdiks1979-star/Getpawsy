<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard ‚Äî GetPawsy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0f0f1e;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.6;
    }
    header {
      background: #1a1a2e;
      border-bottom: 2px solid #00C4A7;
      padding: 20px;
    }
    header h1 { font-size: 24px; color: #00C4A7; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .tabs {
      display: flex;
      gap: 10px;
      border-bottom: 1px solid #262643;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: #aaa;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    .tab-btn.active {
      color: #00C4A7;
      border-bottom-color: #00C4A7;
    }
    .tab-btn:hover { color: #00C4A7; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1a1a2e;
      border: 1px solid #262643;
      border-radius: 8px;
      overflow: hidden;
    }
    th {
      background: #262643;
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      color: #00C4A7;
      font-size: 11px;
      white-space: nowrap;
    }
    td {
      padding: 8px;
      border-top: 1px solid #262643;
      font-size: 12px;
      vertical-align: middle;
    }
    tr:hover { background: #262643; }
    tr.deleted { opacity: 0.5; }
    .status-ok { color: #00C4A7; }
    .status-error { color: #ff6b6b; }
    .status-warning { color: #ffa500; }
    .btn {
      padding: 6px 12px;
      background: #00C4A7;
      color: #1a1a2e;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 11px;
    }
    .btn:hover { background: #00d4b8; }
    .btn:disabled { background: #666; cursor: not-allowed; }
    .btn-sm { padding: 4px 8px; font-size: 10px; }
    .btn-danger { background: #ff6b6b; color: #fff; }
    .btn-danger:hover { background: #ff5252; }
    .btn-secondary { background: #444; color: #fff; }
    .btn-secondary:hover { background: #555; }
    .actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat {
      background: #1a1a2e;
      border: 1px solid #262643;
      padding: 15px;
      border-radius: 8px;
      flex: 1;
      min-width: 200px;
    }
    .stat-label { font-size: 12px; color: #aaa; margin-bottom: 5px; }
    .stat-value { font-size: 20px; font-weight: 900; color: #00C4A7; }
    .logs { max-height: 400px; overflow-y: auto; background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 10px; }
    .log-line { font-family: monospace; font-size: 11px; color: #aaa; padding: 5px 0; border-bottom: 1px solid #262643; }
    .log-error { color: #ff6b6b; }
    .loading { color: #00C4A7; text-align: center; padding: 20px; }
    .error-msg { color: #ff6b6b; padding: 10px; background: #2a1a1a; border-radius: 4px; margin: 10px 0; }
    .success-msg { color: #00C4A7; padding: 10px; background: #1a2a1a; border-radius: 4px; margin: 10px 0; }
    .upload-zone {
      border: 2px dashed #262643;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      background: #1a1a2e;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    .upload-zone.dragover {
      border-color: #00C4A7;
      background: #1a2a2e;
    }
    .upload-zone input[type="file"] { display: none; }
    .upload-zone label {
      cursor: pointer;
      color: #00C4A7;
      font-weight: 600;
    }
    .progress-bar {
      background: #262643;
      border-radius: 4px;
      height: 20px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      background: #00C4A7;
      height: 100%;
      transition: width 0.3s;
    }
    .progress-text { font-size: 12px; color: #aaa; margin-bottom: 10px; }
    .import-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }
    .import-stat {
      background: #262643;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .import-stat-value { font-size: 18px; font-weight: bold; color: #00C4A7; }
    .import-stat-label { font-size: 11px; color: #aaa; }
    .error-list {
      max-height: 200px;
      overflow-y: auto;
      background: #1a1a2e;
      border: 1px solid #262643;
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
    }
    .error-item {
      font-family: monospace;
      font-size: 11px;
      color: #ff6b6b;
      padding: 3px 0;
      border-bottom: 1px solid #262643;
    }
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filters input, .filters select {
      padding: 8px 12px;
      border: 1px solid #262643;
      border-radius: 4px;
      background: #1a1a2e;
      color: #fff;
      font-size: 13px;
    }
    .filters input:focus, .filters select:focus {
      outline: none;
      border-color: #00C4A7;
    }
    .filters input { width: 250px; }
    .filters select { min-width: 120px; }
    .pagination {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 15px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .pagination-info { font-size: 12px; color: #aaa; }
    .pagination-btns { display: flex; gap: 5px; }
    .product-thumb {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 4px;
      background: #262643;
    }
    .product-title {
      cursor: pointer;
      color: #00C4A7;
      text-decoration: none;
    }
    .product-title:hover { text-decoration: underline; }
    .bulk-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 10px;
      background: #262643;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .bulk-actions.hidden { display: none; }
    .bulk-count { font-size: 12px; color: #fff; margin-right: 10px; }
    .drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      display: none;
    }
    .drawer-overlay.active { display: block; }
    .drawer {
      position: fixed;
      top: 0;
      right: -450px;
      width: 450px;
      max-width: 100%;
      height: 100%;
      background: #1a1a2e;
      z-index: 1001;
      transition: right 0.3s;
      overflow-y: auto;
      box-shadow: -5px 0 20px rgba(0,0,0,0.5);
    }
    .drawer.active { right: 0; }
    .drawer-header {
      padding: 20px;
      border-bottom: 1px solid #262643;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .drawer-header h2 { font-size: 18px; color: #00C4A7; }
    .drawer-close {
      background: none;
      border: none;
      color: #aaa;
      font-size: 24px;
      cursor: pointer;
    }
    .drawer-close:hover { color: #fff; }
    .drawer-body { padding: 20px; }
    .drawer-image {
      width: 100%;
      max-height: 250px;
      object-fit: contain;
      border-radius: 8px;
      background: #262643;
      margin-bottom: 20px;
    }
    .drawer-field {
      margin-bottom: 15px;
    }
    .drawer-field label {
      display: block;
      font-size: 11px;
      color: #aaa;
      margin-bottom: 4px;
    }
    .drawer-field-value {
      font-size: 14px;
      color: #fff;
      word-break: break-word;
    }
    .drawer-variants {
      background: #262643;
      border-radius: 4px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
    }
    .drawer-variant {
      font-size: 11px;
      padding: 5px 0;
      border-bottom: 1px solid #333;
    }
    .drawer-variant:last-child { border-bottom: none; }
    .drawer-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }
    .status-active { background: #1a3a2a; color: #00C4A7; }
    .status-inactive { background: #3a2a1a; color: #ffa500; }
    .status-deleted { background: #3a1a1a; color: #ff6b6b; }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #262643;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 2000;
      animation: slideIn 0.3s;
    }
    .toast.success { border-left: 4px solid #00C4A7; }
    .toast.error { border-left: 4px solid #ff6b6b; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: #1a1a2e; padding: 40px; border-radius: 16px; max-width: 400px; width: 90%; text-align: center; border: 1px solid #262643;">
      <h2 style="color: #00C4A7; margin-bottom: 10px;">üîê Admin Login</h2>
      <p style="color: #aaa; font-size: 13px; margin-bottom: 25px;">Enter your admin token to continue</p>
      <input type="password" id="loginTokenInput" placeholder="ADMIN_API_TOKEN" style="width: 100%; padding: 14px; background: #262643; border: 1px solid #444; border-radius: 8px; color: #fff; font-size: 14px; margin-bottom: 15px; box-sizing: border-box;">
      <p id="loginError" style="color: #ff6b6b; font-size: 12px; margin-bottom: 15px; display: none;"></p>
      <button onclick="submitLogin()" class="btn" style="width: 100%; padding: 14px; font-size: 15px;">Login</button>
      <p style="color: #666; font-size: 11px; margin-top: 20px;">Cookie-based session (works on iOS Safari)</p>
    </div>
  </div>

  <header style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
    <h1>üêæ GetPawsy Admin Dashboard</h1>
    <div style="display: flex; align-items: center; gap: 12px;">
      <span id="authStatusIndicator" style="font-size: 11px;"></span>
      <button onclick="logout()" style="padding: 8px 16px; background: #ff6b6b; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Logout</button>
    </div>
  </header>

  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
      <button class="tab-btn" onclick="switchTab('import')">Import CSV</button>
      <button class="tab-btn" onclick="switchTab('cjimport')">CJ Import</button>
      <button class="tab-btn" onclick="switchTab('cjbrowse')">CJ Browse</button>
      <button class="tab-btn" onclick="switchTab('cjfeeds')" id="cjFeedsTab">CJ Feeds <span id="cjFeedsBadge" style="display: none; background: #00C4A7; color: #1a1a2e; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-left: 4px;"></span></button>
      <button class="tab-btn" onclick="switchTab('products')">Products</button>
      <button class="tab-btn" onclick="switchTab('rejected')">Rejected</button>
      <button class="tab-btn" onclick="switchTab('audit')">Audit</button>
      <button class="tab-btn" onclick="switchTab('orders')">Orders</button>
      <button class="tab-btn" onclick="switchTab('sync')">Sync</button>
      <button class="tab-btn" onclick="switchTab('logs')">Logs</button>
      <button class="tab-btn" onclick="switchTab('cleanup')">Cleanup</button>
      <button class="tab-btn" onclick="switchTab('inbox')" id="inboxTab">Inbox <span id="inboxBadge" style="display: none; background: #ff6b6b; color: #fff; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-left: 4px;"></span></button>
      <button class="tab-btn" onclick="switchTab('reviews')" id="reviewsTab">Reviews <span id="reviewsBadge" style="display: none; background: #ffc107; color: #1a1a2e; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-left: 4px;"></span></button>
      <button class="tab-btn" onclick="switchTab('styleguide')">Style Guide</button>
      <button class="tab-btn" onclick="switchTab('imageaudit')">Image Audit</button>
      <button class="tab-btn" onclick="switchTab('googleads')">Google Ads</button>
      <button class="tab-btn" onclick="switchTab('herostudio')">Hero Studio</button>
      <button class="tab-btn" onclick="switchTab('experiments')">Experiments</button>
      <button class="tab-btn" onclick="switchTab('seogen')">SEO</button>
      <button class="tab-btn" onclick="switchTab('toppicks')">Top Picks</button>
      <button class="tab-btn" onclick="switchTab('enrich')">Enrich CJ</button>
      <button class="tab-btn" onclick="switchTab('languages')">Languages</button>
      <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
      <button class="tab-btn" onclick="switchTab('pricing')">Pricing & CSV</button>
      <button class="tab-btn" onclick="switchTab('backups')">Backups</button>
      <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="actions">
        <button class="btn" onclick="switchTab('import')">üì§ Import CJ CSV</button>
        <button class="btn" onclick="placePendingOrders()">üöÄ Place Pending Orders</button>
        <button class="btn" onclick="clearCache()">üóëÔ∏è Clear Image Cache</button>
      </div>
      <div id="stats" class="actions"></div>
    </div>

    <!-- Import Tab -->
    <div id="import" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Import CJ Products CSV</h2>
      
      <div class="upload-zone" id="uploadZone">
        <p style="margin-bottom: 10px;">üìÅ Drag & drop your CJ CSV file here</p>
        <p style="margin-bottom: 20px; color: #aaa; font-size: 12px;">or</p>
        <label for="csvFile" class="btn">Choose File</label>
        <input type="file" id="csvFile" accept=".csv,text/csv" />
        <p style="margin-top: 15px; color: #aaa; font-size: 11px;">
          Supports large CSV files. Images will be cached sequentially to avoid timeouts.
        </p>
      </div>

      <div id="importProgress" style="display: none;">
        <h3 style="margin-bottom: 15px;">Import Progress</h3>
        <div class="progress-text" id="progressPhase">Preparing...</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar" style="width: 0%"></div>
        </div>
        
        <div class="import-stats">
          <div class="import-stat">
            <div class="import-stat-value" id="statRows">0</div>
            <div class="import-stat-label">CSV Rows</div>
          </div>
          <div class="import-stat">
            <div class="import-stat-value" id="statProducts">0</div>
            <div class="import-stat-label">Products</div>
          </div>
          <div class="import-stat">
            <div class="import-stat-value" id="statImagesCached">0</div>
            <div class="import-stat-label">Images Cached</div>
          </div>
          <div class="import-stat">
            <div class="import-stat-value" id="statImagesFailed">0</div>
            <div class="import-stat-label">Images Failed</div>
          </div>
        </div>

        <div id="importErrors" style="display: none;">
          <h4 style="margin-bottom: 10px; color: #ff6b6b;">Errors (import continues)</h4>
          <div class="error-list" id="errorList"></div>
        </div>

        <div id="importComplete" style="display: none;" class="success-msg">
          <strong>‚úÖ Import Complete!</strong>
          <p id="importSummary"></p>
        </div>
      </div>
    </div>

    <!-- Products Tab -->
    <div id="products" class="tab-content">
      <div class="filters">
        <input type="text" id="productSearch" placeholder="Search by title, ID, or SPU..." />
        <select id="filterSource">
          <option value="all">All Sources</option>
          <option value="cj-api">CJ API</option>
          <option value="csv">CSV Import</option>
          <option value="manual">Manual</option>
        </select>
        <select id="filterStatus">
          <option value="all">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="deleted">Deleted</option>
        </select>
        <select id="filterPetType">
          <option value="all">All Pets</option>
          <option value="dog">Dogs</option>
          <option value="cat">Cats</option>
        </select>
        <select id="pageSize">
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
          <option value="100">100 per page</option>
        </select>
        <button class="btn" onclick="loadProducts()">Apply</button>
      </div>
      
      <div id="bulkActions" class="bulk-actions hidden">
        <span class="bulk-count"><span id="selectedCount">0</span> selected</span>
        <button class="btn btn-sm" onclick="bulkEnable()">Enable</button>
        <button class="btn btn-sm btn-secondary" onclick="bulkDisable()">Disable</button>
        <button class="btn btn-sm btn-danger" onclick="bulkDelete()">Delete</button>
        <button class="btn btn-sm" onclick="bulkRefreshImages()" style="background: #6b5bff; color: #fff;">Refresh Images</button>
        <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear</button>
      </div>

      <div id="productsTable">
        <div class="loading">Loading products...</div>
      </div>
      
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- Rejected Tab -->
    <div id="rejected" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Rejected Products</h2>
      
      <div id="rejectedStats" class="actions" style="margin-bottom: 20px;">
        <div class="stat">
          <div class="stat-label">Total Rejected</div>
          <div class="stat-value" id="rejectedCount">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">Active Products</div>
          <div class="stat-value" id="activeCount">-</div>
        </div>
      </div>

      <div class="actions" style="margin-bottom: 20px;">
        <button class="btn" onclick="previewScan()">üëÅÔ∏è Preview Scan</button>
        <button class="btn btn-danger" onclick="runScan()">üîç Scan & Reject Non-Pet</button>
      </div>

      <div id="scanPreview" style="display: none; margin-bottom: 20px;">
        <h4 style="color: #ffa500; margin-bottom: 10px;">Preview: Products that would be rejected</h4>
        <div id="previewStats" style="margin-bottom: 10px; font-size: 12px; color: #aaa;"></div>
        <div id="previewList" class="error-list" style="max-height: 300px;"></div>
        <button class="btn btn-danger" style="margin-top: 10px;" onclick="runScan()">Confirm & Reject These Products</button>
      </div>

      <div class="filters" style="margin-bottom: 15px;">
        <input type="text" id="rejectedSearch" placeholder="Search rejected products..." />
        <button class="btn" onclick="loadRejected()">Search</button>
      </div>

      <div id="rejectedBulkActions" class="bulk-actions hidden">
        <span class="bulk-count"><span id="rejectedSelectedCount">0</span> selected</span>
        <button class="btn btn-sm" onclick="bulkRestoreRejected()">Restore Selected</button>
        <button class="btn btn-sm btn-secondary" onclick="clearRejectedSelection()">Clear</button>
      </div>

      <div id="rejectedTable">
        <div class="loading">Loading rejected products...</div>
      </div>
      
      <div class="pagination" id="rejectedPagination"></div>
    </div>

    <!-- CJ Import Tab -->
    <div id="cjimport" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Import from CJ Dropshipping</h2>
      
      <div id="cjStatus" class="actions" style="margin-bottom: 20px;">
        <div class="stat">
          <div class="stat-label">CJ API Status</div>
          <div class="stat-value" id="cjApiStatus">Checking...</div>
        </div>
      </div>

      <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 14px;">Import by URL or SPU</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <input type="text" id="cjUrlInput" placeholder="Paste CJ product URL or SPU..." 
                 style="flex: 1; min-width: 300px; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;" />
          <button class="btn" onclick="previewCJImport()">Preview</button>
          <button class="btn" onclick="importCJProduct()" id="cjImportBtn" disabled>Import</button>
        </div>
        <p style="margin-top: 10px; font-size: 11px; color: #aaa;">
          Supports CJ product URLs (e.g., cjdropshipping.com/product/...) or direct SPU/PID values
        </p>
      </div>

      <div id="cjPreview" style="display: none; background: #1a1a2e; border: 1px solid #00C4A7; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 14px; color: #00C4A7;">Product Preview</h3>
        <div id="cjPreviewContent"></div>
      </div>
      
      <div id="cjPreviewError" style="display: none; background: #3d1a1a; border: 1px solid #ff6b6b; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 10px; font-size: 14px; color: #ff6b6b;">Preview Failed</h3>
        <div id="cjPreviewErrorContent" style="font-size: 12px; color: #ffaaaa;"></div>
      </div>

      <div id="cjImportOptions" style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 14px;">Import Options</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
              <input type="checkbox" id="cjRequireImages" checked />
              <span style="font-size: 12px;">Require product images</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
              <input type="checkbox" id="cjRejectNonPet" checked />
              <span style="font-size: 12px;">Reject if NOT pet-related</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="cjOverwrite" />
              <span style="font-size: 12px;">Overwrite if product exists</span>
            </label>
          </div>
          
          <div>
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
              <input type="checkbox" id="cjMarkFeatured" checked />
              <span style="font-size: 12px;">Mark as Featured</span>
            </label>
            <div style="margin-bottom: 10px;">
              <label style="font-size: 11px; color: #aaa; display: block; margin-bottom: 4px;">Featured Rank:</label>
              <select id="cjFeaturedRank" style="width: 100%; padding: 6px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;">
                <option value="auto">Auto (next available)</option>
                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                <option value="10">10</option><option value="11">11</option><option value="12">12</option>
              </select>
            </div>
          </div>
          
          <div>
            <div style="margin-bottom: 10px;">
              <label style="font-size: 11px; color: #aaa; display: block; margin-bottom: 4px;">Category Pin:</label>
              <select id="cjCategoryPin" style="width: 100%; padding: 6px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;">
                <option value="AUTO">Auto-detect</option>
                <option value="DOG">Dog Top Picks</option>
                <option value="CAT">Cat Top Picks</option>
                <option value="NONE">None</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; color: #aaa; display: block; margin-bottom: 4px;">Subcategory Pin:</label>
              <select id="cjSubcatPin" style="width: 100%; padding: 6px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;">
                <option value="AUTO">Auto-detect</option>
                <option value="NONE">None</option>
                <option value="DOG_CHEW">Dog Chew</option>
                <option value="DOG_FETCH">Dog Fetch</option>
                <option value="DOG_BEDS">Dog Beds</option>
                <option value="DOG_WALK">Dog Walk</option>
                <option value="CAT_PLAY">Cat Play</option>
                <option value="CAT_SCRATCH">Cat Scratch</option>
                <option value="CAT_BEDS">Cat Beds</option>
                <option value="CAT_LITTER">Cat Litter</option>
                <option value="CAT_GROOM">Cat Groom</option>
              </select>
            </div>
          </div>
        </div>
        
        <div id="cjDetectedInfo" style="margin-top: 15px; padding: 10px; background: #262643; border-radius: 4px; display: none;">
          <span style="font-size: 11px; color: #aaa;">Detected: </span>
          <span id="cjDetectedPetType" style="font-size: 11px; color: #00C4A7;"></span>
          <span style="font-size: 11px; color: #aaa;"> | Subcategory: </span>
          <span id="cjDetectedSubcat" style="font-size: 11px; color: #00C4A7;"></span>
        </div>
      </div>

      <div id="cjImportResult" style="display: none;"></div>

      <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 14px;">Bulk Import</h3>
        <textarea id="cjBulkInput" rows="5" placeholder="Paste multiple URLs or SPUs (one per line)..."
                  style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; resize: vertical;"></textarea>
        <button class="btn" style="margin-top: 10px;" onclick="bulkCJImport()">Bulk Import</button>
        <p style="margin-top: 10px; font-size: 11px; color: #aaa;">Maximum 50 products per batch</p>
      </div>
    </div>

    <!-- CJ Browse Tab -->
    <div id="cjbrowse" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Browse CJ Dropshipping Catalog</h2>
      
      <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
          <input type="text" id="cjBrowseKeyword" placeholder="Search CJ products (e.g., dog bed, cat toy)..."
                 style="flex: 1; min-width: 250px; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;" />
          <button class="btn" onclick="searchCJBrowse()">Search</button>
        </div>
        
        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
            <input type="checkbox" id="cjBrowseUsOnly" checked />
            <span>US Warehouse Only</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
            <input type="checkbox" id="cjBrowsePetOnly" checked />
            <span>Pet Products Only</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
            <input type="checkbox" id="cjBrowseImages" checked />
            <span>Require Images</span>
          </label>
          <select id="cjBrowseSort" style="padding: 6px 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;">
            <option value="">Default Sort</option>
            <option value="lowCost">Lowest Cost</option>
            <option value="highMargin">Highest Margin</option>
          </select>
          <div style="display: flex; gap: 8px; align-items: center;">
            <span style="font-size: 11px; color: #aaa;">Price:</span>
            <input type="number" id="cjBrowseMinPrice" placeholder="Min" min="0" step="0.01"
                   style="width: 70px; padding: 6px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;" />
            <span style="color: #aaa;">-</span>
            <input type="number" id="cjBrowseMaxPrice" placeholder="Max" min="0" step="0.01"
                   style="width: 70px; padding: 6px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;" />
          </div>
        </div>
      </div>

      <div id="cjBrowseLoading" style="display: none;" class="loading">Searching CJ catalog...</div>
      
      <div id="cjBrowseResults" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <div id="cjBrowseInfo" style="font-size: 12px; color: #aaa;"></div>
          <div id="cjBrowsePagination" style="display: flex; gap: 8px;"></div>
        </div>
        
        <div id="cjBrowseGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px;"></div>
        
        <div id="cjBrowsePaginationBottom" style="display: flex; justify-content: center; gap: 8px; margin-top: 20px;"></div>
      </div>

      <div id="cjBrowseFallbackWarning" style="display: none; background: #3d3d00; border: 1px solid #666600; border-radius: 6px; padding: 12px 16px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 18px;">‚ö†Ô∏è</span>
          <div>
            <div style="font-weight: 600; color: #ffcc00; font-size: 13px;" id="cjBrowseFallbackTitle">Filters Relaxed</div>
            <div style="font-size: 11px; color: #ccc;" id="cjBrowseFallbackDesc">Some filters were relaxed to show results</div>
          </div>
        </div>
      </div>

      <div id="cjBrowseEmpty" style="display: none; text-align: center; padding: 40px; color: #aaa;">
        <p style="font-size: 16px; margin-bottom: 10px;">No products found</p>
        <p style="font-size: 12px;">Try different keywords or adjust your filters</p>
      </div>
    </div>

    <!-- CJ Feeds Tab -->
    <div id="cjfeeds" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #00C4A7;">CJ Saved Searches / Feeds</h2>
        <div style="display: flex; gap: 10px;">
          <button class="btn" onclick="runAllFeeds()" id="runAllBtn">Run All Feeds</button>
          <button class="btn btn-secondary" onclick="loadFeedsWithStats()">Refresh</button>
        </div>
      </div>

      <!-- Scheduler Stats -->
      <div id="schedulerStats" class="actions" style="margin-bottom: 20px;">
        <div class="stat">
          <div class="stat-label">Next Auto-Run</div>
          <div class="stat-value" id="schedNextRun" style="font-size: 14px;">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">Last Run</div>
          <div class="stat-value" id="schedLastRun" style="font-size: 14px;">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total NEW</div>
          <div class="stat-value" id="schedTotalNew">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Imported Today</div>
          <div class="stat-value" id="schedTodayImported">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Status</div>
          <div class="stat-value" id="schedStatus" style="font-size: 14px;">-</div>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="font-size: 14px; margin-bottom: 15px;">Create New Feed</h3>
          <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: #aaa; display: block; margin-bottom: 4px;">Feed Name</label>
            <input type="text" id="feedName" placeholder="e.g., Dog Toys US" style="width: 100%; padding: 8px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;" />
          </div>
          <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: #aaa; display: block; margin-bottom: 4px;">Search Keyword</label>
            <input type="text" id="feedKeyword" placeholder="e.g., dog toy" style="width: 100%; padding: 8px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;" />
          </div>
          <div style="margin-bottom: 12px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px;">
              <input type="checkbox" id="feedUsOnly" /> US Warehouse Only
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; margin-top: 6px;">
              <input type="checkbox" id="feedPetOnly" checked /> Pet-Related Only
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; margin-top: 6px;">
              <input type="checkbox" id="feedFeatured" checked /> Mark as Featured
            </label>
          </div>
          <button class="btn" onclick="createFeed()" style="width: 100%;">Create Feed</button>
        </div>
        
        <div>
          <h3 style="font-size: 14px; margin-bottom: 15px;">Your Feeds</h3>
          <div id="feedsList" style="display: grid; gap: 10px;"></div>
        </div>
      </div>
      
      <div id="feedResults" style="display: none; margin-top: 20px; background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="font-size: 14px;">Feed Results: <span id="feedResultsName"></span></h3>
          <div style="display: flex; gap: 10px;">
            <span id="feedResultsInfo" style="font-size: 12px; color: #aaa;"></span>
            <button class="btn btn-sm" onclick="bulkImportNewFromFeed()">Import NEW Items</button>
            <button class="btn btn-sm btn-secondary" onclick="markAllSeen()">Mark All Seen</button>
            <button class="btn btn-sm btn-secondary" onclick="closeFeedResults()">Close</button>
          </div>
        </div>
        <div id="feedResultsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;"></div>
      </div>
    </div>

    <!-- Audit Tab -->
    <div id="audit" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Product Quality Audit</h2>
      
      <div class="actions" style="margin-bottom: 20px;">
        <button class="btn" onclick="runAudit()">üîç Run Full Audit</button>
      </div>

      <div id="auditSummary" style="display: none;">
        <div class="actions" style="margin-bottom: 20px;">
          <div class="stat">
            <div class="stat-label">Total Products</div>
            <div class="stat-value" id="auditTotalProducts">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Total Issues</div>
            <div class="stat-value" id="auditTotalIssues">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Duplicate Images</div>
            <div class="stat-value" id="auditDuplicateImages">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Duplicate Titles</div>
            <div class="stat-value" id="auditDuplicateTitles">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Image Issues</div>
            <div class="stat-value" id="auditImageIssues">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Variant Issues</div>
            <div class="stat-value" id="auditVariantIssues">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Pricing Issues</div>
            <div class="stat-value" id="auditPricingIssues">-</div>
          </div>
        </div>
      </div>

      <div id="auditResults" style="display: none;">
        <div style="margin-bottom: 30px;">
          <h3 style="margin-bottom: 15px; font-size: 14px; color: #ffa500;">Duplicate Images</h3>
          <p style="font-size: 11px; color: #aaa; margin-bottom: 10px;">Products sharing the same main image</p>
          <div id="duplicateImagesList" class="error-list" style="max-height: 300px;"></div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="margin-bottom: 15px; font-size: 14px; color: #ffa500;">Duplicate Titles</h3>
          <p style="font-size: 11px; color: #aaa; margin-bottom: 10px;">Products with identical or very similar titles</p>
          <div id="duplicateTitlesList" class="error-list" style="max-height: 300px;"></div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="margin-bottom: 15px; font-size: 14px; color: #ffa500;">Image Issues</h3>
          <p style="font-size: 11px; color: #aaa; margin-bottom: 10px;">Products with missing, invalid, or placeholder images</p>
          <div id="imageIssuesList" class="error-list" style="max-height: 300px;"></div>
          <button class="btn btn-sm btn-danger" style="margin-top: 10px;" id="fixImageIssuesBtn" onclick="fixImageIssues()" disabled>Disable All With Image Issues</button>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="margin-bottom: 15px; font-size: 14px; color: #ffa500;">Variant Issues</h3>
          <p style="font-size: 11px; color: #aaa; margin-bottom: 10px;">Products with missing SKUs, invalid prices, or other variant problems</p>
          <div id="variantIssuesList" class="error-list" style="max-height: 300px;"></div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="margin-bottom: 15px; font-size: 14px; color: #ffa500;">Pricing Issues</h3>
          <p style="font-size: 11px; color: #aaa; margin-bottom: 10px;">Products with invalid, too low, or suspiciously high prices</p>
          <div id="pricingIssuesList" class="error-list" style="max-height: 300px;"></div>
        </div>
      </div>

      <div id="auditLoading" style="display: none;" class="loading">Running audit...</div>
    </div>

    <!-- Orders Tab -->
    <div id="orders" class="tab-content">
      <div class="loading">Loading orders...</div>
    </div>

    <!-- Sync Tab -->
    <div id="sync" class="tab-content">
      <div class="loading">Loading sync status...</div>
    </div>

    <!-- Logs Tab -->
    <div id="logs" class="tab-content">
      <div class="loading">Loading logs...</div>
    </div>

    <!-- Cleanup Tab -->
    <div id="cleanup" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Pet Eligibility Audit & Cleanup</h2>
      
      <!-- Pet Audit Section -->
      <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 16px; color: #00C4A7; display: flex; align-items: center; gap: 8px;">
          <span>üêæ</span> Pet Eligibility Check
        </h3>
        <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
          Scan products using strict pet eligibility rules (HARD_DENY keywords, HARD_ALLOW keywords, scoring system).
        </p>
        
        <div id="petAuditStats" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div style="background: #262643; padding: 12px; border-radius: 6px;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Total Products</div>
            <div style="color: #00C4A7; font-size: 18px; font-weight: 600; margin-top: 4px;" id="petAuditTotal">-</div>
          </div>
          <div style="background: #262643; padding: 12px; border-radius: 6px;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Non-Pet Products</div>
            <div style="color: #ff6b6b; font-size: 18px; font-weight: 600; margin-top: 4px;" id="petAuditNonPetCount">-</div>
          </div>
          <div style="background: #262643; padding: 12px; border-radius: 6px;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Last Run</div>
            <div style="color: #aaa; font-size: 12px; margin-top: 4px;" id="petAuditLastRun">Never</div>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
          <button class="btn" onclick="rebuildPetTypeClassification()" id="rebuildPetTypeBtn" style="background: #9b59b6; font-size: 13px;">üêæ Rebuild Pet Classification</button>
          <button class="btn btn-secondary" onclick="petAuditScan()" id="petAuditScanBtn">üîç Scan for Non-Pet Products</button>
          <button class="btn btn-secondary" onclick="petAuditApplySoft()" id="petAuditApplySoftBtn" disabled>üîí Soft Delete (Hide)</button>
          <button class="btn btn-secondary" onclick="petAuditApplyHard()" id="petAuditApplyHardBtn" disabled style="background: #e67e22;">‚ö†Ô∏è Hard Delete (Permanent)</button>
          <button class="btn btn-secondary" onclick="petAuditUndo()" id="petAuditUndoBtn" disabled>‚Ü©Ô∏è Restore Soft Deleted</button>
          <button class="btn btn-secondary" onclick="petRebuildClassification()" id="petRebuildBtn" style="background: #3498db;">üîÑ Rebuild Usage + Buckets</button>
        </div>
        
        <div id="petClassificationResult" style="display: none; background: #262643; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <h4 style="color: #9b59b6; margin-bottom: 12px;">Pet Classification Results</h4>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="text-align: center;"><div style="font-size: 24px; color: #3498db; font-weight: bold;" id="petClassDog">-</div><div style="font-size: 11px; color: #aaa;">üêï Dog</div></div>
            <div style="text-align: center;"><div style="font-size: 24px; color: #e74c3c; font-weight: bold;" id="petClassCat">-</div><div style="font-size: 11px; color: #aaa;">üê± Cat</div></div>
            <div style="text-align: center;"><div style="font-size: 24px; color: #27ae60; font-weight: bold;" id="petClassBoth">-</div><div style="font-size: 11px; color: #aaa;">üêæ Both</div></div>
            <div style="text-align: center;"><div style="font-size: 24px; color: #7f8c8d; font-weight: bold;" id="petClassNull">-</div><div style="font-size: 11px; color: #aaa;">‚ùå Non-Pet</div></div>
          </div>
        </div>
        
        <div id="petAuditResults" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #262643;">
          <h4 style="color: #ffa500; margin-bottom: 12px;">Sample Non-Pet Products (max 50)</h4>
          <div id="petAuditTable" style="max-height: 400px; overflow-y: auto; background: #262643; border-radius: 6px; padding: 12px;"></div>
        </div>
      </div>

      <!-- Purge Non-Pet Section -->
      <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 16px; color: #ff6b6b; display: flex; align-items: center; gap: 8px;">
          <span>üßπ</span> Catalog Cleanup (Purge Non-Pet)
        </h3>
        <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
          Remove non-pet products from catalog using blacklist/whitelist rules. Also fixes category mismatches.
        </p>
        
        <div id="purgeStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
          <div style="background: #262643; padding: 12px; border-radius: 6px; text-align: center;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">To Remove</div>
            <div style="color: #ff6b6b; font-size: 18px; font-weight: 600; margin-top: 4px;" id="purgeAffectedCount">-</div>
          </div>
          <div style="background: #262643; padding: 12px; border-radius: 6px; text-align: center;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Category Fixes</div>
            <div style="color: #ffa500; font-size: 18px; font-weight: 600; margin-top: 4px;" id="purgeCategoryFixes">-</div>
          </div>
          <div style="background: #262643; padding: 12px; border-radius: 6px; text-align: center;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">New Total</div>
            <div style="color: #00C4A7; font-size: 18px; font-weight: 600; margin-top: 4px;" id="purgeNewTotal">-</div>
          </div>
          <div style="background: #262643; padding: 12px; border-radius: 6px; text-align: center;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Last Run</div>
            <div style="color: #aaa; font-size: 12px; margin-top: 4px;" id="purgeLastRun">Never</div>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
          <button class="btn btn-secondary" onclick="purgePreview()" id="purgePreviewBtn">üëÅÔ∏è Preview Cleanup</button>
          <button class="btn" onclick="purgeDeactivate()" id="purgeDeactivateBtn" style="background: #e67e22;" disabled>üîí Deactivate Non-Pet</button>
          <button class="btn btn-danger" onclick="purgeDelete()" id="purgeDeleteBtn" disabled>üóëÔ∏è Delete Non-Pet (Danger)</button>
        </div>
        
        <div id="purgeConfirmDelete" style="display: none; background: #2a1a1a; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
          <p style="color: #ff6b6b; font-size: 12px; margin-bottom: 8px;">‚ö†Ô∏è Type DELETE to confirm permanent deletion:</p>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="purgeConfirmInput" placeholder="Type DELETE" style="flex: 1; padding: 8px; background: #262643; border: 1px solid #ff6b6b; border-radius: 4px; color: #fff;" />
            <button class="btn btn-danger" onclick="purgeDeleteConfirm()">Confirm Delete</button>
          </div>
        </div>
        
        <div id="purgeResults" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #262643;">
          <h4 style="color: #ffa500; margin-bottom: 12px;">Affected Products (max 50)</h4>
          <div id="purgeResultsTable" style="max-height: 300px; overflow-y: auto; background: #262643; border-radius: 6px; padding: 12px; font-size: 11px;"></div>
        </div>
      </div>

      <!-- CJ Cost Sync Section -->
      <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 16px; color: #3498db; display: flex; align-items: center; gap: 8px;">
          <span>üí∞</span> CJ Cost Sync
        </h3>
        <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
          Bulk-fetch cost prices from CJ Dropshipping API and update product costs.
        </p>
        
        <div id="cjCostStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
          <div style="background: #262643; padding: 12px; border-radius: 6px; text-align: center;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Products with CJ</div>
            <div style="color: #3498db; font-size: 18px; font-weight: 600; margin-top: 4px;" id="cjCostProductsWithCj">-</div>
          </div>
          <div style="background: #262643; padding: 12px; border-radius: 6px; text-align: center;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Updated</div>
            <div style="color: #00C4A7; font-size: 18px; font-weight: 600; margin-top: 4px;" id="cjCostUpdated">-</div>
          </div>
          <div style="background: #262643; padding: 12px; border-radius: 6px; text-align: center;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Failed</div>
            <div style="color: #ff6b6b; font-size: 18px; font-weight: 600; margin-top: 4px;" id="cjCostFailed">-</div>
          </div>
          <div style="background: #262643; padding: 12px; border-radius: 6px; text-align: center;">
            <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Progress</div>
            <div style="color: #aaa; font-size: 12px; margin-top: 4px;" id="cjCostProgress">-</div>
          </div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="color: #aaa; font-size: 12px; display: block; margin-bottom: 8px;">Limit (leave empty for all):</label>
          <input type="number" id="cjCostLimit" placeholder="e.g., 10" min="1" max="1000" style="width: 120px; padding: 8px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;" />
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
          <button class="btn btn-secondary" onclick="cjCostPreview()" id="cjCostPreviewBtn">üëÅÔ∏è Preview (Dry-Run)</button>
          <button class="btn" onclick="cjCostApply()" id="cjCostApplyBtn" style="background: #3498db;" disabled>‚úÖ Apply Costs</button>
          <a href="/downloads/getpawsy_cj_cost_export.csv" class="btn btn-secondary" style="text-decoration: none;" id="cjCostDownloadBtn">üì• Download CSV</a>
        </div>
        
        <div id="cjCostErrors" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #262643;">
          <h4 style="color: #ff6b6b; margin-bottom: 12px;">Errors (first 20)</h4>
          <div id="cjCostErrorsList" style="max-height: 200px; overflow-y: auto; background: #262643; border-radius: 6px; padding: 12px; font-size: 11px;"></div>
        </div>
      </div>

      <div id="cleanupStats" class="actions" style="margin-bottom: 20px;">
        <div class="stat">
          <div class="stat-label">Ineligible Found</div>
          <div class="stat-value" id="cleanupIneligibleCount">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">Quarantined</div>
          <div class="stat-value" id="cleanupQuarantinedCount">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">Active Products</div>
          <div class="stat-value" id="cleanupActiveCount">-</div>
        </div>
      </div>

      <div class="actions" style="margin-bottom: 20px;">
        <button class="btn" onclick="scanForIneligible()">üîç Scan Catalog (Legacy)</button>
        <button class="btn btn-secondary" onclick="loadQuarantined()">üì¶ View Quarantined</button>
        <button class="btn btn-secondary" onclick="runCleanupValidation()">‚úÖ Run Validation Tests</button>
      </div>

      <div id="cleanupScanResults" style="display: none; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="font-size: 14px; color: #ffa500;">Ineligible Products Found</h3>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-sm btn-danger" onclick="quarantineSelected()">Quarantine Selected</button>
            <button class="btn btn-sm btn-danger" onclick="quarantineAll()">Quarantine All</button>
          </div>
        </div>
        <div id="cleanupBulkActions" class="bulk-actions hidden">
          <span class="bulk-count"><span id="cleanupSelectedCount">0</span> selected</span>
          <button class="btn btn-sm btn-secondary" onclick="clearCleanupSelection()">Clear</button>
        </div>
        <div id="cleanupScanTable"></div>
      </div>

      <div id="cleanupQuarantinedSection" style="display: none; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="font-size: 14px; color: #ffa500;">Quarantined Products</h3>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-sm" onclick="undoQuarantineSelected()">Undo Selected</button>
            <button class="btn btn-sm btn-danger" onclick="deleteQuarantinedSelected()">Delete Selected</button>
          </div>
        </div>
        <div id="quarantinedBulkActions" class="bulk-actions hidden">
          <span class="bulk-count"><span id="quarantinedSelectedCount">0</span> selected</span>
          <button class="btn btn-sm btn-secondary" onclick="clearQuarantinedSelection()">Clear</button>
        </div>
        <div id="quarantinedTable"></div>
      </div>

      <div id="cleanupValidationResults" style="display: none; margin-bottom: 20px;">
        <h3 style="font-size: 14px; margin-bottom: 15px; color: #00C4A7;">Validation Test Results</h3>
        <div id="validationResultsContent"></div>
      </div>
    </div>

    <!-- Inbox Tab -->
    <div id="inbox" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Contact Inbox</h2>
      
      <div class="actions" style="margin-bottom: 20px;">
        <div class="stat">
          <div class="stat-label">Unread Messages</div>
          <div class="stat-value" id="inboxUnreadCount">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Messages</div>
          <div class="stat-value" id="inboxTotalCount">-</div>
        </div>
      </div>

      <div class="filters" style="margin-bottom: 15px;">
        <select id="inboxStatusFilter">
          <option value="">All Messages</option>
          <option value="unread">Unread</option>
          <option value="read">Read</option>
          <option value="replied">Replied</option>
          <option value="archived">Archived</option>
        </select>
        <button class="btn" onclick="loadInboxMessages()">Filter</button>
        <button class="btn btn-secondary" onclick="loadInboxMessages()">Refresh</button>
      </div>

      <div id="inboxTable">
        <div class="loading">Loading messages...</div>
      </div>
    </div>

    <!-- Inbox Message Drawer -->
    <div class="drawer-overlay" id="inboxDrawerOverlay" onclick="closeInboxDrawer()"></div>
    <div class="drawer" id="inboxDrawer">
      <div class="drawer-header">
        <h2>Message Details</h2>
        <button class="drawer-close" onclick="closeInboxDrawer()">&times;</button>
      </div>
      <div class="drawer-body" id="inboxDrawerBody"></div>
    </div>

    <!-- Reviews Tab -->
    <div id="reviews" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Review Moderation</h2>
      
      <div class="actions" style="margin-bottom: 20px;">
        <div class="stat-card" style="display: inline-block; margin-right: 15px;">
          <div class="stat-label">Pending</div>
          <div class="stat-value" id="reviewsPendingCount" style="color: #ffc107;">-</div>
        </div>
        <div class="stat-card" style="display: inline-block; margin-right: 15px;">
          <div class="stat-label">Approved</div>
          <div class="stat-value" id="reviewsApprovedCount" style="color: #00C4A7;">-</div>
        </div>
        <div class="stat-card" style="display: inline-block;">
          <div class="stat-label">Rejected</div>
          <div class="stat-value" id="reviewsRejectedCount" style="color: #ff6b6b;">-</div>
        </div>
      </div>

      <div class="filters" style="margin-bottom: 15px;">
        <select id="reviewsStatusFilter">
          <option value="">All Reviews</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
        <button class="btn" onclick="loadAdminReviews()">Filter</button>
        <button class="btn btn-secondary" onclick="loadAdminReviews()">Refresh</button>
      </div>

      <div id="reviewsTable">
        <div class="loading">Loading reviews...</div>
      </div>
    </div>

    <!-- Reviews Drawer -->
    <div class="drawer-overlay" id="reviewsDrawerOverlay" onclick="closeReviewsDrawer()"></div>
    <div class="drawer" id="reviewsDrawer">
      <div class="drawer-header">
        <h2>Review Details</h2>
        <button class="drawer-close" onclick="closeReviewsDrawer()">&times;</button>
      </div>
      <div class="drawer-body" id="reviewsDrawerBody"></div>
    </div>

    <!-- Style Guide Tab -->
    <div id="styleguide" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Premium Theme Style Guide</h2>
      
      <div style="display: grid; gap: 30px;">
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Color Palette</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #f8f8fb; border-radius: 8px; margin: 0 auto 8px; border: 1px solid #ddd;"></div><div style="font-size: 11px; color: #aaa;">--bg<br>#f8f8fb</div></div>
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #ffffff; border-radius: 8px; margin: 0 auto 8px; border: 1px solid #ddd;"></div><div style="font-size: 11px; color: #aaa;">--surface<br>#ffffff</div></div>
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #1a1a2e; border-radius: 8px; margin: 0 auto 8px;"></div><div style="font-size: 11px; color: #aaa;">--text<br>#1a1a2e</div></div>
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #00C4A7; border-radius: 8px; margin: 0 auto 8px;"></div><div style="font-size: 11px; color: #aaa;">--brand<br>#00C4A7</div></div>
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #7c5cff; border-radius: 8px; margin: 0 auto 8px;"></div><div style="font-size: 11px; color: #aaa;">--accent<br>#7c5cff</div></div>
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #e8e8ec; border-radius: 8px; margin: 0 auto 8px; border: 1px solid #ddd;"></div><div style="font-size: 11px; color: #aaa;">--muted<br>#e8e8ec</div></div>
          </div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Typography Scale</h3>
          <div style="display: grid; gap: 15px;">
            <div style="display: flex; align-items: baseline; gap: 20px;"><span style="font-size: 32px; font-weight: 800; color: #fff;">Heading 1</span><span style="font-size: 11px; color: #aaa;">32px / 800</span></div>
            <div style="display: flex; align-items: baseline; gap: 20px;"><span style="font-size: 24px; font-weight: 700; color: #fff;">Heading 2</span><span style="font-size: 11px; color: #aaa;">24px / 700</span></div>
            <div style="display: flex; align-items: baseline; gap: 20px;"><span style="font-size: 18px; font-weight: 600; color: #fff;">Heading 3</span><span style="font-size: 11px; color: #aaa;">18px / 600</span></div>
            <div style="display: flex; align-items: baseline; gap: 20px;"><span style="font-size: 16px; font-weight: 400; color: #fff;">Body Text</span><span style="font-size: 11px; color: #aaa;">16px / 400</span></div>
            <div style="display: flex; align-items: baseline; gap: 20px;"><span style="font-size: 14px; font-weight: 400; color: #aaa;">Small Text</span><span style="font-size: 11px; color: #aaa;">14px / 400</span></div>
          </div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Spacing Scale</h3>
          <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
            <div style="text-align: center;"><div style="width: 4px; height: 4px; background: #00C4A7;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">4px</div></div>
            <div style="text-align: center;"><div style="width: 8px; height: 8px; background: #00C4A7;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">8px</div></div>
            <div style="text-align: center;"><div style="width: 12px; height: 12px; background: #00C4A7;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">12px</div></div>
            <div style="text-align: center;"><div style="width: 16px; height: 16px; background: #00C4A7;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">16px</div></div>
            <div style="text-align: center;"><div style="width: 24px; height: 24px; background: #00C4A7;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">24px</div></div>
            <div style="text-align: center;"><div style="width: 32px; height: 32px; background: #00C4A7;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">32px</div></div>
            <div style="text-align: center;"><div style="width: 48px; height: 48px; background: #00C4A7;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">48px</div></div>
          </div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Button Styles</h3>
          <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <button class="btn">Primary Button</button>
            <button class="btn btn-secondary">Secondary</button>
            <button class="btn btn-danger">Danger</button>
            <button class="btn btn-sm">Small Button</button>
            <button class="btn" disabled>Disabled</button>
          </div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Status Badges</h3>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <span class="status-badge status-active">Active</span>
            <span class="status-badge status-inactive">Inactive</span>
            <span class="status-badge status-deleted">Deleted</span>
          </div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Border Radius</h3>
          <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #262643; border-radius: 4px;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">4px</div></div>
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #262643; border-radius: 8px;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">8px</div></div>
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #262643; border-radius: 12px;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">12px</div></div>
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #262643; border-radius: 16px;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">16px</div></div>
            <div style="text-align: center;"><div style="width: 60px; height: 60px; background: #262643; border-radius: 50%;"></div><div style="font-size: 10px; color: #aaa; margin-top: 5px;">50%</div></div>
          </div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Shadows</h3>
          <div style="display: flex; gap: 30px; flex-wrap: wrap; align-items: center;">
            <div style="text-align: center;"><div style="width: 80px; height: 60px; background: #262643; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div><div style="font-size: 10px; color: #aaa; margin-top: 8px;">Shadow SM</div></div>
            <div style="text-align: center;"><div style="width: 80px; height: 60px; background: #262643; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div><div style="font-size: 10px; color: #aaa; margin-top: 8px;">Shadow MD</div></div>
            <div style="text-align: center;"><div style="width: 80px; height: 60px; background: #262643; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.2);"></div><div style="font-size: 10px; color: #aaa; margin-top: 8px;">Shadow LG</div></div>
          </div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Motion Tokens</h3>
          <div style="font-size: 13px; color: #aaa; line-height: 2;">
            <div><strong style="color: #00C4A7;">--dur-fast:</strong> 120ms - Micro-interactions</div>
            <div><strong style="color: #00C4A7;">--dur:</strong> 180ms - Standard transitions</div>
            <div><strong style="color: #00C4A7;">--dur-slow:</strong> 260ms - Complex animations</div>
            <div><strong style="color: #00C4A7;">--ease-out:</strong> cubic-bezier(0.22, 1, 0.36, 1)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Audit Tab -->
    <div id="imageaudit" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Image Language Audit</h2>
      <p style="color: #aaa; margin-bottom: 20px;">Detect and filter product images with non-English text (e.g., German infographics) to show locale-appropriate images to visitors.</p>
      
      <div class="actions" id="imageAuditStats">
        <div class="stat">
          <div class="stat-label">Images Audited</div>
          <div class="stat-value" id="iaTotal">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">With Text</div>
          <div class="stat-value" id="iaWithText">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">Infographics</div>
          <div class="stat-value" id="iaInfographics">-</div>
        </div>
        <div class="stat">
          <div class="stat-label">Products Audited</div>
          <div class="stat-value" id="iaProducts">-</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" onclick="startImageAudit()">Start Full Audit</button>
        <button class="btn btn-secondary" onclick="startImageAudit(true)">Audit New Products Only</button>
        <button class="btn btn-danger" onclick="cancelImageAudit()">Cancel Audit</button>
        <button class="btn btn-secondary" onclick="loadImageAuditStats()">Refresh Stats</button>
      </div>

      <div id="imageAuditProgress" style="display: none; background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <div class="progress-text" id="iaProgressText">Processing...</div>
        <div class="progress-bar">
          <div class="progress-fill" id="iaProgressBar" style="width: 0%;"></div>
        </div>
        <div style="font-size: 12px; color: #aaa;" id="iaProgressDetails"></div>
      </div>

      <div style="display: grid; gap: 20px;">
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Audit Single Product</h3>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            <input type="text" id="iaSingleProductId" placeholder="Product ID" style="flex: 1; min-width: 200px; padding: 8px 12px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;" />
            <button class="btn" onclick="auditSingleProduct()">Audit Product</button>
          </div>
          <div id="iaSingleResult" style="margin-top: 15px;"></div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 15px; font-size: 16px; color: #fff;">Non-English Infographics</h3>
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <select id="iaLangFilter" style="padding: 8px 12px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;">
              <option value="">All Languages</option>
              <option value="de">German</option>
              <option value="fr">French</option>
              <option value="es">Spanish</option>
              <option value="zh">Chinese</option>
            </select>
            <button class="btn btn-secondary" onclick="loadInfographics()">Load Infographics</button>
          </div>
          <div id="iaInfographicsList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>

    <!-- Google Ads Tab -->
    <div id="googleads" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Google Ads Generator</h2>
      
      <div style="display: grid; gap: 24px; max-width: 1200px;">
        
        <!-- Quick Actions -->
        <div class="actions">
          <button class="btn" onclick="downloadSearchCSV()">Download Search Ads CSV</button>
          <button class="btn" onclick="downloadPMaxCSV()">Download PMax CSV</button>
          <button class="btn btn-secondary" onclick="loadGoogleAdsStats()">Refresh Stats</button>
        </div>

        <!-- Stats -->
        <div id="googleAdsStats" class="actions">
          <div class="stat">
            <div class="stat-label">Total Ad Assets</div>
            <div class="stat-value" id="adsCount">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Search Ads</div>
            <div class="stat-value" id="searchAdsCount">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">PMax Ads</div>
            <div class="stat-value" id="pmaxAdsCount">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Themes</div>
            <div class="stat-value" id="themesCount">-</div>
          </div>
        </div>

        <!-- Generate Ads Section -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            Generate Ads for Product
          </h3>
          
          <div style="display: grid; gap: 16px;">
            <div>
              <label style="font-size: 12px; color: #aaa; display: block; margin-bottom: 6px;">Select Product</label>
              <select id="adsProductSelect" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
                <option value="">Loading products...</option>
              </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="font-size: 12px; color: #aaa; display: block; margin-bottom: 6px;">Theme</label>
                <select id="adsThemeSelect" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
                  <option value="">Loading themes...</option>
                </select>
              </div>
              <div>
                <label style="font-size: 12px; color: #aaa; display: block; margin-bottom: 6px;">Ad Type</label>
                <select id="adsTypeSelect" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
                  <option value="both">Search + PMax</option>
                  <option value="search">Search Ads Only</option>
                  <option value="pmax">PMax Only</option>
                </select>
              </div>
            </div>
            
            <div id="suggestedTheme" style="display: none; padding: 10px; background: #262643; border-radius: 4px; font-size: 12px; color: #aaa;">
              Suggested theme: <span id="suggestedThemeName" style="color: #00C4A7; font-weight: 600;"></span>
            </div>
            
            <div style="display: flex; gap: 10px;">
              <button class="btn" onclick="generateAdsForProduct()">Generate Ads</button>
              <button class="btn btn-secondary" onclick="suggestThemeForProduct()">Suggest Theme</button>
            </div>
          </div>
        </div>

        <!-- Bulk Generate -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            Bulk Generate Ads
          </h3>
          
          <div style="display: grid; gap: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
              <div>
                <label style="font-size: 12px; color: #aaa; display: block; margin-bottom: 6px;">Category Filter</label>
                <select id="bulkCategory" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
                  <option value="">All Categories</option>
                  <option value="dog">Dogs</option>
                  <option value="cat">Cats</option>
                </select>
              </div>
              <div>
                <label style="font-size: 12px; color: #aaa; display: block; margin-bottom: 6px;">Theme</label>
                <select id="bulkTheme" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
                  <option value="auto">Auto-suggest per product</option>
                </select>
              </div>
              <div>
                <label style="font-size: 12px; color: #aaa; display: block; margin-bottom: 6px;">Limit</label>
                <select id="bulkLimit" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
                  <option value="10">10 products</option>
                  <option value="25">25 products</option>
                  <option value="50">50 products</option>
                  <option value="100">100 products</option>
                </select>
              </div>
            </div>
            
            <div>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="bulkSkipExisting" checked />
                <span style="font-size: 12px; color: #aaa;">Skip products that already have ads</span>
              </label>
            </div>
            
            <button class="btn" onclick="bulkGenerateAds()">Start Bulk Generation</button>
            
            <div id="bulkProgress" style="display: none;">
              <div class="progress-text" id="bulkProgressText">Generating...</div>
              <div class="progress-bar">
                <div class="progress-fill" id="bulkProgressBar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Existing Ads -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            Generated Ad Assets
          </h3>
          
          <div class="filters" style="margin-bottom: 15px;">
            <input type="text" id="adsSearch" placeholder="Search by product title..." style="flex: 1;" />
            <select id="adsTypeFilter" style="min-width: 120px;">
              <option value="all">All Types</option>
              <option value="search">Search Ads</option>
              <option value="pmax">PMax</option>
            </select>
            <button class="btn" onclick="loadGeneratedAds()">Search</button>
          </div>
          
          <div id="generatedAdsTable">
            <div class="loading">Loading ads...</div>
          </div>
          
          <div class="pagination" id="adsPagination"></div>
        </div>

        <!-- Themes Management -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            PMax Themes
          </h3>
          
          <div id="themesTable">
            <div class="loading">Loading themes...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hero Studio Tab -->
    <div id="herostudio" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Hero Studio - AI Image Generator</h2>
      
      <div style="display: grid; gap: 24px; grid-template-columns: 1fr 2fr;">
        <!-- Generation Panel -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 16px; color: #fff;">Generate New Hero</h3>
          
          <div style="display: grid; gap: 16px;">
            <div>
              <label style="display: block; font-size: 12px; color: #aaa; margin-bottom: 6px;">Category</label>
              <select id="heroCategory" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;">
                <option value="dogs">Dogs</option>
                <option value="cats">Cats</option>
                <option value="dogs-toys">Dogs - Toys</option>
                <option value="dogs-food">Dogs - Food</option>
                <option value="dogs-accessories">Dogs - Accessories</option>
                <option value="cats-toys">Cats - Toys</option>
                <option value="cats-food">Cats - Food</option>
                <option value="cats-accessories">Cats - Accessories</option>
              </select>
            </div>
            
            <div>
              <label style="display: block; font-size: 12px; color: #aaa; margin-bottom: 6px;">Style Preset</label>
              <select id="heroStyle" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;">
                <option value="bright-premium">Bright Premium</option>
                <option value="clean-studio">Clean Studio</option>
                <option value="outdoor-adventure">Outdoor Adventure</option>
                <option value="cozy-home">Cozy Home</option>
                <option value="playful-colorful">Playful & Colorful</option>
              </select>
            </div>
            
            <div>
              <label style="display: block; font-size: 12px; color: #aaa; margin-bottom: 6px;">Custom Keywords (optional)</label>
              <input type="text" id="heroKeywords" placeholder="e.g., winter theme, christmas, beach..." 
                     style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;" />
            </div>
            
            <div>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="heroBrandText" checked />
                <span style="font-size: 12px; color: #fff;">Include space for brand text overlay</span>
              </label>
            </div>
            
            <button class="btn" onclick="generateHero()" id="generateHeroBtn" style="width: 100%; padding: 12px;">
              üé® Generate Hero Images
            </button>
            
            <div id="heroGenerating" style="display: none; text-align: center; padding: 20px;">
              <div style="color: #00C4A7; margin-bottom: 10px;">‚è≥ Generating 3 aspect ratios...</div>
              <div style="font-size: 11px; color: #aaa;">This may take 30-60 seconds</div>
            </div>
          </div>
        </div>
        
        <!-- Heroes Gallery -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-size: 16px; color: #fff;">Generated Heroes</h3>
            <button class="btn btn-secondary btn-sm" onclick="loadHeroes()">Refresh</button>
          </div>
          
          <div id="heroesGrid" style="display: grid; gap: 16px;">
            <div class="loading">Loading heroes...</div>
          </div>
        </div>
      </div>
      
      <!-- Active Heroes Overview -->
      <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px; margin-top: 24px;">
        <h3 style="margin-bottom: 20px; font-size: 16px; color: #fff;">Active Heroes by Category</h3>
        <div id="activeHeroesGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
          <div class="loading">Loading active heroes...</div>
        </div>
      </div>
    </div>

    <!-- Experiments Tab -->
    <div id="experiments" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">A/B Testing Experiments</h2>
      
      <div style="display: grid; gap: 24px; max-width: 1000px;">
        <!-- Active Experiment -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-size: 16px; color: #fff;">PDP Hero: Image vs Video</h3>
            <div id="experimentToggle">
              <button class="btn btn-secondary" id="experimentToggleBtn" onclick="toggleExperiment('pdpHero')">Loading...</button>
            </div>
          </div>
          
          <p style="font-size: 13px; color: #aaa; margin-bottom: 20px;">
            Tests whether a product video or static image leads to better conversion on product detail pages.
            Visitors are randomly assigned to Variant A (Image) or Variant B (Video) and tracked through the funnel.
          </p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div style="background: #262643; border-radius: 8px; padding: 16px; text-align: center;">
              <div style="font-size: 12px; color: #aaa; margin-bottom: 8px;">Variant A</div>
              <div style="font-size: 24px; font-weight: 700; color: #fff;">Image</div>
            </div>
            <div style="background: #262643; border-radius: 8px; padding: 16px; text-align: center;">
              <div style="font-size: 12px; color: #aaa; margin-bottom: 8px;">Variant B</div>
              <div style="font-size: 24px; font-weight: 700; color: #00C4A7;">Video</div>
            </div>
          </div>
        </div>
        
        <!-- Experiment Results -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-size: 16px; color: #fff;">Results (Last 30 Days)</h3>
            <button class="btn btn-secondary btn-sm" onclick="loadExperimentSummary()">Refresh</button>
          </div>
          
          <div id="experimentResults">
            <div class="loading">Loading experiment data...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SEO Generator Tab -->
    <div id="seogen" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Multi-Language SEO Generator</h2>
      
      <div style="display: grid; gap: 24px; max-width: 1200px;">
        <!-- Stats Row -->
        <div class="actions" id="seoStats">
          <div class="stat">
            <div class="stat-label">Products with SEO</div>
            <div class="stat-value" id="seoProductCount">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">SEO Entries (All Locales)</div>
            <div class="stat-value" id="seoTotalEntries">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Published</div>
            <div class="stat-value" id="seoPublished">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Drafts</div>
            <div class="stat-value" id="seoDrafts">-</div>
          </div>
        </div>
        
        <!-- Product Search & Generate -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 16px; color: #fff;">Generate SEO for Product</h3>
          
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <input type="text" id="seoProductSearch" placeholder="Search product by title or ID..." 
                   style="flex: 1; min-width: 300px; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;" />
            <button class="btn" onclick="searchSeoProducts()">Search</button>
          </div>
          
          <div id="seoProductResults" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
            <div style="color: #666; font-size: 12px;">Search for a product to generate SEO content</div>
          </div>
          
          <div id="seoSelectedProduct" style="display: none; background: #262643; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
              <img id="seoProductImage" src="" alt="" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" />
              <div style="flex: 1; min-width: 200px;">
                <div id="seoProductTitle" style="font-weight: 600; color: #fff;"></div>
                <div id="seoProductId" style="font-size: 11px; color: #aaa;"></div>
              </div>
              <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <select id="seoLocaleSelect" style="padding: 8px 12px; background: #1a1a2e; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;" onchange="loadExistingSeo()">
                  <option value="en-US">üá∫üá∏ English (US)</option>
                  <option value="nl-NL">üá≥üá± Dutch (NL)</option>
                  <option value="de-DE">üá©üá™ German (DE)</option>
                  <option value="fr-FR">üá´üá∑ French (FR)</option>
                  <option value="es-ES">üá™üá∏ Spanish (ES)</option>
                </select>
                <select id="seoToneSelect" style="padding: 8px 12px; background: #1a1a2e; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
                  <option value="friendly">Friendly</option>
                  <option value="premium">Premium</option>
                  <option value="playful">Playful</option>
                  <option value="minimal">Minimal</option>
                </select>
                <button class="btn" onclick="generateProductSeo()" id="generateSeoBtn">Generate SEO</button>
              </div>
            </div>
            
            <!-- Locale Status Indicators -->
            <div id="seoLocaleStatus" style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;"></div>
          </div>
          
          <div id="seoGenerating" style="display: none; text-align: center; padding: 20px;">
            <div style="color: #00C4A7;">‚è≥ Generating SEO content with AI...</div>
          </div>
        </div>
        
        <!-- SEO Preview -->
        <div id="seoPreview" style="display: none; background: #1a1a2e; border: 1px solid #00C4A7; border-radius: 8px; padding: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <h3 style="font-size: 16px; color: #00C4A7;">
              SEO Content <span id="seoPreviewLocale" style="font-size: 12px; background: #262643; padding: 4px 8px; border-radius: 4px; margin-left: 8px;"></span>
              <span id="seoPreviewStatus" style="font-size: 11px; padding: 3px 8px; border-radius: 10px; margin-left: 8px;"></span>
            </h3>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary" onclick="saveSeoAsDraft()">Save Draft</button>
              <button class="btn" onclick="publishSeo()">Publish</button>
            </div>
          </div>
          
          <div style="display: grid; gap: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; font-size: 11px; color: #aaa; margin-bottom: 4px;">SEO Title <span id="seoTitleCount" style="color: #666;">(0/60)</span></label>
                <input type="text" id="seoTitle" style="width: 100%; background: #262643; padding: 10px; border-radius: 4px; color: #fff; border: 1px solid #333;" oninput="updateCharCount('seoTitle', 60)" />
              </div>
              <div>
                <label style="display: block; font-size: 11px; color: #aaa; margin-bottom: 4px;">H1 Heading</label>
                <input type="text" id="seoH1" style="width: 100%; background: #262643; padding: 10px; border-radius: 4px; color: #fff; border: 1px solid #333;" />
              </div>
            </div>
            
            <div>
              <label style="display: block; font-size: 11px; color: #aaa; margin-bottom: 4px;">Meta Description <span id="seoMetaDescCount" style="color: #666;">(0/155)</span></label>
              <textarea id="seoMetaDesc" style="width: 100%; background: #262643; padding: 10px; border-radius: 4px; color: #fff; border: 1px solid #333; min-height: 60px; resize: vertical;" oninput="updateCharCount('seoMetaDesc', 155)"></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; font-size: 11px; color: #aaa; margin-bottom: 4px;">OG Title (Social Share)</label>
                <input type="text" id="seoOgTitle" style="width: 100%; background: #262643; padding: 10px; border-radius: 4px; color: #fff; border: 1px solid #333;" />
              </div>
              <div>
                <label style="display: block; font-size: 11px; color: #aaa; margin-bottom: 4px;">OG Description</label>
                <input type="text" id="seoOgDesc" style="width: 100%; background: #262643; padding: 10px; border-radius: 4px; color: #fff; border: 1px solid #333;" />
              </div>
            </div>
            
            <div>
              <label style="display: block; font-size: 11px; color: #aaa; margin-bottom: 4px;">Bullet Points (one per line)</label>
              <textarea id="seoBullets" style="width: 100%; background: #262643; padding: 10px; border-radius: 4px; color: #fff; border: 1px solid #333; min-height: 100px; resize: vertical;"></textarea>
            </div>
            
            <div>
              <label style="display: block; font-size: 11px; color: #aaa; margin-bottom: 4px;">FAQ (Q: question | A: answer - one pair per line)</label>
              <textarea id="seoFaq" style="width: 100%; background: #262643; padding: 10px; border-radius: 4px; color: #fff; border: 1px solid #333; min-height: 100px; resize: vertical;"></textarea>
            </div>
            
            <div>
              <label style="display: block; font-size: 11px; color: #aaa; margin-bottom: 4px;">Keywords (comma-separated)</label>
              <input type="text" id="seoKeywords" style="width: 100%; background: #262643; padding: 10px; border-radius: 4px; color: #fff; border: 1px solid #333;" />
            </div>
          </div>
        </div>
        
        <!-- Bulk Generation -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 16px; color: #fff;">Bulk Generate SEO</h3>
          
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 16px;">
            <select id="bulkSeoLocale" style="padding: 8px 12px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
              <option value="en-US">üá∫üá∏ English (US)</option>
              <option value="nl-NL">üá≥üá± Dutch (NL)</option>
              <option value="de-DE">üá©üá™ German (DE)</option>
              <option value="fr-FR">üá´üá∑ French (FR)</option>
              <option value="es-ES">üá™üá∏ Spanish (ES)</option>
            </select>
            
            <select id="bulkSeoTone" style="padding: 8px 12px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
              <option value="friendly">Friendly Tone</option>
              <option value="premium">Premium Tone</option>
              <option value="playful">Playful Tone</option>
              <option value="minimal">Minimal Tone</option>
            </select>
            
            <input type="text" id="bulkSeoCategory" placeholder="Category filter (optional)" style="padding: 8px 12px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px; width: 180px;" />
            
            <select id="bulkSeoLimit" style="padding: 8px 12px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px;">
              <option value="10">10 products</option>
              <option value="25">25 products</option>
              <option value="50" selected>50 products</option>
              <option value="100">100 products</option>
            </select>
            
            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #aaa; cursor: pointer;">
              <input type="checkbox" id="bulkSeoSkipExisting" checked />
              Skip published
            </label>
            
            <button class="btn" onclick="startBulkSeoGeneration()" id="bulkSeoBtn">Start Bulk Generation</button>
            <button class="btn btn-danger" onclick="cancelBulkSeoJob()" id="bulkSeoCancelBtn" style="display: none;">Cancel</button>
          </div>
          
          <div id="bulkSeoProgress" style="display: none;">
            <div class="progress-bar" style="margin-bottom: 10px;">
              <div class="progress-fill" id="bulkSeoProgressBar" style="width: 0%"></div>
            </div>
            <div id="bulkSeoStatus" style="font-size: 12px; color: #aaa;"></div>
          </div>
          
          <div id="bulkSeoResults" style="display: none; margin-top: 16px; padding: 12px; background: #262643; border-radius: 8px;">
            <div id="bulkSeoResultsContent" style="font-size: 12px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Picks Tab -->
    <div id="toppicks" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Top Picks - Smart Product Scoring</h2>
      
      <div style="display: grid; gap: 24px;">
        <!-- Stats Row -->
        <div class="actions" id="topPicksStats">
          <div class="stat">
            <div class="stat-label">Eligible Products</div>
            <div class="stat-value" id="tpEligible">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">With Images</div>
            <div class="stat-value" id="tpWithImages">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Missing Images</div>
            <div class="stat-value" id="tpMissingImages">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Quarantined</div>
            <div class="stat-value" id="tpQuarantined">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Total Events</div>
            <div class="stat-value" id="tpTotalEvents">-</div>
          </div>
        </div>
        
        <!-- Controls -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
            <button class="btn" onclick="recalculateScores()" id="recalculateBtn">üîÑ Recalculate Scores</button>
            
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 12px; color: #aaa;">Scope:</label>
              <select id="topPicksScope" style="padding: 8px 12px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;" onchange="loadScoredProducts()">
                <option value="HOME">Homepage</option>
                <option value="DOGS">Dogs</option>
                <option value="CATS">Cats</option>
              </select>
            </div>
            
            <div id="lastRecalculated" style="font-size: 11px; color: #666;"></div>
          </div>
        </div>
        
        <!-- Scored Products Table -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 16px; color: #fff;">Scored Products</h3>
          
          <div id="scoredProductsTable">
            <div class="loading">Loading scored products...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enrich CJ Tab -->
    <div id="enrich" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Enrich Products from CJ</h2>
      <p style="color: #aaa; margin-bottom: 20px; font-size: 13px;">
        Update all products with full CJ product info and ALL images. This job is safe, resumable, and won't break the store.
      </p>
      
      <div style="display: grid; gap: 20px; max-width: 1000px;">
        <!-- Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
          <div class="stat"><div class="stat-label">Total Products</div><div class="stat-value" id="enrichStatTotal">-</div></div>
          <div class="stat"><div class="stat-label">With CJ ID</div><div class="stat-value" id="enrichStatCjId">-</div></div>
          <div class="stat"><div class="stat-label">Enriched</div><div class="stat-value" id="enrichStatSuccess">-</div></div>
          <div class="stat"><div class="stat-label">Failed</div><div class="stat-value" id="enrichStatFailed">-</div></div>
          <div class="stat"><div class="stat-label">Multi-Image</div><div class="stat-value" id="enrichStatMultiImg">-</div></div>
        </div>
        
        <!-- CJ Match Import -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 12px; font-size: 16px; color: #fff;">CJ Match Import</h3>
          <p style="color: #aaa; font-size: 12px; margin-bottom: 16px;">
            Upload a CSV to map your existing products to CJ identifiers (cj_product_id / cj_spu).
            Required columns: product_id or slug + at least one of cj_product_id or cj_spu.
          </p>
          
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 16px;">
            <input type="file" id="cjMatchFile" accept=".csv" style="background: #262643; border: 1px solid #333; border-radius: 4px; padding: 8px; color: #fff;" />
            <button class="btn btn-secondary" onclick="previewCjMatch()">Preview (Dry-Run)</button>
            <button class="btn" onclick="applyCjMatch()">Apply Import</button>
            <button class="btn btn-secondary" onclick="loadCjMatchStats()">Refresh Stats</button>
          </div>
          
          <div id="cjMatchStats" style="font-size: 12px; color: #aaa; margin-bottom: 12px;"></div>
          <div id="cjMatchResult" style="max-height: 300px; overflow-y: auto; font-size: 12px;"></div>
        </div>
        
        <!-- Controls -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Job Controls</h3>
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <button class="btn" onclick="startEnrichJob()" id="enrichRunBtn">‚ñ∂Ô∏è Run Enrichment</button>
            <button class="btn btn-secondary" onclick="startEnrichJob()" id="enrichResumeBtn" disabled style="display:none;">‚èØÔ∏è Resume</button>
            <button class="btn btn-danger" onclick="stopEnrichJob()" id="enrichStopBtn" disabled>‚èπÔ∏è Stop</button>
            <button class="btn btn-secondary" onclick="loadEnrichStatus()">üîÑ Refresh Status</button>
          </div>
          
          <div style="margin-top: 16px; display: flex; gap: 20px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #aaa;">
              <input type="checkbox" id="enrichForce" /> Force re-enrich all
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #aaa;">
              <input type="checkbox" id="enrichOverwrite" /> Overwrite existing fields
            </label>
          </div>
        </div>
        
        <!-- Current Job Progress -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;" id="enrichJobSection">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Current Job</h3>
          <div id="enrichJobInfo">
            <p style="color: #666; font-size: 13px;">No active job. Click "Run Enrichment" to start.</p>
          </div>
        </div>
        
        <!-- Recent Errors -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Recent Errors (last 20)</h3>
          <div id="enrichErrors" style="max-height: 250px; overflow-y: auto;">
            <p style="color: #666; font-size: 13px;">No errors yet.</p>
          </div>
        </div>
        
        <!-- Recent Jobs -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Recent Jobs</h3>
          <div id="enrichRecentJobs">
            <p style="color: #666; font-size: 13px;">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Languages Tab -->
    <div id="languages" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Languages & Translation</h2>
      <p style="color: #aaa; margin-bottom: 20px; font-size: 13px;">
        Translate products to all supported languages (NL, DE, FR, ES). Translations are cached and served automatically to visitors based on their browser language.
      </p>
      
      <div style="display: grid; gap: 20px; max-width: 1000px;">
        <!-- Translation Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
          <div class="stat"><div class="stat-label">Total Products</div><div class="stat-value" id="transStatTotal">-</div></div>
          <div class="stat"><div class="stat-label">Pending</div><div class="stat-value" id="transStatPending">-</div></div>
          <div class="stat"><div class="stat-label">Partial</div><div class="stat-value" id="transStatPartial">-</div></div>
          <div class="stat"><div class="stat-label">Complete</div><div class="stat-value" id="transStatComplete">-</div></div>
        </div>
        
        <!-- Per-language Stats -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Translation Coverage by Language</h3>
          <div id="transLangStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
            <p style="color: #666; font-size: 13px;">Loading...</p>
          </div>
        </div>
        
        <!-- Job Controls -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Translation Job Controls</h3>
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <button class="btn" onclick="startTranslationJob()" id="transRunBtn">‚ñ∂Ô∏è Run Translation</button>
            <button class="btn btn-danger" onclick="stopTranslationJob()" id="transStopBtn" disabled>‚èπÔ∏è Stop</button>
            <button class="btn btn-secondary" onclick="loadTranslationStatus()">üîÑ Refresh Status</button>
          </div>
          
          <div style="margin-top: 16px; display: flex; gap: 20px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #aaa;">
              <input type="checkbox" id="transIncludeSpecs" /> Include specs translation
            </label>
          </div>
        </div>
        
        <!-- Current Job Progress -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;" id="transJobSection">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Current Job</h3>
          <div id="transJobInfo">
            <p style="color: #666; font-size: 13px;">No active job. Click "Run Translation" to start.</p>
          </div>
        </div>
        
        <!-- Image Analysis Section -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Image Text Detection</h3>
          <p style="color: #aaa; font-size: 12px; margin-bottom: 16px;">
            Detect promotional/banner images with German text and reorder gallery to show product photos first.
          </p>
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <button class="btn" onclick="runImageAnalysisBatch()">üîç Analyze All Images</button>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #aaa;">
              <input type="checkbox" id="imageUseOCR" /> Use OCR (slower, more accurate)
            </label>
          </div>
          <div id="imageAnalysisResult" style="margin-top: 12px;"></div>
        </div>
        
        <!-- Recent Jobs -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Recent Translation Jobs</h3>
          <div id="transRecentJobs">
            <p style="color: #666; font-size: 13px;">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Google Analytics 4</h2>
      
      <div style="display: flex; gap: 12px; margin-bottom: 20px;">
        <button class="btn" id="analyticsTabDashboard" onclick="switchAnalyticsSubTab('dashboard')" style="background: #00C4A7;">Dashboard</button>
        <button class="btn btn-secondary" id="analyticsTabEmbed" onclick="switchAnalyticsSubTab('embed')">Looker Studio</button>
      </div>
      
      <!-- Status Panel -->
      <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Tracking Status</h3>
        <div id="analyticsStatus">
          <div class="loading">Loading analytics status...</div>
        </div>
      </div>
      
      <!-- Dashboard Sub-Tab -->
      <div id="analyticsDashboard" style="display: block;">
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">GA4 Data API Dashboard</h3>
          <div id="ga4ApiStatus">
            <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
              To enable the GA4 Data API dashboard, configure these secrets:
            </p>
            <ul style="color: #aaa; font-size: 12px; margin-left: 20px; margin-bottom: 16px;">
              <li><code>GA4_PROPERTY_ID</code> - Your GA4 property ID (numbers only)</li>
              <li><code>GOOGLE_SERVICE_ACCOUNT_JSON</code> - Service account JSON with GA4 read access</li>
              <li><code>GA4_ADMIN_TOKEN</code> - Admin token for API authentication</li>
            </ul>
            <div id="ga4ApiData" style="display: none;">
              <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                <select id="ga4DateRange" onchange="loadGa4Dashboard()" style="padding: 8px 12px; background: #262643; border: 1px solid #3a3a5c; border-radius: 4px; color: #fff;">
                  <option value="7">Last 7 days</option>
                  <option value="28" selected>Last 28 days</option>
                  <option value="90">Last 90 days</option>
                </select>
                <button class="btn btn-secondary" onclick="loadGa4Dashboard()">Refresh</button>
                <button class="btn btn-secondary" onclick="clearGa4Cache()">Clear Cache</button>
              </div>
              
              <div id="ga4Kpis" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;"></div>
              
              <div style="display: grid; gap: 20px;">
                <div style="background: #262643; border-radius: 8px; padding: 16px;">
                  <h4 style="margin-bottom: 12px; font-size: 14px; color: #00C4A7;">Top Pages</h4>
                  <div id="ga4TopPages" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="background: #262643; border-radius: 8px; padding: 16px;">
                  <h4 style="margin-bottom: 12px; font-size: 14px; color: #00C4A7;">Traffic Sources</h4>
                  <div id="ga4Sources" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="background: #262643; border-radius: 8px; padding: 16px;">
                  <h4 style="margin-bottom: 12px; font-size: 14px; color: #00C4A7;">Top Products</h4>
                  <div id="ga4TopProducts" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Embed Sub-Tab -->
      <div id="analyticsEmbed" style="display: none;">
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 20px;">
          <h3 style="margin-bottom: 16px; font-size: 16px; color: #fff;">Looker Studio Report</h3>
          <div id="lookerStudioEmbed">
            <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
              To embed a Looker Studio report, configure the <code>LOOKER_STUDIO_REPORT_URL</code> secret with your report's share URL.
            </p>
            <p style="color: #aaa; font-size: 12px;">
              <strong>Setup instructions:</strong><br>
              1. Create a Looker Studio report connected to your GA4 property<br>
              2. Click Share &gt; Get report link<br>
              3. Copy the URL and add it as the LOOKER_STUDIO_REPORT_URL secret
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pricing & CSV Tab -->
    <div id="pricing" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Pricing Engine & CSV Export/Import</h2>
      
      <div style="display: grid; gap: 24px; max-width: 1200px;">
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
          <div class="stat">
            <div class="stat-label">Pricing Tiers</div>
            <div class="stat-value" style="font-size: 14px;">
              $0-10: x3.0 | $10-30: x2.5 | $30-80: x2.0 | $80-150: x1.8 | $150+: x1.5
            </div>
          </div>
          <div class="stat">
            <div class="stat-label">Psychological Rounding</div>
            <div class="stat-value" style="font-size: 14px;">
              &lt;$100: .99 | $100-250: .95 | $250+: round to 10s
            </div>
          </div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üì•</span> CSV Export
          </h3>
          <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
            Download all products with current prices, costs, and suggested prices based on the pricing engine.
          </p>
          <button class="btn" onclick="downloadPricingCSV()">Download CSV</button>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üì§</span> CSV Import
          </h3>
          <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
            Upload a modified CSV to update prices. Changes are validated before applying.
          </p>
          
          <div style="border: 2px dashed #262643; border-radius: 8px; padding: 30px; text-align: center; margin-bottom: 16px;" id="pricingUploadZone">
            <p style="margin-bottom: 10px;">üìÅ Drag & drop your pricing CSV here</p>
            <p style="margin-bottom: 20px; color: #aaa; font-size: 12px;">or</p>
            <label for="pricingCsvFile" class="btn">Choose File</label>
            <input type="file" id="pricingCsvFile" accept=".csv" style="display: none;" onchange="handlePricingFileSelect(event)" />
          </div>
          
          <div id="pricingFileName" style="display: none; margin-bottom: 16px; color: #00C4A7;"></div>
          
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="previewPricingImport()" id="previewImportBtn" disabled>Preview Changes (Dry-run)</button>
            <button class="btn" onclick="applyPricingImport()" id="applyImportBtn" disabled>Apply Changes</button>
          </div>
        </div>

        <div id="pricingPreview" style="display: none; background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff;">Import Preview</h3>
          <div id="pricingPreviewStats" style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;"></div>
          <div id="pricingPreviewErrors" style="margin-bottom: 16px;"></div>
          <div style="max-height: 400px; overflow-y: auto;">
            <table id="pricingPreviewTable">
              <thead>
                <tr>
                  <th>Product ID</th>
                  <th>Field</th>
                  <th>Old Value</th>
                  <th>New Value</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="background: #0d3a0d; border: 1px solid #1a5c1a; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #4ade80; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üì¶</span> Catalog CSV (Full Product Catalog)
          </h3>
          <p style="color: #86efac; font-size: 13px; margin-bottom: 16px;">
            Export/Import the full product catalog including pet_type, category, tags, images, variants.
            <br><strong>18 Columns:</strong> product_id, slug, title, description, category, sub_category, pet_type, is_pet_product, active, tags, cj_product_id, cj_spu, cost, price, currency, images, variants, updated_at
            <br><em style="color: #fbbf24;">‚ö†Ô∏è Pet-only filtering: Non-pet products are automatically disabled.</em>
          </p>
          
          <div style="margin-bottom: 20px;">
            <button class="btn" onclick="downloadCatalogCSV()" style="background: #22c55e;">‚¨áÔ∏è Download Catalog CSV</button>
            <a href="/api/admin/catalog/schema" target="_blank" style="margin-left: 10px; color: #86efac; font-size: 12px;">View Schema</a>
          </div>
          
          <div style="border: 2px dashed #1a5c1a; border-radius: 8px; padding: 30px; text-align: center; margin-bottom: 16px; background: #0a2f0a;" id="catalogUploadZone">
            <p style="margin-bottom: 10px; color: #4ade80;">üìÅ Drag & drop your CATALOG CSV here</p>
            <p style="margin-bottom: 20px; color: #86efac; font-size: 12px;">or</p>
            <label for="catalogCsvFile" class="btn" style="background: #22c55e;">Choose Catalog File</label>
            <input type="file" id="catalogCsvFile" accept=".csv" style="display: none;" onchange="handleCatalogFileSelect(event)" />
          </div>
          
          <div id="catalogFileName" style="display: none; margin-bottom: 16px; color: #4ade80;"></div>
          
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="previewCatalogImport()" id="previewCatalogBtn" disabled style="border-color: #22c55e; color: #4ade80;">Preview Catalog Changes</button>
            <button class="btn" onclick="applyCatalogImport()" id="applyCatalogBtn" disabled style="background: #22c55e;">Apply Catalog Changes</button>
            <button class="btn" onclick="disableNonPetProducts()" id="disableNonPetBtn" style="background: #ef4444;">üö´ Disable Non-Pet Products</button>
          </div>
          
          <div id="catalogPreview" style="display: none; margin-top: 20px; background: #0a2f0a; border-radius: 8px; padding: 16px;">
            <div id="catalogPreviewStats" style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;"></div>
            <div id="catalogPreviewErrors" style="margin-bottom: 16px;"></div>
            <div id="catalogPreviewChanges" style="max-height: 300px; overflow-y: auto;"></div>
          </div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üîÑ</span> Auto-Reprice
          </h3>
          <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
            Automatically recalculate prices for all products using the pricing engine.
          </p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="previewReprice()">Preview Reprice</button>
            <button class="btn btn-danger" onclick="applyReprice()">Apply Reprice to All</button>
          </div>
          <div id="repricePreview" style="display: none; margin-top: 20px;"></div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üìã</span> Audit Log
          </h3>
          <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
            Recent price changes from CSV imports and auto-reprice operations.
          </p>
          <button class="btn btn-secondary" onclick="loadPricingAudit()">Load Audit Log</button>
          <div id="pricingAuditLog" style="margin-top: 16px; max-height: 300px; overflow-y: auto;"></div>
        </div>

      </div>
    </div>

    <!-- Backups Tab -->
    <div id="backups" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Catalog Backup & Restore</h2>
      
      <div style="display: grid; gap: 24px; max-width: 900px;">
        
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üíæ</span> Create Backup
          </h3>
          <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
            Create a timestamped backup of your current catalog. Backups are automatically created before imports and restores.
          </p>
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button class="btn" onclick="createManualBackup()">Create Backup Now</button>
            <span id="lastBackupTime" style="color: #aaa; font-size: 12px;"></span>
          </div>
          <div id="backupResult" style="margin-top: 10px;"></div>
        </div>

        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üìÇ</span> Available Backups
          </h3>
          <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
            Select a backup to restore. Maximum 20 backups are kept (oldest are automatically removed).
          </p>
          <button class="btn btn-secondary" onclick="loadBackups()" style="margin-bottom: 16px;">Refresh List</button>
          <div id="backupsList" style="max-height: 400px; overflow-y: auto;">
            <div class="loading">Loading backups...</div>
          </div>
        </div>

      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #00C4A7;">Settings & Go-Live Checklist</h2>
      
      <div style="display: grid; gap: 24px; max-width: 900px;">
        
        <!-- Go-Live Checklist -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üöÄ</span> Go-Live Checklist
          </h3>
          <div id="goLiveChecklist" style="display: grid; gap: 12px;">
            <div class="loading">Checking configuration...</div>
          </div>
          <div id="goLiveProgress" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #262643;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="font-size: 13px; color: #aaa;">Readiness</span>
              <span id="goLivePercent" style="font-size: 13px; font-weight: 600; color: #00C4A7;">0%</span>
            </div>
            <div style="height: 8px; background: #262643; border-radius: 4px; overflow: hidden;">
              <div id="goLiveBar" style="height: 100%; background: #00C4A7; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>
        </div>

        <!-- Payment Settings -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üí≥</span> Payment Settings (Stripe)
          </h3>
          <div id="stripeSettings">
            <div class="loading">Loading Stripe status...</div>
          </div>
        </div>

        <!-- CJ Dropshipping Settings -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üì¶</span> CJ Dropshipping
          </h3>
          <div id="cjSettings">
            <div class="loading">Loading CJ status...</div>
          </div>
        </div>

        <!-- Email Settings -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üìß</span> Email Notifications
          </h3>
          <div id="emailSettings">
            <div class="loading">Loading email status...</div>
          </div>
        </div>

        <!-- OpenAI Settings -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">ü§ñ</span> AI Assistant (OpenAI)
          </h3>
          <div id="openaiSettings">
            <div class="loading">Loading AI status...</div>
          </div>
        </div>

        <!-- Analytics Settings -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üìä</span> Analytics & Tracking
          </h3>
          <div id="analyticsSettings">
            <div class="loading">Loading analytics status...</div>
          </div>
        </div>

        <!-- System Tools -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üîß</span> System Tools
          </h3>
          <p style="font-size: 12px; color: #aaa; margin-bottom: 16px;">
            Maintenance tools for product data migration and AI search reindexing.
          </p>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn" onclick="runMigration()" id="migrateBtn">
              üîÑ Migrate Products
            </button>
            <button class="btn" onclick="runReindex()" id="reindexBtn">
              üß† Rebuild AI Index
            </button>
            <button class="btn" onclick="forceClientRefresh()" style="background: #e67e22;">
              üîÑ Force Client Refresh
            </button>
          </div>
          <div id="systemToolsResult" style="margin-top: 16px;"></div>
        </div>
        
        <!-- Build Info -->
        <div style="background: #1a1a2e; border: 1px solid #262643; border-radius: 8px; padding: 24px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #fff; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üì¶</span> Build Information
          </h3>
          <div id="buildInfo">
            <div class="loading">Loading build info...</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Product Drawer -->
  <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
  <div class="drawer" id="productDrawer">
    <div class="drawer-header">
      <h2>Product Details</h2>
      <button class="drawer-close" onclick="closeDrawer()">&times;</button>
    </div>
    <div class="drawer-body" id="drawerBody">
      <!-- Dynamic content -->
    </div>
  </div>

  <script>
    let progressInterval = null;
    let currentPage = 1;
    let selectedProducts = new Set();
    let currentProducts = [];

    let isAuthenticated = false;
    let authCheckDone = false;
    let authCheckPromise = null;
    let pendingRetryCallback = null;
    
    function showLoginModal(retryCallback = null) {
      pendingRetryCallback = retryCallback;
      const modal = document.getElementById('loginModal');
      modal.style.display = 'flex';
      document.getElementById('loginTokenInput').focus();
      document.getElementById('loginError').style.display = 'none';
    }
    
    function hideLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('loginTokenInput').value = '';
      document.getElementById('loginError').style.display = 'none';
    }
    
    async function submitLogin() {
      const token = document.getElementById('loginTokenInput').value.trim();
      const errorEl = document.getElementById('loginError');
      
      if (!token) {
        errorEl.textContent = 'Please enter the admin token';
        errorEl.style.display = 'block';
        return;
      }
      
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token }),
          credentials: 'include'
        });
        const data = await res.json();
        
        if (!res.ok || !data.ok) {
          errorEl.textContent = data.error === 'UNAUTHORIZED_ADMIN' ? 'Invalid token' : (data.error || 'Login failed');
          errorEl.style.display = 'block';
          return;
        }
        
        isAuthenticated = true;
        hideLoginModal();
        updateAuthStatusUI();
        showToast('Logged in successfully');
        
        if (pendingRetryCallback) {
          pendingRetryCallback();
          pendingRetryCallback = null;
        } else {
          loadOverview();
          loadInboxMessages();
          loadAdminReviews();
        }
      } catch (err) {
        errorEl.textContent = 'Login failed: ' + err.message;
        errorEl.style.display = 'block';
      }
    }
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.getElementById('loginModal').style.display === 'flex') {
        submitLogin();
      }
    });
    
    async function apiFetch(endpoint, options = {}) {
      if (!authCheckDone) {
        await ensureAuthChecked();
      }
      if (!isAuthenticated) {
        return new Promise((resolve, reject) => {
          showLoginModal(() => {
            apiFetch(endpoint, options).then(resolve).catch(reject);
          });
        });
      }
      const res = await fetch(endpoint, {
        ...options,
        credentials: "include"
      });
      if (res.status === 401) {
        console.log('[AdminAuth] 401 received for:', endpoint);
        isAuthenticated = false;
        return new Promise((resolve, reject) => {
          showLoginModal(() => {
            apiFetch(endpoint, options).then(resolve).catch(reject);
          });
        });
      }
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: res.statusText }));
        throw new Error(err.error || res.statusText);
      }
      return res.json();
    }
    
    async function ensureAuthChecked() {
      if (authCheckPromise) return authCheckPromise;
      authCheckPromise = (async () => {
        if (authCheckDone) return isAuthenticated;
        authCheckDone = true;
        console.log('[AdminAuth] Checking session via /api/admin/ping...');
        try {
          const res = await fetch('/api/admin/ping', { credentials: 'include' });
          const data = await res.json();
          isAuthenticated = data.ok === true && data.authenticated === true;
          console.log('[AdminAuth] Ping result:', isAuthenticated, data.method || 'none');
          return isAuthenticated;
        } catch (err) {
          console.log('[AdminAuth] Ping failed:', err.message);
          isAuthenticated = false;
          return false;
        }
      })();
      return authCheckPromise;
    }
    
    async function initAdmin() {
      const authenticated = await ensureAuthChecked();
      if (!authenticated) {
        showLoginModal();
        return;
      }
      console.log('[AdminAuth] Authenticated, loading admin data...');
      updateAuthStatusUI();
      loadOverview();
      loadInboxMessages();
      loadAdminReviews();
    }

    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    function updateAuthStatusUI() {
      const statusEl = document.getElementById('authStatusIndicator');
      if (statusEl) {
        statusEl.innerHTML = isAuthenticated 
          ? '<span style="color: #00C4A7;">Logged in</span>'
          : '<span style="color: #ff6b6b;">Not logged in</span>';
      }
    }
    
    function getAdminHeaders() {
      return {};
    }

    async function logout() {
      try {
        await fetch("/api/admin/logout", { method: "POST", credentials: "include" });
      } catch (e) {}
      isAuthenticated = false;
      updateAuthStatusUI();
      showLoginModal();
    }

    function switchTab(name) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
      document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
      document.getElementById(name).classList.add("active");
      document.querySelector(`[onclick="switchTab('${name}')"]`).classList.add("active");

      if (name === "products") loadProducts();
      else if (name === "rejected") loadRejected();
      else if (name === "orders") loadOrders();
      else if (name === "sync") loadSync();
      else if (name === "logs") loadLogs();
      else if (name === "overview") loadOverview();
      else if (name === "import") checkImportProgress();
      else if (name === "cjimport") loadCJImportStatus();
      else if (name === "settings") loadSettings();
      else if (name === "analytics") loadAnalytics();
      else if (name === "enrich") { loadEnrichStatus(); loadCjMatchStats(); }
      else if (name === "backups") loadBackups();
    }
    
    function switchAnalyticsSubTab(tab) {
      document.getElementById('analyticsDashboard').style.display = tab === 'dashboard' ? 'block' : 'none';
      document.getElementById('analyticsEmbed').style.display = tab === 'embed' ? 'block' : 'none';
      document.getElementById('analyticsTabDashboard').className = tab === 'dashboard' ? 'btn' : 'btn btn-secondary';
      document.getElementById('analyticsTabEmbed').className = tab === 'embed' ? 'btn' : 'btn btn-secondary';
      if (tab === 'dashboard') loadGa4Dashboard();
    }
    
    async function loadAnalytics() {
      try {
        const config = await apiFetch('/api/admin/analytics/config');
        const statusEl = document.getElementById('analyticsStatus');
        
        statusEl.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div style="background: #262643; padding: 12px; border-radius: 6px;">
              <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">Tracking Status</div>
              <div style="font-size: 14px; font-weight: 600; color: ${config.trackingEnabled ? '#00C4A7' : '#ff6b6b'};">
                ${config.trackingEnabled ? '‚úÖ Enabled' : '‚ùå Disabled'}
              </div>
            </div>
            <div style="background: #262643; padding: 12px; border-radius: 6px;">
              <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">Measurement ID</div>
              <div style="font-size: 14px; font-weight: 600; color: #fff;">${config.measurementId}</div>
            </div>
            <div style="background: #262643; padding: 12px; border-radius: 6px;">
              <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">Environment</div>
              <div style="font-size: 14px; font-weight: 600; color: #fff;">${config.environment}</div>
            </div>
            <div style="background: #262643; padding: 12px; border-radius: 6px;">
              <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">Debug Mode</div>
              <div style="font-size: 14px; font-weight: 600; color: ${config.debug ? '#ffa500' : '#aaa'};">
                ${config.debug ? 'üêõ On' : 'Off'}
              </div>
            </div>
          </div>
          <div style="margin-top: 16px;">
            <a href="https://analytics.google.com/" target="_blank" class="btn btn-secondary" style="text-decoration: none;">Open Google Analytics</a>
          </div>
        `;
        
        if (config.apiEnabled) {
          document.getElementById('ga4ApiData').style.display = 'block';
          loadGa4Dashboard();
        } else {
          document.getElementById('ga4ApiData').style.display = 'none';
          const missingHtml = config.apiMissing.map(m => `<li style="color: #ff6b6b;">${m} - not configured</li>`).join('');
          document.getElementById('ga4ApiStatus').innerHTML = `
            <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">
              GA4 Data API dashboard is disabled. Missing secrets:
            </p>
            <ul style="margin-left: 20px; margin-bottom: 16px;">${missingHtml}</ul>
          `;
        }
        
        if (config.lookerStudioUrl) {
          const lookerEl = document.getElementById('lookerStudioEmbed');
          lookerEl.innerHTML = `
            <iframe 
              src="${config.lookerStudioUrl}" 
              style="width: 100%; min-height: 700px; border: none; border-radius: 8px;"
              allowfullscreen
            ></iframe>
          `;
        }
        
      } catch (err) {
        document.getElementById('analyticsStatus').innerHTML = `<div class="error-msg">Failed to load analytics config: ${err.message}</div>`;
      }
    }
    
    let ga4AdminToken = '';
    
    async function loadGa4Dashboard() {
      if (!ga4AdminToken) {
        ga4AdminToken = prompt('Enter GA4 Admin Token:');
        if (!ga4AdminToken) return;
      }
      
      const days = document.getElementById('ga4DateRange').value;
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      
      try {
        const headers = { 'x-admin-token': ga4AdminToken };
        
        const [summary, topPages, sources, topProducts] = await Promise.all([
          fetch(`/api/admin/analytics/summary?start=${startDate}&end=${endDate}`, { headers }).then(r => r.json()),
          fetch(`/api/admin/analytics/top-pages?start=${startDate}&end=${endDate}&limit=10`, { headers }).then(r => r.json()),
          fetch(`/api/admin/analytics/sources?start=${startDate}&end=${endDate}&limit=10`, { headers }).then(r => r.json()),
          fetch(`/api/admin/analytics/top-products?start=${startDate}&end=${endDate}&limit=10`, { headers }).then(r => r.json())
        ]);
        
        if (summary.ok === false) {
          throw new Error(summary.error || summary.hint || 'API request failed');
        }
        if (topPages.ok === false || sources.ok === false || topProducts.ok === false) {
          console.warn('Some analytics data unavailable');
        }
        
        const kpisEl = document.getElementById('ga4Kpis');
        const metrics = summary.metrics || {};
        kpisEl.innerHTML = `
          <div style="background: #262643; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #00C4A7;">${(metrics.activeUsers || 0).toLocaleString()}</div>
            <div style="font-size: 12px; color: #aaa;">Active Users</div>
          </div>
          <div style="background: #262643; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #00C4A7;">${(metrics.sessions || 0).toLocaleString()}</div>
            <div style="font-size: 12px; color: #aaa;">Sessions</div>
          </div>
          <div style="background: #262643; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #00C4A7;">${(metrics.screenPageViews || 0).toLocaleString()}</div>
            <div style="font-size: 12px; color: #aaa;">Page Views</div>
          </div>
          ${metrics.ecommercePurchases ? `
          <div style="background: #262643; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #00C4A7;">${(metrics.ecommercePurchases || 0).toLocaleString()}</div>
            <div style="font-size: 12px; color: #aaa;">Purchases</div>
          </div>
          ` : ''}
          ${metrics.totalRevenue ? `
          <div style="background: #262643; padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #00C4A7;">$${(metrics.totalRevenue || 0).toFixed(2)}</div>
            <div style="font-size: 12px; color: #aaa;">Revenue</div>
          </div>
          ` : ''}
        `;
        
        const topPagesEl = document.getElementById('ga4TopPages');
        if (topPages.data && topPages.data.length > 0) {
          topPagesEl.innerHTML = topPages.data.map(p => `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #3a3a5c; font-size: 12px;">
              <span style="color: #fff; max-width: 60%; overflow: hidden; text-overflow: ellipsis;">${p.pagePath}</span>
              <span style="color: #00C4A7;">${(p.screenPageViews || 0).toLocaleString()} views</span>
            </div>
          `).join('');
        } else {
          topPagesEl.innerHTML = '<p style="color: #666; font-size: 12px;">No data available</p>';
        }
        
        const sourcesEl = document.getElementById('ga4Sources');
        if (sources.data && sources.data.length > 0) {
          sourcesEl.innerHTML = sources.data.map(s => `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #3a3a5c; font-size: 12px;">
              <span style="color: #fff;">${s.sessionSource || 'direct'} / ${s.sessionMedium || 'none'}</span>
              <span style="color: #00C4A7;">${(s.sessions || 0).toLocaleString()} sessions</span>
            </div>
          `).join('');
        } else {
          sourcesEl.innerHTML = '<p style="color: #666; font-size: 12px;">No data available</p>';
        }
        
        const topProductsEl = document.getElementById('ga4TopProducts');
        if (topProducts.data && topProducts.data.length > 0) {
          topProductsEl.innerHTML = topProducts.data.map(p => `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #3a3a5c; font-size: 12px;">
              <span style="color: #fff; max-width: 60%; overflow: hidden; text-overflow: ellipsis;">${p.itemName || p.itemId}</span>
              <span style="color: #00C4A7;">${(p.itemsViewed || 0).toLocaleString()} views</span>
            </div>
          `).join('');
        } else {
          topProductsEl.innerHTML = '<p style="color: #666; font-size: 12px;">No e-commerce data available</p>';
        }
        
      } catch (err) {
        if (err.message.includes('401') || err.message.includes('token')) {
          ga4AdminToken = '';
        }
        document.getElementById('ga4Kpis').innerHTML = `<div class="error-msg" style="grid-column: 1/-1;">Error: ${err.message}</div>`;
      }
    }
    
    async function clearGa4Cache() {
      if (!ga4AdminToken) return;
      try {
        const res = await fetch('/api/admin/analytics/cache/clear', {
          method: 'POST',
          headers: { 'x-admin-token': ga4AdminToken }
        });
        const data = await res.json();
        if (data.ok) {
          showToast('Cache cleared successfully');
          loadGa4Dashboard();
        } else {
          showToast(data.error || 'Failed to clear cache', 'error');
        }
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function loadOverview() {
      try {
        const [products, orders, status] = await Promise.all([
          apiFetch("/api/admin/products?pageSize=1000"),
          apiFetch("/api/admin/orders"),
          apiFetch("/api/admin/sync-status")
        ]);

        const activeCount = products.items ? products.items.filter(p => p.active !== false).length : 0;
        const usProducts = products.items ? products.items.filter(p => p.is_us).length : 0;

        const html = `
          <div class="stat">
            <div class="stat-label">Total Products</div>
            <div class="stat-value">${products.total || 0}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Active Products</div>
            <div class="stat-value">${activeCount}</div>
          </div>
          <div class="stat">
            <div class="stat-label">US Warehouse</div>
            <div class="stat-value">${usProducts}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Total Orders</div>
            <div class="stat-value">$${(orders.reduce((a, o) => a + (o.amount_total || 0), 0) / 100).toFixed(2)}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Last Sync</div>
            <div class="stat-value">${status.last_sync_time ? new Date(status.last_sync_time).toLocaleDateString() : "Never"}</div>
          </div>
        `;
        document.getElementById("stats").innerHTML = html;
      } catch (err) {
        document.getElementById("stats").innerHTML = `<div class="error-msg">${err.message}</div>`;
      }
    }

    async function loadProducts() {
      const query = document.getElementById("productSearch").value;
      const source = document.getElementById("filterSource").value;
      const status = document.getElementById("filterStatus").value;
      const petType = document.getElementById("filterPetType").value;
      const pageSize = document.getElementById("pageSize").value;

      try {
        const params = new URLSearchParams({
          query, source, status, petType, page: currentPage, pageSize
        });
        const data = await apiFetch(`/api/admin/products?${params}`);
        currentProducts = data.items || [];
        
        let tableHtml = `
          <table>
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()" /></th>
                <th>Image</th>
                <th>Title</th>
                <th>Price</th>
                <th>Variants</th>
                <th>Source</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        for (const p of currentProducts) {
          const isDeleted = !!p.deletedAt;
          const isActive = p.active !== false && !isDeleted;
          const statusClass = isDeleted ? "status-deleted" : (isActive ? "status-active" : "status-inactive");
          const statusText = isDeleted ? "Deleted" : (isActive ? "Active" : "Inactive");
          const rowClass = isDeleted ? "deleted" : "";
          const price = p.variants && p.variants.length > 0 ? p.variants[0].price : (p.price || 0);
          const imgSrc = p.image && !p.image.includes("placeholder") ? p.image : "/placeholder.png";
          const checked = selectedProducts.has(p.id) ? "checked" : "";

          tableHtml += `
            <tr class="${rowClass}">
              <td><input type="checkbox" ${checked} onchange="toggleSelect('${p.id}')" /></td>
              <td><img src="${escapeHtml(imgSrc)}" class="product-thumb" loading="lazy" onerror="this.src='/placeholder.png'" /></td>
              <td><span class="product-title" onclick="openDrawer('${p.id}')">${escapeHtml(p.title || "Untitled")}</span></td>
              <td>$${price.toFixed(2)}</td>
              <td>${(p.variants || []).length}</td>
              <td>${escapeHtml(p.source || "‚Äì")}</td>
              <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td>
                ${isDeleted 
                  ? `<button class="btn btn-sm" onclick="restoreProduct('${p.id}')">Restore</button>`
                  : `
                    ${isActive 
                      ? `<button class="btn btn-sm btn-secondary" onclick="disableProduct('${p.id}')">Disable</button>`
                      : `<button class="btn btn-sm" onclick="enableProduct('${p.id}')">Enable</button>`
                    }
                    <button class="btn btn-sm" onclick="refreshProductImages('${p.id}')" title="Refresh images from CJ" style="background: #6b5bff; color: #fff;">üì∑</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">Delete</button>
                  `
                }
              </td>
            </tr>
          `;
        }

        tableHtml += `</tbody></table>`;
        document.getElementById("productsTable").innerHTML = tableHtml;

        // Pagination
        const totalPages = data.totalPages || 1;
        let paginationHtml = `
          <div class="pagination-info">
            Showing ${(currentPage - 1) * parseInt(pageSize) + 1}‚Äì${Math.min(currentPage * parseInt(pageSize), data.total)} of ${data.total} products
          </div>
          <div class="pagination-btns">
            <button class="btn btn-sm btn-secondary" onclick="goToPage(1)" ${currentPage === 1 ? "disabled" : ""}>First</button>
            <button class="btn btn-sm btn-secondary" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? "disabled" : ""}>Prev</button>
            <span style="padding: 0 10px; color: #aaa;">Page ${currentPage} of ${totalPages}</span>
            <button class="btn btn-sm btn-secondary" onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages ? "disabled" : ""}>Next</button>
            <button class="btn btn-sm btn-secondary" onclick="goToPage(${totalPages})" ${currentPage >= totalPages ? "disabled" : ""}>Last</button>
          </div>
        `;
        document.getElementById("pagination").innerHTML = paginationHtml;

        updateBulkActions();
      } catch (err) {
        document.getElementById("productsTable").innerHTML = `<div class="error-msg">${err.message}</div>`;
      }
    }

    function goToPage(page) {
      currentPage = page;
      loadProducts();
    }

    function toggleSelect(id) {
      if (selectedProducts.has(id)) {
        selectedProducts.delete(id);
      } else {
        selectedProducts.add(id);
      }
      updateBulkActions();
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById("selectAll");
      if (selectAll.checked) {
        currentProducts.forEach(p => selectedProducts.add(p.id));
      } else {
        currentProducts.forEach(p => selectedProducts.delete(p.id));
      }
      loadProducts();
    }

    function clearSelection() {
      selectedProducts.clear();
      loadProducts();
    }

    function updateBulkActions() {
      const bulkActions = document.getElementById("bulkActions");
      const count = selectedProducts.size;
      document.getElementById("selectedCount").textContent = count;
      bulkActions.classList.toggle("hidden", count === 0);
    }

    async function enableProduct(id) {
      try {
        await apiFetch(`/api/admin/products/${id}/enable`, { method: "POST" });
        showToast("Product enabled");
        loadProducts();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function disableProduct(id) {
      if (!confirm("Disable this product? It won't appear in the shop.")) return;
      try {
        await apiFetch(`/api/admin/products/${id}/disable`, { method: "POST" });
        showToast("Product disabled");
        loadProducts();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function deleteProduct(id) {
      if (!confirm("Delete this product? You can restore it later.")) return;
      try {
        await apiFetch(`/api/admin/products/${id}/delete`, { method: "POST" });
        showToast("Product deleted");
        loadProducts();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function restoreProduct(id) {
      try {
        await apiFetch(`/api/admin/products/${id}/restore`, { method: "POST" });
        showToast("Product restored");
        loadProducts();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function bulkEnable() {
      if (selectedProducts.size === 0) return;
      try {
        await apiFetch("/api/admin/products/bulk/enable", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids: Array.from(selectedProducts) })
        });
        showToast(`${selectedProducts.size} products enabled`);
        selectedProducts.clear();
        loadProducts();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function bulkDisable() {
      if (selectedProducts.size === 0) return;
      if (!confirm(`Disable ${selectedProducts.size} products?`)) return;
      try {
        await apiFetch("/api/admin/products/bulk/disable", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids: Array.from(selectedProducts) })
        });
        showToast(`${selectedProducts.size} products disabled`);
        selectedProducts.clear();
        loadProducts();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function refreshProductImages(id) {
      if (!confirm("Refresh images from CJ? This will re-download all product images.")) return;
      showToast("Refreshing images...", "info");
      try {
        const res = await apiFetch(`/api/admin/products/${id}/refresh-images`, {
          method: "POST"
        });
        if (res.ok) {
          showToast(`Images refreshed: ${res.imageCount} images downloaded`);
          loadProducts();
        } else {
          showToast(res.error || "Failed to refresh images", "error");
        }
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function bulkRefreshImages() {
      if (selectedProducts.size === 0) return;
      if (!confirm(`Refresh images for ${selectedProducts.size} products? This may take a while.`)) return;
      showToast("Refreshing images for selected products...", "info");
      try {
        const res = await apiFetch("/api/admin/products/bulk/refresh-images", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productIds: Array.from(selectedProducts) })
        });
        showToast(`Done: ${res.success?.length || 0} success, ${res.failed?.length || 0} failed`);
        selectedProducts.clear();
        loadProducts();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function bulkDelete() {
      if (selectedProducts.size === 0) return;
      if (!confirm(`Delete ${selectedProducts.size} products? They can be restored later.`)) return;
      try {
        await apiFetch("/api/admin/products/bulk/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids: Array.from(selectedProducts) })
        });
        showToast(`${selectedProducts.size} products deleted`);
        selectedProducts.clear();
        loadProducts();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    function openDrawer(id) {
      const product = currentProducts.find(p => p.id === id);
      if (!product) return;

      const isDeleted = !!product.deletedAt;
      const isActive = product.active !== false && !isDeleted;
      const statusClass = isDeleted ? "status-deleted" : (isActive ? "status-active" : "status-inactive");
      const statusText = isDeleted ? "Deleted" : (isActive ? "Active" : "Inactive");
      const imgSrc = product.image && !product.image.includes("placeholder") ? product.image : "/placeholder.png";
      const price = product.variants && product.variants.length > 0 ? product.variants[0].price : (product.price || 0);

      let variantsHtml = "";
      if (product.variants && product.variants.length > 0) {
        variantsHtml = product.variants.map(v => {
          const opts = v.options ? Object.entries(v.options).map(([k, val]) => `${k}: ${val}`).join(", ") : "";
          return `<div class="drawer-variant"><strong>${v.sku}</strong> - $${v.price.toFixed(2)} ${opts ? `(${opts})` : ""}</div>`;
        }).join("");
      } else {
        variantsHtml = "<div class='drawer-variant' style='color:#aaa;'>No variants</div>";
      }

      const html = `
        <img src="${escapeHtml(imgSrc)}" class="drawer-image" onerror="this.src='/placeholder.png'" />
        
        <div class="drawer-field">
          <label>Title</label>
          <div class="drawer-field-value">${escapeHtml(product.title || "Untitled")}</div>
        </div>
        
        <div class="drawer-field">
          <label>ID / SPU</label>
          <div class="drawer-field-value" style="font-family: monospace; font-size: 11px;">${escapeHtml(product.id)}<br/>${product.spu ? escapeHtml(product.spu) : "‚Äì"}</div>
        </div>
        
        <div class="drawer-field">
          <label>Price</label>
          <div class="drawer-field-value">$${price.toFixed(2)}</div>
        </div>
        
        <div class="drawer-field">
          <label>Source</label>
          <div class="drawer-field-value">${escapeHtml(product.source || "Unknown")}</div>
        </div>
        
        <div class="drawer-field">
          <label>Status</label>
          <div class="drawer-field-value"><span class="status-badge ${statusClass}">${statusText}</span></div>
        </div>
        
        <div class="drawer-field">
          <label>Variants (${product.variants ? product.variants.length : 0})</label>
          <div class="drawer-variants">${variantsHtml}</div>
        </div>
        
        <div class="drawer-field">
          <label>Description</label>
          <div class="drawer-field-value" style="font-size: 12px; max-height: 100px; overflow-y: auto;">${escapeHtml(product.description || "No description")}</div>
        </div>
        
        <div class="drawer-actions">
          ${isDeleted 
            ? `<button class="btn" onclick="restoreProduct('${product.id}'); closeDrawer();">Restore</button>`
            : `
              ${isActive 
                ? `<button class="btn btn-secondary" onclick="disableProduct('${product.id}'); closeDrawer();">Disable</button>`
                : `<button class="btn" onclick="enableProduct('${product.id}'); closeDrawer();">Enable</button>`
              }
              <button class="btn btn-danger" onclick="deleteProduct('${product.id}'); closeDrawer();">Delete</button>
            `
          }
        </div>
      `;

      document.getElementById("drawerBody").innerHTML = html;
      document.getElementById("drawerOverlay").classList.add("active");
      document.getElementById("productDrawer").classList.add("active");
    }

    function closeDrawer() {
      document.getElementById("drawerOverlay").classList.remove("active");
      document.getElementById("productDrawer").classList.remove("active");
    }

    async function loadOrders() {
      try {
        const data = await apiFetch("/api/admin/orders");
        const html = data.length === 0
          ? "<p style='text-align:center; padding:20px;'>No orders yet</p>"
          : `
          <table>
            <tr>
              <th>Session ID</th>
              <th>Amount</th>
              <th>Currency</th>
              <th>Payment</th>
              <th>Fulfillment</th>
              <th>Action</th>
            </tr>
            ${data.map(o => `
              <tr>
                <td style="font-family:monospace; font-size:11px;">${o.session_id.substring(0, 20)}...</td>
                <td>$${(o.amount_total / 100).toFixed(2)}</td>
                <td>${o.currency.toUpperCase()}</td>
                <td class="status-ok">${o.payment_status}</td>
                <td class="${o.fulfillment_status === 'pending' ? 'status-error' : 'status-ok'}">${o.fulfillment_status || 'pending'}</td>
                <td>${o.fulfillment_status === 'pending' ? `<button class="btn btn-sm" onclick="exportToCJ('${o.session_id}')">Export to CJ</button>` : '‚Äì'}</td>
              </tr>
            `).join("")}
          </table>
        `;
        document.getElementById("orders").innerHTML = html;
      } catch (err) {
        document.getElementById("orders").innerHTML = `<div class="error-msg">${err.message}</div>`;
      }
    }

    async function loadSync() {
      try {
        const data = await apiFetch("/api/admin/sync-status");
        const html = `
          <table>
            <tr><td>Last Sync Time</td><td>${data.last_sync_time ? new Date(data.last_sync_time).toLocaleString() : "Never"}</td></tr>
            <tr><td>Last Mode</td><td>${data.last_sync_mode || "‚Äì"}</td></tr>
            <tr><td>Last Count</td><td>${data.last_sync_count} products</td></tr>
            <tr><td>Auto-Sync</td><td class="${data.auto_sync_enabled ? 'status-ok' : 'status-error'}">${data.auto_sync_enabled ? "Enabled" : "Disabled"}</td></tr>
          </table>
        `;
        document.getElementById("sync").innerHTML = html;
      } catch (err) {
        document.getElementById("sync").innerHTML = `<div class="error-msg">${err.message}</div>`;
      }
    }

    async function loadLogs() {
      try {
        const data = await apiFetch("/api/admin/logs");
        const html = `<div class="logs">${data.map(line => 
          `<div class="log-line ${line.includes("ERROR") || line.includes("failed") ? 'log-error' : ''}">${escapeHtml(line)}</div>`
        ).join("")}</div>`;
        document.getElementById("logs").innerHTML = html;
      } catch (err) {
        document.getElementById("logs").innerHTML = `<div class="error-msg">${err.message}</div>`;
      }
    }

    const uploadZone = document.getElementById("uploadZone");
    const csvFile = document.getElementById("csvFile");

    uploadZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadZone.classList.add("dragover");
    });

    uploadZone.addEventListener("dragleave", () => {
      uploadZone.classList.remove("dragover");
    });

    uploadZone.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadZone.classList.remove("dragover");
      const files = e.dataTransfer.files;
      if (files.length > 0) handleFile(files[0]);
    });

    csvFile.addEventListener("change", () => {
      if (csvFile.files.length > 0) handleFile(csvFile.files[0]);
    });

    async function handleFile(file) {
      if (!file.name.endsWith(".csv")) {
        alert("Please upload a CSV file");
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        const csvText = e.target.result;
        await startImport(csvText);
      };
      reader.readAsText(file);
    }

    async function startImport(csvText) {
      document.getElementById("importProgress").style.display = "block";
      document.getElementById("importComplete").style.display = "none";
      document.getElementById("importErrors").style.display = "none";
      document.getElementById("progressPhase").textContent = "Starting import...";
      document.getElementById("progressBar").style.width = "5%";

      try {
        const res = await fetch("/api/import/cj-csv-robust", {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: csvText
        });

        const data = await res.json();
        
        if (!res.ok) {
          document.getElementById("progressPhase").textContent = `Error: ${data.error}`;
          return;
        }

        progressInterval = setInterval(checkImportProgress, 1000);

      } catch (err) {
        document.getElementById("progressPhase").textContent = `Error: ${err.message}`;
      }
    }

    async function checkImportProgress() {
      try {
        const res = await fetch("/api/import/cj-csv/progress");
        const p = await res.json();

        document.getElementById("statRows").textContent = p.totalRows || 0;
        document.getElementById("statProducts").textContent = p.parsedProducts || 0;
        document.getElementById("statImagesCached").textContent = p.imagesCached || 0;
        document.getElementById("statImagesFailed").textContent = p.imagesFailed || 0;

        document.getElementById("progressPhase").textContent = p.phase || p.status;

        let progress = 0;
        if (p.status === "parsing") progress = 10;
        else if (p.status === "processing") {
          if (p.imagesTotal > 0) {
            progress = 20 + Math.round((p.imagesCached + p.imagesFailed) / p.imagesTotal * 70);
          } else {
            progress = 50;
          }
        } else if (p.status === "complete") {
          progress = 100;
        }
        document.getElementById("progressBar").style.width = progress + "%";

        if (p.errors && p.errors.length > 0) {
          document.getElementById("importErrors").style.display = "block";
          document.getElementById("errorList").innerHTML = p.errors.slice(0, 20).map(e =>
            `<div class="error-item">${escapeHtml(e)}</div>`
          ).join("");
        }

        if (p.status === "complete") {
          clearInterval(progressInterval);
          progressInterval = null;
          document.getElementById("importComplete").style.display = "block";
          document.getElementById("importSummary").textContent = 
            `Imported ${p.productsImported} products with ${p.imagesCached} cached images. ${p.imagesFailed} images failed.`;
          loadProducts();
          loadOverview();
        } else if (p.status === "error") {
          clearInterval(progressInterval);
          progressInterval = null;
          document.getElementById("progressPhase").textContent = "Import failed: " + (p.errors[0] || "Unknown error");
        }

      } catch (err) {
        console.error("Progress check error:", err);
      }
    }

    async function placePendingOrders() {
      if (!confirm("Place all pending orders with CJ Dropshipping?")) return;
      try {
        const res = await fetch("/api/admin/cj/place-pending", {
          method: "POST",
          credentials: "include"
        });
        const data = await res.json();
        showToast(`Placed ${data.placed || 0} orders. Failed: ${data.failed || 0}`);
        loadOrders();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function clearCache() {
      if (!confirm("Clear image cache? This will remove all cached product images.")) return;
      try {
        const res = await fetch("/api/admin/clear-cache", {
          method: "POST",
          credentials: "include"
        });
        const data = await res.json();
        showToast(`Cleared ${data.removed} cached images`);
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    function escapeHtml(s) {
      return String(s||"").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    }

    // Rejected Products Tab Functions
    let rejectedPage = 1;
    let selectedRejected = new Set();
    let currentRejected = [];

    async function loadRejected() {
      const query = document.getElementById("rejectedSearch")?.value || "";
      
      try {
        // Load stats
        const stats = await apiFetch("/api/admin/rejected/stats");
        document.getElementById("rejectedCount").textContent = stats.rejectedCount || 0;
        document.getElementById("activeCount").textContent = stats.activeCount || 0;
        
        // Load rejected products
        const params = new URLSearchParams({ query, page: rejectedPage, pageSize: 25 });
        const data = await apiFetch(`/api/admin/rejected?${params}`);
        currentRejected = data.items || [];
        
        let tableHtml = `
          <table>
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllRejected" onclick="toggleSelectAllRejected()" /></th>
                <th>Image</th>
                <th>Title</th>
                <th>Reject Reasons</th>
                <th>Rejected At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        for (const p of currentRejected) {
          const imgSrc = p.image && !p.image.includes("placeholder") ? p.image : "/placeholder.png";
          const reasons = (p.rejectReasons || []).slice(0, 2).join(", ") || "Unknown";
          const rejectedAt = p.rejectedAt ? new Date(p.rejectedAt).toLocaleDateString() : "-";
          const checked = selectedRejected.has(p.id) ? "checked" : "";

          tableHtml += `
            <tr>
              <td><input type="checkbox" ${checked} onchange="toggleRejectedSelect('${p.id}')" /></td>
              <td><img src="${escapeHtml(imgSrc)}" class="product-thumb" loading="lazy" onerror="this.src='/placeholder.png'" /></td>
              <td><span class="product-title" onclick="openDrawer('${p.id}')">${escapeHtml(p.title || "Untitled")}</span></td>
              <td style="max-width: 200px; font-size: 11px; color: #ff6b6b;">${escapeHtml(reasons)}</td>
              <td>${rejectedAt}</td>
              <td>
                <button class="btn btn-sm" onclick="restoreRejected('${p.id}')">Restore</button>
                <button class="btn btn-sm btn-danger" onclick="permanentlyDelete('${p.id}')">Delete</button>
              </td>
            </tr>
          `;
        }

        tableHtml += `</tbody></table>`;
        
        if (currentRejected.length === 0) {
          tableHtml = `<div style="text-align: center; padding: 40px; color: #aaa;">No rejected products found</div>`;
        }
        
        document.getElementById("rejectedTable").innerHTML = tableHtml;

        // Pagination
        const totalPages = data.totalPages || 1;
        let paginationHtml = `
          <div class="pagination-info">
            Showing ${data.total > 0 ? (rejectedPage - 1) * 25 + 1 : 0}‚Äì${Math.min(rejectedPage * 25, data.total)} of ${data.total} rejected
          </div>
          <div class="pagination-btns">
            <button class="btn btn-sm" onclick="rejectedPage=1;loadRejected()" ${rejectedPage <= 1 ? 'disabled' : ''}>First</button>
            <button class="btn btn-sm" onclick="rejectedPage--;loadRejected()" ${rejectedPage <= 1 ? 'disabled' : ''}>Prev</button>
            <span style="padding: 0 10px;">Page ${rejectedPage} of ${totalPages}</span>
            <button class="btn btn-sm" onclick="rejectedPage++;loadRejected()" ${rejectedPage >= totalPages ? 'disabled' : ''}>Next</button>
            <button class="btn btn-sm" onclick="rejectedPage=${totalPages};loadRejected()" ${rejectedPage >= totalPages ? 'disabled' : ''}>Last</button>
          </div>
        `;
        document.getElementById("rejectedPagination").innerHTML = paginationHtml;
        updateRejectedBulkActions();
        
      } catch (err) {
        document.getElementById("rejectedTable").innerHTML = `<div class="error-msg">${err.message}</div>`;
      }
    }

    async function previewScan() {
      try {
        const data = await apiFetch("/api/admin/rejected/scan-preview");
        document.getElementById("scanPreview").style.display = "block";
        document.getElementById("previewStats").textContent = 
          `Would reject ${data.wouldReject} products, keep ${data.wouldKeep} active`;
        
        let previewHtml = data.preview.map(p => 
          `<div class="error-item">${escapeHtml(p.title)} ‚Äî ${escapeHtml((p.rejectReasons || []).join(", "))}</div>`
        ).join("");
        
        if (data.wouldReject > 50) {
          previewHtml += `<div class="error-item" style="color: #aaa;">... and ${data.wouldReject - 50} more</div>`;
        }
        
        document.getElementById("previewList").innerHTML = previewHtml || "<div>No products would be rejected</div>";
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function runScan() {
      if (!confirm("This will scan all products and reject non-pet items. Continue?")) return;
      
      try {
        const data = await apiFetch("/api/admin/rejected/scan", { method: "POST" });
        showToast(`Scanned ${data.scanned} products, rejected ${data.rejected}`);
        document.getElementById("scanPreview").style.display = "none";
        loadRejected();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function restoreRejected(id) {
      try {
        await apiFetch(`/api/admin/rejected/${id}/restore`, { method: "POST" });
        showToast("Product restored");
        loadRejected();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    async function permanentlyDelete(id) {
      if (!confirm("Permanently delete this product? This cannot be undone.")) return;
      try {
        await apiFetch(`/api/admin/rejected/${id}`, { method: "DELETE" });
        showToast("Product permanently deleted");
        loadRejected();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    function toggleRejectedSelect(id) {
      if (selectedRejected.has(id)) selectedRejected.delete(id);
      else selectedRejected.add(id);
      updateRejectedBulkActions();
    }

    function toggleSelectAllRejected() {
      const selectAll = document.getElementById("selectAllRejected");
      if (selectAll.checked) {
        currentRejected.forEach(p => selectedRejected.add(p.id));
      } else {
        currentRejected.forEach(p => selectedRejected.delete(p.id));
      }
      loadRejected();
    }

    function updateRejectedBulkActions() {
      const bulkDiv = document.getElementById("rejectedBulkActions");
      const countSpan = document.getElementById("rejectedSelectedCount");
      if (selectedRejected.size > 0) {
        bulkDiv.classList.remove("hidden");
        countSpan.textContent = selectedRejected.size;
      } else {
        bulkDiv.classList.add("hidden");
      }
    }

    async function bulkRestoreRejected() {
      if (selectedRejected.size === 0) return;
      if (!confirm(`Restore ${selectedRejected.size} products?`)) return;
      
      try {
        await apiFetch("/api/admin/rejected/bulk/restore", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids: Array.from(selectedRejected) })
        });
        showToast(`Restored ${selectedRejected.size} products`);
        selectedRejected.clear();
        loadRejected();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    function clearRejectedSelection() {
      selectedRejected.clear();
      updateRejectedBulkActions();
      loadRejected();
    }

    // Rejected search on Enter key
    document.getElementById("rejectedSearch")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") loadRejected();
    });

    async function exportToCJ(orderId) {
      if (!confirm("Export this order to CJ Dropshipping?")) return;
      try {
        const res = await fetch(`/api/admin/cj/export/${orderId}`, {
          method: "POST",
          credentials: "include"
        });
        const data = await res.json();
        showToast(data.message || "Order exported successfully");
        loadOrders();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    // Search on Enter key
    document.getElementById("productSearch").addEventListener("keypress", (e) => {
      if (e.key === "Enter") loadProducts();
    });

    // === CJ Import Functions ===
    let cjPreviewData = null;

    async function loadCJImportStatus() {
      try {
        const data = await apiFetch("/api/admin/cj-import/status");
        const statusEl = document.getElementById("cjApiStatus");
        if (data.connected) {
          statusEl.textContent = "Connected";
          statusEl.style.color = "#00C4A7";
        } else if (data.hasCredentials) {
          statusEl.textContent = "Auth Failed";
          statusEl.style.color = "#ff6b6b";
        } else {
          statusEl.textContent = "No Credentials";
          statusEl.style.color = "#ffa500";
        }
      } catch (err) {
        document.getElementById("cjApiStatus").textContent = "Error";
      }
    }

    async function previewCJImport() {
      const input = document.getElementById("cjUrlInput").value.trim();
      if (!input) {
        showToast("Please enter a URL or SPU", "error");
        return;
      }

      const previewDiv = document.getElementById("cjPreview");
      const contentDiv = document.getElementById("cjPreviewContent");
      const errorDiv = document.getElementById("cjPreviewError");
      const errorContent = document.getElementById("cjPreviewErrorContent");
      const detectedDiv = document.getElementById("cjDetectedInfo");
      const importBtn = document.getElementById("cjImportBtn");

      contentDiv.innerHTML = '<div class="loading">Loading product from CJ...</div>';
      previewDiv.style.display = "block";
      errorDiv.style.display = "none";
      if (detectedDiv) detectedDiv.style.display = "none";
      importBtn.disabled = true;

      try {
        const data = await apiFetch("/api/admin/cj-import/preview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input })
        });

        if (!data.ok) {
          previewDiv.style.display = "none";
          errorDiv.style.display = "block";
          errorContent.innerHTML = `<strong>Error:</strong> ${data.error}<br><small>Input type: ${data.inputType || 'unknown'}</small>`;
          cjPreviewData = null;
          return;
        }

        cjPreviewData = data;
        const p = data.product;
        const det = data.detection || {};
        const wh = data.warehouse || {};
        
        const galleryImgs = (p.galleryImages || []).slice(0, 4);
        const fallbackChain = galleryImgs.length > 0 ? galleryImgs.map(img => `'${img}'`).join(',') : "'/placeholder.svg'";
        const galleryHtml = galleryImgs.map((img, idx) => 
          `<img src="${img}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #333; cursor: pointer;" onclick="document.getElementById('cjPreviewMainImg').src='${img}'" onerror="this.style.display='none'" />`
        ).join('');
        
        const inputTypeBadge = `<span style="background:#2a2a4a;color:#8888ff;padding:2px 8px;border-radius:3px;font-size:10px;font-weight:600;">Detected: ${data.displayType || data.inputType || 'Unknown'}</span>`;
        
        const whBadge = wh.hasUS 
          ? '<span style="background:#1a3a2a;color:#00C4A7;padding:2px 6px;border-radius:3px;font-size:10px;">US Warehouse</span>'
          : '<span style="background:#3a2a1a;color:#ffa500;padding:2px 6px;border-radius:3px;font-size:10px;">CN Warehouse</span>';
        
        const petBadge = det.isPetRelated
          ? `<span style="background:#1a3a2a;color:#00C4A7;padding:2px 6px;border-radius:3px;font-size:10px;">${det.petType || 'Pet'}</span>`
          : '<span style="background:#3a1a1a;color:#ff6b6b;padding:2px 6px;border-radius:3px;font-size:10px;">NOT Pet</span>';
        
        const subcatBadge = det.subcatKey 
          ? `<span style="background:#262643;color:#aaa;padding:2px 6px;border-radius:3px;font-size:10px;">${det.subcatKey}</span>`
          : '';

        contentDiv.innerHTML = `
          <div style="margin-bottom: 12px;">${inputTypeBadge}</div>
          <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div>
              <img id="cjPreviewMainImg" src="${p.mainImage || '/placeholder.svg'}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; background: #262643;" onerror="this.onerror=null; var fallbacks=[${fallbackChain}]; for(var i=0;i<fallbacks.length;i++){if(this.src!==fallbacks[i]){this.src=fallbacks[i];return;}} this.src='/placeholder.svg';" />
              <div style="display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap;">
                ${galleryHtml}
              </div>
            </div>
            <div style="flex: 1; min-width: 200px;">
              <h4 style="margin-bottom: 8px;">${p.title}</h4>
              <p style="font-size: 11px; color: #aaa; margin-bottom: 10px; max-height: 60px; overflow: hidden;">${(p.description || '').substring(0, 200)}...</p>
              <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                ${whBadge} ${petBadge} ${subcatBadge}
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; font-size: 11px;">
                <div><strong>Cost:</strong> $${(p.costPrice || 0).toFixed(2)}</div>
                <div><strong>Variants:</strong> ${p.variantCount || 1}</div>
                <div><strong>Category:</strong> ${p.categoryName || 'N/A'}</div>
                <div><strong>PID:</strong> ${data.cjPid || 'N/A'}</div>
                <div><strong>SPU:</strong> ${data.cjSpu || 'N/A'}</div>
                <div><strong>Endpoint:</strong> ${data.usedEndpoint || 'N/A'}</div>
              </div>
            </div>
          </div>
        `;
        
        if (detectedDiv) {
          detectedDiv.style.display = "block";
          detectedDiv.innerHTML = `
            <div style="font-size: 11px; color: #aaa; margin-top: 10px; padding: 8px; background: #262643; border-radius: 4px;">
              <strong>Auto-detected:</strong> Pet Type: <strong>${det.petType || 'UNKNOWN'}</strong> | 
              Subcategory: <strong>${det.subcatKey || 'None'}</strong> | 
              Is Pet Related: <strong>${det.isPetRelated ? 'Yes' : 'No'}</strong>
            </div>
          `;
        }
        
        importBtn.disabled = false;
        showToast("Product found - configure options and import");
      } catch (err) {
        previewDiv.style.display = "none";
        errorDiv.style.display = "block";
        errorContent.innerHTML = `<strong>Request failed:</strong> ${err.message}`;
        cjPreviewData = null;
      }
    }

    async function importCJProduct() {
      const input = document.getElementById("cjUrlInput").value.trim();
      if (!input) {
        showToast("Please enter a URL or SPU", "error");
        return;
      }

      const options = {
        requireImages: document.getElementById("cjRequireImages").checked,
        rejectNonPet: document.getElementById("cjRejectNonPet").checked,
        overwrite: document.getElementById("cjOverwrite").checked,
        markFeatured: document.getElementById("cjMarkFeatured").checked,
        featuredRank: document.getElementById("cjFeaturedRank").value,
        categoryPin: document.getElementById("cjCategoryPin").value,
        subcatPin: document.getElementById("cjSubcatPin").value
      };

      const resultDiv = document.getElementById("cjImportResult");
      resultDiv.style.display = "block";
      resultDiv.innerHTML = '<div class="loading">Importing product...</div>';

      try {
        const data = await apiFetch("/api/admin/cj-import/import", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input, options })
        });

        if (!data.ok) {
          const isRejectError = data.error && data.error.includes('REJECTED');
          const spu = data.spu || cjPreviewData?.cjSpu || '';
          const reasons = data.reasons ? data.reasons.join(', ') : '';
          
          if (isRejectError && spu) {
            resultDiv.innerHTML = `
              <div class="error-msg" style="background: #3d1a1a; border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px;">
                <strong style="color: #ff6b6b;">${data.error}</strong>
                ${reasons ? `<p style="margin-top: 8px; font-size: 11px; color: #ffaaaa;">Reasons: ${reasons}</p>` : ''}
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #552222;">
                  <p style="font-size: 12px; color: #aaa; margin-bottom: 10px;">If this is a valid pet product, you can force-approve it:</p>
                  <input type="text" id="forceApproveReason" placeholder="Reason for approval (e.g., 'Dog car seat cover is a pet product')" 
                         style="width: 100%; padding: 8px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; margin-bottom: 10px;" />
                  <button class="btn" onclick="forceApproveProduct('${spu}', '${data.error}')" style="background: #ff6b6b;">
                    Force Approve & Import
                  </button>
                </div>
              </div>
            `;
          } else {
            resultDiv.innerHTML = `<div class="error-msg">${data.error}</div>`;
          }
          return;
        }

        const p = data.product;
        const badges = [];
        if (data.featured) badges.push('<span style="background:#1a3a2a;color:#00C4A7;padding:2px 6px;border-radius:3px;">Featured</span>');
        if (data.dogRank) badges.push(`<span style="background:#3a2a1a;color:#ffa500;padding:2px 6px;border-radius:3px;">Dog #${data.dogRank}</span>`);
        if (data.catRank) badges.push(`<span style="background:#2a1a3a;color:#aa88ff;padding:2px 6px;border-radius:3px;">Cat #${data.catRank}</span>`);
        if (data.subcatRank) badges.push(`<span style="background:#262643;color:#aaa;padding:2px 6px;border-radius:3px;">${data.subcatKey} #${data.subcatRank}</span>`);
        
        resultDiv.innerHTML = `
          <div class="success-msg">
            <strong>Imported: ${p.title}</strong>
            <p style="margin-top: 5px; font-size: 12px;">
              PID: ${data.cjPid || 'N/A'} | Variants: ${data.variantCount} | 
              ${data.rejected ? '<span style="color:#ff6b6b;">Rejected (non-pet)</span>' : '<span style="color:#00C4A7;">Active</span>'}
            </p>
            ${badges.length > 0 ? `<div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">${badges.join('')}</div>` : ''}
          </div>
        `;
        showToast("Product imported successfully");
        document.getElementById("cjUrlInput").value = "";
        document.getElementById("cjPreview").style.display = "none";
        document.getElementById("cjPreviewError").style.display = "none";
        document.getElementById("cjImportBtn").disabled = true;
        cjPreviewData = null;
      } catch (err) {
        resultDiv.innerHTML = `<div class="error-msg">${err.message}</div>`;
      }
    }

    async function forceApproveProduct(spu, originalError) {
      const reason = document.getElementById('forceApproveReason')?.value || 'Admin force-approve';
      const resultDiv = document.getElementById("cjImportResult");
      
      resultDiv.innerHTML = '<div class="loading">Force approving and importing...</div>';
      
      try {
        const approveRes = await apiFetch("/api/admin/overrides/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            productId: spu, 
            reason,
            originalRejectReason: originalError 
          })
        });
        
        if (!approveRes.success) {
          resultDiv.innerHTML = `<div class="error-msg">Failed to approve: ${approveRes.error}</div>`;
          return;
        }
        
        await importCJProduct();
        
        showToast("Product force-approved and imported!");
      } catch (err) {
        resultDiv.innerHTML = `<div class="error-msg">${err.message}</div>`;
      }
    }

    // ============ AUDIT FUNCTIONS ============
    let auditData = null;
    let productsWithImageIssues = [];

    async function runAudit() {
      document.getElementById("auditSummary").style.display = "none";
      document.getElementById("auditResults").style.display = "none";
      document.getElementById("auditLoading").style.display = "block";

      try {
        const data = await apiFetch("/api/admin/audit");
        auditData = data;
        
        document.getElementById("auditTotalProducts").textContent = data.summary.totalProducts;
        document.getElementById("auditTotalIssues").textContent = data.summary.totalIssues;
        document.getElementById("auditDuplicateImages").textContent = data.summary.duplicateImageGroups;
        document.getElementById("auditDuplicateTitles").textContent = data.summary.duplicateTitleGroups;
        document.getElementById("auditImageIssues").textContent = data.summary.productsWithImageIssues;
        document.getElementById("auditVariantIssues").textContent = data.summary.productsWithVariantIssues;
        document.getElementById("auditPricingIssues").textContent = data.summary.productsWithPricingIssues;
        
        renderDuplicateImages(data.duplicateImages);
        renderDuplicateTitles(data.duplicateTitles);
        renderImageIssues(data.missingImages);
        renderVariantIssues(data.suspectVariants);
        renderPricingIssues(data.pricingIssues);
        
        document.getElementById("auditLoading").style.display = "none";
        document.getElementById("auditSummary").style.display = "block";
        document.getElementById("auditResults").style.display = "block";
        
        showToast(`Audit complete: ${data.summary.totalIssues} issues found`);
      } catch (err) {
        document.getElementById("auditLoading").style.display = "none";
        showToast("Audit failed: " + err.message, "error");
      }
    }

    function renderDuplicateImages(data) {
      const container = document.getElementById("duplicateImagesList");
      if (!data.groups || data.groups.length === 0) {
        container.innerHTML = '<p style="color: #00C4A7; font-size: 12px;">No duplicate images found</p>';
        return;
      }
      
      container.innerHTML = data.groups.slice(0, 20).map(group => `
        <div style="margin-bottom: 15px; padding: 10px; background: #262643; border-radius: 4px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <img src="${group.image}" style="width: 48px; height: 48px; object-fit: cover; border-radius: 4px;" onerror="this.src='/placeholder.svg'"/>
            <div>
              <span style="color: #ffa500; font-weight: bold;">${group.count} products</span>
              <span style="font-size: 11px; color: #aaa;"> share this image</span>
            </div>
          </div>
          <div style="font-size: 11px;">
            ${group.products.map(p => `
              <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333;">
                <span class="product-title" onclick="openDrawer('${p.id}')">${p.title.substring(0, 40)}...</span>
                <div>
                  <span style="color: ${p.active ? '#00C4A7' : '#aaa'};">${p.active ? 'Active' : 'Inactive'}</span>
                  <button class="btn btn-sm" style="margin-left: 8px;" onclick="fixDuplicateGroup('${group.image}', '${p.id}', ${JSON.stringify(group.products.map(x => x.id)).replace(/"/g, '&quot;')})">Keep Only This</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function renderDuplicateTitles(data) {
      const container = document.getElementById("duplicateTitlesList");
      if (!data.groups || data.groups.length === 0) {
        container.innerHTML = '<p style="color: #00C4A7; font-size: 12px;">No duplicate titles found</p>';
        return;
      }
      
      container.innerHTML = data.groups.slice(0, 20).map(group => `
        <div style="margin-bottom: 15px; padding: 10px; background: #262643; border-radius: 4px;">
          <div style="color: #ffa500; font-weight: bold; margin-bottom: 10px;">"${group.normalizedTitle.substring(0, 50)}..." (${group.count} products)</div>
          <div style="font-size: 11px;">
            ${group.products.map(p => `
              <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333;">
                <span class="product-title" onclick="openDrawer('${p.id}')">${p.title.substring(0, 50)}...</span>
                <span style="color: ${p.active ? '#00C4A7' : '#aaa'};">$${p.price?.toFixed(2) || '0.00'} | ${p.active ? 'Active' : 'Inactive'}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function renderImageIssues(data) {
      const container = document.getElementById("imageIssuesList");
      productsWithImageIssues = data.products || [];
      
      if (!data.products || data.products.length === 0) {
        container.innerHTML = '<p style="color: #00C4A7; font-size: 12px;">No image issues found</p>';
        document.getElementById("fixImageIssuesBtn").disabled = true;
        return;
      }
      
      document.getElementById("fixImageIssuesBtn").disabled = false;
      
      const issueLabels = {
        no_image: 'No Image',
        file_missing: 'File Missing',
        external_url: 'External URL',
        placeholder_demo: 'Demo Image',
        placeholder_stock: 'Stock Image'
      };
      
      container.innerHTML = data.products.slice(0, 50).map(p => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 11px;">
          <span class="product-title" onclick="openDrawer('${p.id}')">${p.title.substring(0, 40)}...</span>
          <div>
            ${p.issues.map(i => `<span style="background: #3a2a1a; color: #ffa500; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">${issueLabels[i] || i}</span>`).join('')}
          </div>
        </div>
      `).join('');
    }

    function renderVariantIssues(data) {
      const container = document.getElementById("variantIssuesList");
      if (!data.products || data.products.length === 0) {
        container.innerHTML = '<p style="color: #00C4A7; font-size: 12px;">No variant issues found</p>';
        return;
      }
      
      const issueLabels = {
        no_variants: 'No Variants',
        variant_missing_sku: 'Missing SKU',
        duplicate_sku: 'Duplicate SKU',
        variant_invalid_price: 'Invalid Price',
        variant_no_options: 'No Options',
        excessive_variants: '>100 Variants'
      };
      
      container.innerHTML = data.products.slice(0, 50).map(p => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 11px;">
          <span class="product-title" onclick="openDrawer('${p.id}')">${p.title.substring(0, 40)}... (${p.variantCount} variants)</span>
          <div>
            ${p.issues.map(i => `<span style="background: #3a2a1a; color: #ffa500; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">${issueLabels[i] || i}</span>`).join('')}
          </div>
        </div>
      `).join('');
    }

    function renderPricingIssues(data) {
      const container = document.getElementById("pricingIssuesList");
      if (!data || !data.products || data.products.length === 0) {
        container.innerHTML = '<p style="color: #00C4A7; font-size: 12px;">No pricing issues found</p>';
        return;
      }
      
      const issueLabels = {
        invalid_base_price: 'Invalid Price',
        price_too_low: 'Price Too Low (<$1)',
        price_suspiciously_high: 'Price Too High (>$10k)',
        extreme_variant_price_range: 'Extreme Price Range'
      };
      
      container.innerHTML = data.products.slice(0, 50).map(p => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 11px;">
          <span class="product-title" onclick="openDrawer('${p.id}')">${p.title.substring(0, 40)}...</span>
          <div>
            <span style="color: #fff; margin-right: 8px;">$${p.price?.toFixed(2) || '0.00'}</span>
            ${p.issues.map(i => `<span style="background: #3a2a1a; color: #ffa500; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">${issueLabels[i] || i}</span>`).join('')}
          </div>
        </div>
      `).join('');
    }

    async function fixDuplicateGroup(image, keepId, productIds) {
      if (!confirm(`Keep "${keepId}" and disable ${productIds.length - 1} other products with this image?`)) return;
      
      try {
        await apiFetch("/api/admin/audit/fix-duplicate-group", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productIds, keepId })
        });
        showToast(`Disabled ${productIds.length - 1} duplicate products`);
        runAudit();
      } catch (err) {
        showToast("Fix failed: " + err.message, "error");
      }
    }

    async function fixImageIssues() {
      if (productsWithImageIssues.length === 0) return;
      
      const activeProducts = productsWithImageIssues.filter(p => p.active);
      if (activeProducts.length === 0) {
        showToast("No active products with image issues", "error");
        return;
      }
      
      if (!confirm(`Disable ${activeProducts.length} products with image issues?`)) return;
      
      try {
        await apiFetch("/api/admin/audit/fix-missing-images", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productIds: activeProducts.map(p => p.id) })
        });
        showToast(`Disabled ${activeProducts.length} products`);
        runAudit();
      } catch (err) {
        showToast("Fix failed: " + err.message, "error");
      }
    }

    async function bulkCJImport() {
      const text = document.getElementById("cjBulkInput").value.trim();
      if (!text) {
        showToast("Please enter URLs or SPUs", "error");
        return;
      }

      const inputs = text.split("\n").map(s => s.trim()).filter(s => s.length > 0);
      if (inputs.length === 0) {
        showToast("No valid entries found", "error");
        return;
      }

      if (inputs.length > 50) {
        showToast("Maximum 50 products per batch", "error");
        return;
      }

      const options = {
        requireImages: document.getElementById("cjRequireImages").checked,
        applyPetFilter: document.getElementById("cjApplyPetFilter").checked,
        overwrite: document.getElementById("cjOverwrite").checked
      };

      const resultDiv = document.getElementById("cjImportResult");
      resultDiv.style.display = "block";
      resultDiv.innerHTML = `<div class="loading">Importing ${inputs.length} products...</div>`;

      try {
        const data = await apiFetch("/api/admin/cj-import/bulk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ inputs, options })
        });

        resultDiv.innerHTML = `
          <div class="success-msg">
            <strong>Bulk Import Complete</strong>
            <p style="margin-top: 5px; font-size: 12px;">
              Success: ${data.success.length} | Failed: ${data.failed.length} | Skipped: ${data.skipped.length}
            </p>
            ${data.failed.length > 0 ? `
              <div class="error-list" style="margin-top: 10px;">
                ${data.failed.map(f => `<div class="error-item">${f.input}: ${f.error}</div>`).join("")}
              </div>
            ` : ''}
          </div>
        `;
        showToast(`Imported ${data.success.length} products`);
        document.getElementById("cjBulkInput").value = "";
      } catch (err) {
        resultDiv.innerHTML = `<div class="error-msg">${err.message}</div>`;
      }
    }

    // CJ Import URL input on Enter key
    document.getElementById("cjUrlInput")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") previewCJImport();
    });

    // CJ Browse functionality
    let cjBrowseCurrentPage = 1;
    let cjBrowseLastQuery = {};

    async function searchCJBrowse(page = 1) {
      const keyword = document.getElementById("cjBrowseKeyword").value.trim();
      if (!keyword) {
        showToast("Please enter a search keyword", "error");
        return;
      }

      cjBrowseCurrentPage = page;
      const query = {
        keyword,
        usOnly: document.getElementById("cjBrowseUsOnly").checked,
        petOnly: document.getElementById("cjBrowsePetOnly").checked,
        requireImages: document.getElementById("cjBrowseImages").checked,
        sort: document.getElementById("cjBrowseSort").value || undefined,
        minPrice: parseFloat(document.getElementById("cjBrowseMinPrice").value) || undefined,
        maxPrice: parseFloat(document.getElementById("cjBrowseMaxPrice").value) || undefined,
        pageNum: page,
        pageSize: 20
      };
      cjBrowseLastQuery = query;

      document.getElementById("cjBrowseLoading").style.display = "block";
      document.getElementById("cjBrowseResults").style.display = "none";
      document.getElementById("cjBrowseEmpty").style.display = "none";

      try {
        const data = await apiFetch("/api/admin/cj/browse", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(query)
        });

        document.getElementById("cjBrowseLoading").style.display = "none";

        if (!data.products || data.products.length === 0) {
          document.getElementById("cjBrowseEmpty").style.display = "block";
          return;
        }

        renderCJBrowseResults(data);
      } catch (err) {
        document.getElementById("cjBrowseLoading").style.display = "none";
        showToast("Search failed: " + err.message, "error");
      }
    }

    function renderCJBrowseResults(data) {
      const { products, total, pageNum, pageSize, fromCache, debug, filteredCount } = data;
      const totalPages = Math.ceil(total / pageSize);

      document.getElementById("cjBrowseResults").style.display = "block";
      
      // Show fallback warning if filters were relaxed
      const fallbackWarning = document.getElementById("cjBrowseFallbackWarning");
      if (debug?.fallbackUsed) {
        const fallbackMessages = {
          'no_pet_filter': 'Pet filter was disabled to show results',
          'no_us_filter': 'US warehouse filter was disabled',
          'no_pet_us_filter': 'Both Pet and US filters were disabled',
          'no_image_filter': 'Image requirement was disabled',
          'no_filters': 'All filters were disabled to show results'
        };
        fallbackWarning.style.display = "block";
        document.getElementById("cjBrowseFallbackTitle").textContent = "Filters Relaxed";
        document.getElementById("cjBrowseFallbackDesc").textContent = fallbackMessages[debug.fallbackUsed] || 'Some filters were relaxed';
      } else {
        fallbackWarning.style.display = "none";
      }
      
      document.getElementById("cjBrowseInfo").innerHTML = `
        Showing ${products.length} of ${total} products${fromCache ? ' <span style="color: #00C4A7;">(cached)</span>' : ''}
      `;

      const grid = document.getElementById("cjBrowseGrid");
      grid.innerHTML = products.map(p => {
        const imgUrl = p.image || p.productImage || p.productImageSet?.[0] || '/placeholder.svg';
        const cost = parseFloat(p.costPrice || p.sellPrice || p.productCost || 0).toFixed(2);
        const warehouses = p.warehouse || (p.productSku?.[0]?.productNameEn?.includes('US') ? 'US' : (p.productWarehouseType || 'CN'));
        const title = p.title || p.productNameEn || p.productName || 'Untitled';
        const isPet = p.isPetRelated !== undefined ? p.isPetRelated : true;
        
        return `
          <div style="background: #1a1a2e; border: 1px solid ${p.alreadyImported ? '#00C4A7' : '#262643'}; border-radius: 8px; overflow: hidden; position: relative;">
            ${p.alreadyImported ? '<div style="position: absolute; top: 8px; right: 8px; background: #00C4A7; color: #1a1a2e; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">Imported</div>' : ''}
            ${!isPet ? '<div style="position: absolute; top: 8px; left: 8px; background: #ff6b6b; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 9px;">Non-Pet</div>' : ''}
            <div style="width: 100%; height: 150px; background: #262643; display: flex; align-items: center; justify-content: center; overflow: hidden;">
              <img src="${imgUrl}" 
                   style="max-width: 100%; max-height: 150px; object-fit: contain;"
                   onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=\\'color:#666;font-size:11px;\\'>No image</div>';" />
            </div>
            <div style="padding: 12px;">
              <div style="font-size: 12px; color: #fff; margin-bottom: 8px; height: 36px; overflow: hidden; line-height: 1.4;">
                ${title.substring(0, 60)}${title.length > 60 ? '...' : ''}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                  <span style="font-size: 14px; font-weight: 700; color: #00C4A7;">$${cost}</span>
                  <span style="font-size: 10px; color: #aaa; margin-left: 4px;">cost</span>
                </div>
                <span style="font-size: 10px; background: ${warehouses === 'US' ? '#1a3a2a' : '#262643'}; color: ${warehouses === 'US' ? '#00C4A7' : '#aaa'}; padding: 2px 6px; border-radius: 3px;">${warehouses}</span>
              </div>
              <div style="display: flex; gap: 6px;">
                <button class="btn btn-sm" style="flex: 1;" onclick="quickCJImport('${p.pid}')" ${p.alreadyImported ? 'disabled' : ''}>
                  ${p.alreadyImported ? 'Exists' : 'Import'}
                </button>
                <button class="btn btn-sm btn-secondary" onclick="previewCJFromBrowse('${p.pid}')">Preview</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Pagination
      const paginationHtml = renderCJBrowsePagination(pageNum, totalPages);
      document.getElementById("cjBrowsePagination").innerHTML = paginationHtml;
      document.getElementById("cjBrowsePaginationBottom").innerHTML = paginationHtml;
    }

    function renderCJBrowsePagination(current, total) {
      if (total <= 1) return '';
      
      let html = '';
      if (current > 1) {
        html += `<button class="btn btn-sm btn-secondary" onclick="searchCJBrowse(${current - 1})">Prev</button>`;
      }
      
      const start = Math.max(1, current - 2);
      const end = Math.min(total, current + 2);
      
      for (let i = start; i <= end; i++) {
        html += `<button class="btn btn-sm ${i === current ? '' : 'btn-secondary'}" onclick="searchCJBrowse(${i})">${i}</button>`;
      }
      
      if (current < total) {
        html += `<button class="btn btn-sm btn-secondary" onclick="searchCJBrowse(${current + 1})">Next</button>`;
      }
      
      return html;
    }

    async function quickCJImport(pid) {
      const options = {
        markFeatured: document.getElementById("cjMarkFeatured")?.checked ?? true,
        categoryPin: document.getElementById("cjCategoryPin")?.value || 'AUTO',
        subcatPin: document.getElementById("cjSubcatPin")?.value || 'AUTO'
      };

      try {
        showToast("Importing product...");
        const data = await apiFetch("/api/admin/cj/quick-import", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pid, options })
        });

        if (data.ok) {
          showToast(`Imported: ${data.product?.title || 'Product'}`);
          // Refresh to show "Imported" badge
          searchCJBrowse(cjBrowseCurrentPage);
        } else {
          showToast(data.error || "Import failed", "error");
        }
      } catch (err) {
        showToast("Import failed: " + err.message, "error");
      }
    }

    function previewCJFromBrowse(pid) {
      document.getElementById("cjUrlInput").value = pid;
      switchTab("cjimport");
      previewCJImport();
    }

    // CJ Browse keyword on Enter key
    document.getElementById("cjBrowseKeyword")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") searchCJBrowse();
    });

    // ============ CJ FEEDS ============
    let currentFeedProducts = [];
    let currentFeedId = null;
    let expandedFeedId = null;

    async function loadFeedsWithStats() {
      try {
        const [feedsData, statsData] = await Promise.all([
          apiFetch("/api/admin/cj/feeds"),
          apiFetch("/api/admin/cj/feeds/stats")
        ]);
        
        // Update scheduler stats
        const sched = statsData.scheduler || {};
        const summary = statsData.summary || {};
        const global = statsData.global || {};
        
        document.getElementById("schedNextRun").textContent = sched.nextScheduledRun 
          ? new Date(sched.nextScheduledRun).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short' })
          : 'Not scheduled';
        document.getElementById("schedLastRun").textContent = global.lastRunAt 
          ? new Date(global.lastRunAt).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short' })
          : 'Never';
        document.getElementById("schedTotalNew").textContent = summary.totalNewItems || 0;
        document.getElementById("schedTodayImported").textContent = summary.todayImported || 0;
        document.getElementById("schedStatus").textContent = sched.isRunning ? 'Running...' : 'Idle';
        document.getElementById("schedStatus").style.color = sched.isRunning ? '#ffa500' : '#00C4A7';
        
        // Update badge
        const badge = document.getElementById("cjFeedsBadge");
        if (summary.totalNewItems > 0) {
          badge.textContent = summary.totalNewItems;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
        
        renderFeedsList(feedsData.feeds || []);
      } catch (err) {
        showToast("Failed to load feeds: " + err.message, "error");
      }
    }

    async function loadFeeds() {
      await loadFeedsWithStats();
    }

    function renderFeedsList(feeds) {
      const list = document.getElementById("feedsList");
      
      if (!feeds || feeds.length === 0) {
        list.innerHTML = '<div style="color: #aaa; text-align: center; padding: 20px;">No feeds yet. Create one to get started.</div>';
        return;
      }
      
      list.innerHTML = feeds.map(f => {
        const statusColor = f.lastRunStatus === 'error' ? '#ff6b6b' : (f.lastRunStatus === 'success' ? '#00C4A7' : '#aaa');
        const statusIcon = f.lastRunStatus === 'error' ? '‚ùå' : (f.lastRunStatus === 'success' ? '‚úì' : '‚Ä¢');
        const lastRunText = f.lastRunAt ? new Date(f.lastRunAt).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short' }) : 'Never';
        const newBadge = (f.lastNewCount > 0) ? `<span style="background: #00C4A7; color: #1a1a2e; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 700;">${f.lastNewCount} NEW</span>` : '';
        const autoImportBadge = f.autoImport?.enabled ? `<span style="background: #1a3a2a; color: #00C4A7; padding: 2px 6px; border-radius: 10px; font-size: 10px;">Auto</span>` : '';
        const isExpanded = expandedFeedId === f.id;
        const autoImport = f.autoImport || {};
        const autoStats = f.autoImportStats || {};
        
        return `
          <div style="background: #262643; border-radius: 6px; overflow: hidden; border: 1px solid ${f.lastRunStatus === 'error' ? '#ff6b6b33' : '#333'};">
            <div style="padding: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleFeedExpand('${f.id}')">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                  ${f.name} ${newBadge} ${autoImportBadge}
                </div>
                <div style="font-size: 11px; color: #aaa; display: flex; gap: 12px; flex-wrap: wrap;">
                  <span>üîç "${f.keyword}"</span>
                  <span>${f.filters?.usOnly ? 'üá∫üá∏ US' : 'üåç All'}</span>
                  <span style="color: ${statusColor};">${statusIcon} ${lastRunText}</span>
                  <span>${f.lastResultCount || 0} results</span>
                </div>
                ${f.lastRunStatus === 'error' ? `<div style="font-size: 10px; color: #ff6b6b; margin-top: 4px;">Error: ${f.lastRunError || 'Unknown'}</div>` : ''}
              </div>
              <div style="display: flex; gap: 6px; align-items: center;">
                <button class="btn btn-sm" onclick="event.stopPropagation(); runFeed('${f.id}')">Run</button>
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteFeed('${f.id}')">Delete</button>
                <span style="color: #aaa; font-size: 14px;">${isExpanded ? '‚ñ≤' : '‚ñº'}</span>
              </div>
            </div>
            
            ${isExpanded ? `
            <div style="border-top: 1px solid #333; padding: 15px; background: #1a1a2e;">
              <h4 style="font-size: 12px; margin-bottom: 12px; color: #00C4A7;">Auto-Import Settings</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
                  <input type="checkbox" id="autoEnable_${f.id}" ${autoImport.enabled ? 'checked' : ''} onchange="updateFeedAutoImport('${f.id}')" />
                  Enable Auto-Import
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
                  <input type="checkbox" id="autoDryRun_${f.id}" ${autoImport.dryRun !== false ? 'checked' : ''} onchange="updateFeedAutoImport('${f.id}')" />
                  Dry-Run Mode
                </label>
                <div>
                  <label style="font-size: 10px; color: #aaa;">Max/Run:</label>
                  <input type="number" id="autoMaxRun_${f.id}" value="${autoImport.maxPerRun || 5}" min="1" max="20" style="width: 50px; padding: 4px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 11px;" onchange="updateFeedAutoImport('${f.id}')" />
                </div>
                <div>
                  <label style="font-size: 10px; color: #aaa;">Max/Day:</label>
                  <input type="number" id="autoMaxDay_${f.id}" value="${autoImport.maxPerDay || 10}" min="1" max="50" style="width: 50px; padding: 4px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 11px;" onchange="updateFeedAutoImport('${f.id}')" />
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 6px; font-size: 11px;">
                  <input type="checkbox" id="autoReqImages_${f.id}" ${autoImport.requireImages !== false ? 'checked' : ''} onchange="updateFeedAutoImport('${f.id}')" />
                  Require Images
                </label>
                <label style="display: flex; align-items: center; gap: 6px; font-size: 11px;">
                  <input type="checkbox" id="autoReqVariants_${f.id}" ${autoImport.requireVariants !== false ? 'checked' : ''} onchange="updateFeedAutoImport('${f.id}')" />
                  Require Variants
                </label>
                <label style="display: flex; align-items: center; gap: 6px; font-size: 11px;">
                  <input type="checkbox" id="autoRejectNonPet_${f.id}" ${autoImport.rejectNonPet !== false ? 'checked' : ''} onchange="updateFeedAutoImport('${f.id}')" />
                  Pet-Only
                </label>
              </div>
              <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                <div style="background: #262643; padding: 8px 12px; border-radius: 4px;">
                  <div style="font-size: 10px; color: #aaa;">Imported Today</div>
                  <div style="font-size: 16px; font-weight: 600; color: #00C4A7;">${autoStats.importedToday || 0}</div>
                </div>
                <div style="background: #262643; padding: 8px 12px; border-radius: 4px;">
                  <div style="font-size: 10px; color: #aaa;">Total Imported</div>
                  <div style="font-size: 16px; font-weight: 600; color: #00C4A7;">${autoStats.totalImported || 0}</div>
                </div>
                <div style="background: #262643; padding: 8px 12px; border-radius: 4px;">
                  <div style="font-size: 10px; color: #aaa;">Last Auto-Import</div>
                  <div style="font-size: 12px; color: #fff;">${autoStats.lastAutoImportAt ? new Date(autoStats.lastAutoImportAt).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short' }) : 'Never'}</div>
                </div>
              </div>
              <button class="btn btn-sm btn-secondary" onclick="testAutoImport('${f.id}')">Test Auto-Import (Dry Run)</button>
            </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function toggleFeedExpand(feedId) {
      expandedFeedId = expandedFeedId === feedId ? null : feedId;
      loadFeeds();
    }

    async function updateFeedAutoImport(feedId) {
      const config = {
        enabled: document.getElementById(`autoEnable_${feedId}`)?.checked || false,
        dryRun: document.getElementById(`autoDryRun_${feedId}`)?.checked || false,
        maxPerRun: parseInt(document.getElementById(`autoMaxRun_${feedId}`)?.value) || 5,
        maxPerDay: parseInt(document.getElementById(`autoMaxDay_${feedId}`)?.value) || 10,
        requireImages: document.getElementById(`autoReqImages_${feedId}`)?.checked !== false,
        requireVariants: document.getElementById(`autoReqVariants_${feedId}`)?.checked !== false,
        rejectNonPet: document.getElementById(`autoRejectNonPet_${feedId}`)?.checked !== false
      };
      
      try {
        await apiFetch(`/api/admin/cj/feeds/${feedId}/auto-import`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(config)
        });
        showToast("Auto-import settings saved");
      } catch (err) {
        showToast("Failed to save: " + err.message, "error");
      }
    }

    async function testAutoImport(feedId) {
      const btn = document.querySelector(`button[onclick="testAutoImport('${feedId}')"]`);
      if (btn) { btn.disabled = true; btn.textContent = "Testing..."; }
      
      try {
        const data = await apiFetch(`/api/admin/cj/feeds/${feedId}/test-auto-import`, { method: "POST" });
        
        if (data.ok) {
          const result = data.result || {};
          showToast(`Dry Run: ${result.selectedCount || 0} products would be imported (${result.candidateCount || 0} candidates)`);
        } else {
          showToast("Test failed: " + (data.error || 'Unknown'), "error");
        }
      } catch (err) {
        showToast("Test failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "Test Auto-Import (Dry Run)"; }
      }
    }

    async function runAllFeeds() {
      const btn = document.getElementById("runAllBtn");
      if (btn) { btn.disabled = true; btn.textContent = "Running..."; }
      
      try {
        showToast("Running all feeds...");
        const data = await apiFetch("/api/admin/cj/feeds/run-all", { method: "POST" });
        
        if (data.ok) {
          const r = data.results || {};
          showToast(`Completed: ${r.feedsSucceeded}/${r.feedsProcessed} feeds, ${r.totalNewItems} NEW items found`);
          loadFeedsWithStats();
        } else {
          showToast("Run failed: " + (data.error || 'Unknown'), "error");
        }
      } catch (err) {
        showToast("Run failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "Run All Feeds"; }
      }
    }

    async function createFeed() {
      const name = document.getElementById("feedName").value.trim();
      const keyword = document.getElementById("feedKeyword").value.trim();
      if (!name || !keyword) {
        showToast("Name and keyword required", "error");
        return;
      }
      
      const filters = {
        usOnly: document.getElementById("feedUsOnly").checked,
        petOnly: document.getElementById("feedPetOnly").checked,
        markFeatured: document.getElementById("feedFeatured").checked
      };
      
      const btn = document.querySelector('button[onclick="createFeed()"]');
      if (btn) { btn.disabled = true; btn.textContent = "Creating..."; }
      
      try {
        await apiFetch("/api/admin/cj/feeds", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, keyword, filters })
        });
        
        document.getElementById("feedName").value = "";
        document.getElementById("feedKeyword").value = "";
        showToast("Feed created!");
        loadFeeds();
      } catch (err) {
        showToast("Failed to create feed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "Create Feed"; }
      }
    }

    async function deleteFeed(id) {
      if (!confirm("Delete this feed?")) return;
      const btn = document.querySelector(`button[onclick="deleteFeed('${id}')"]`);
      if (btn) { btn.disabled = true; btn.textContent = "Deleting..."; }
      
      try {
        await apiFetch(`/api/admin/cj/feeds/${id}`, { method: "DELETE" });
        showToast("Feed deleted");
        loadFeeds();
      } catch (err) {
        showToast("Failed to delete: " + err.message, "error");
        if (btn) { btn.disabled = false; btn.textContent = "Delete"; }
      }
    }

    async function runFeed(id) {
      const runBtns = document.querySelectorAll(`button[onclick="runFeed('${id}')"]`);
      runBtns.forEach(btn => { btn.disabled = true; btn.textContent = "Running..."; });
      
      try {
        showToast("Running feed...");
        const data = await apiFetch(`/api/admin/cj/feeds/${id}/run`, { method: "POST" });
        
        if (!data.ok) {
          showToast("Feed run failed: " + data.error, "error");
          return;
        }
        
        currentFeedProducts = data.products || [];
        currentFeedId = id;
        
        document.getElementById("feedResultsName").textContent = data.feed?.name || "Feed";
        document.getElementById("feedResultsInfo").textContent = `${data.products.length} products | ${data.newCount} NEW`;
        
        const grid = document.getElementById("feedResultsGrid");
        grid.innerHTML = currentFeedProducts.map(p => {
          const imgUrl = p.image || '/placeholder.svg';
          const cost = parseFloat(p.costPrice || 0).toFixed(2);
          const newBadge = p.isNew && !p.alreadyImported ? '<div style="position: absolute; top: 4px; left: 4px; background: #00C4A7; color: #1a1a2e; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600;">NEW</div>' : '';
          const importedBadge = p.alreadyImported ? '<div style="position: absolute; top: 4px; right: 4px; background: #666; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 9px;">Imported</div>' : '';
          
          return `
            <div style="background: #1a1a2e; border: 1px solid ${p.alreadyImported ? '#444' : (p.isNew ? '#00C4A7' : '#262643')}; border-radius: 6px; overflow: hidden; position: relative;">
              ${newBadge}${importedBadge}
              <div style="width: 100%; height: 100px; background: #262643; display: flex; align-items: center; justify-content: center;">
                <img src="${imgUrl}" style="max-width: 100%; max-height: 100px; object-fit: contain;" onerror="this.style.display='none'" />
              </div>
              <div style="padding: 8px;">
                <div style="font-size: 11px; height: 32px; overflow: hidden; line-height: 1.3; margin-bottom: 6px;">${(p.title || 'Untitled').substring(0, 50)}</div>
                <div style="font-size: 12px; color: #00C4A7; font-weight: 600;">$${cost}</div>
              </div>
            </div>
          `;
        }).join('');
        
        document.getElementById("feedResults").style.display = "block";
        loadFeeds();
      } catch (err) {
        showToast("Feed run error: " + err.message, "error");
      } finally {
        runBtns.forEach(btn => { btn.disabled = false; btn.textContent = "Run"; });
      }
    }

    async function bulkImportNewFromFeed() {
      const newItems = currentFeedProducts.filter(p => p.isNew && !p.alreadyImported);
      if (newItems.length === 0) {
        showToast("No new items to import", "error");
        return;
      }
      
      const pids = newItems.slice(0, 20).map(p => p.pid);
      const btn = document.querySelector('button[onclick="bulkImportNewFromFeed()"]');
      if (btn) { btn.disabled = true; btn.textContent = "Importing..."; }
      
      try {
        showToast(`Importing ${pids.length} products...`);
        const data = await apiFetch("/api/admin/cj/feeds/bulk-import", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pids, feedId: currentFeedId, options: { markFeatured: true } })
        });
        
        let msg = `Imported: ${data.imported}, Skipped: ${data.skipped}, Failed: ${data.failed}`;
        if (data.truncated) msg += ` (limited to 20 of ${data.originalCount})`;
        showToast(msg);
        if (currentFeedId) runFeed(currentFeedId);
      } catch (err) {
        showToast("Bulk import failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "Import All NEW"; }
      }
    }

    async function markAllSeen() {
      const pids = currentFeedProducts.map(p => p.pid);
      if (pids.length === 0) return;
      if (!currentFeedId) {
        showToast("No feed selected", "error");
        return;
      }
      
      const btn = document.querySelector('button[onclick="markAllSeen()"]');
      if (btn) { btn.disabled = true; btn.textContent = "Marking..."; }
      
      try {
        await apiFetch("/api/admin/cj/feeds/mark-seen", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pids, feedId: currentFeedId })
        });
        showToast("All marked as seen");
        if (currentFeedId) runFeed(currentFeedId);
      } catch (err) {
        showToast("Failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "Mark All Seen"; }
      }
    }

    function closeFeedResults() {
      document.getElementById("feedResults").style.display = "none";
      currentFeedProducts = [];
      currentFeedId = null;
    }

    // Load feeds on tab switch
    const origSwitchTab = switchTab;
    switchTab = function(tab) {
      origSwitchTab(tab);
      if (tab === 'cjfeeds') loadFeeds();
      if (tab === 'cleanup') loadCleanupStats();
    };

    // ============ CLEANUP TAB ============
    let cleanupScanResults = [];
    let cleanupSelectedIds = new Set();
    let quarantinedProducts = [];
    let quarantinedSelectedIds = new Set();

    async function loadCleanupStats() {
      try {
        const [quarantined, products] = await Promise.all([
          apiFetch("/api/admin/cleanup/quarantined"),
          apiFetch("/api/admin/products?limit=10000")
        ]);
        
        document.getElementById("cleanupQuarantinedCount").textContent = quarantined.products?.length || 0;
        document.getElementById("cleanupActiveCount").textContent = products.products?.filter(p => p.active && !p.quarantined).length || 0;
      } catch (err) {
        console.error("Failed to load cleanup stats:", err);
      }
    }

    async function scanForIneligible() {
      const btn = document.querySelector('button[onclick="scanForIneligible()"]');
      if (btn) { btn.disabled = true; btn.textContent = "Scanning..."; }
      
      try {
        const data = await apiFetch("/api/admin/cleanup/scan");
        cleanupScanResults = data.ineligible || [];
        cleanupSelectedIds.clear();
        
        document.getElementById("cleanupIneligibleCount").textContent = cleanupScanResults.length;
        
        if (cleanupScanResults.length === 0) {
          showToast("No ineligible products found!");
          document.getElementById("cleanupScanResults").style.display = "none";
          return;
        }
        
        renderCleanupScanTable();
        document.getElementById("cleanupScanResults").style.display = "block";
        showToast(`Found ${cleanupScanResults.length} ineligible products`);
      } catch (err) {
        showToast("Scan failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "üîç Scan Catalog"; }
      }
    }

    function renderCleanupScanTable() {
      const container = document.getElementById("cleanupScanTable");
      
      if (cleanupScanResults.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #aaa; padding: 20px;">No ineligible products found</div>';
        return;
      }
      
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" onchange="toggleAllCleanupSelection(this.checked)" /></th>
              <th>Image</th>
              <th>Title</th>
              <th>Score</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody>
            ${cleanupScanResults.map(p => `
              <tr>
                <td><input type="checkbox" ${cleanupSelectedIds.has(p.id) ? 'checked' : ''} onchange="toggleCleanupSelection('${p.id}')" /></td>
                <td><img src="${p.image || '/placeholder.svg'}" class="product-thumb" onerror="this.src='/placeholder.svg'" /></td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${(p.title || 'Untitled').substring(0, 60)}</td>
                <td style="color: ${(p._eligibility?.score || 0) < 0 ? '#ff6b6b' : '#ffa500'};">${p._eligibility?.score || 0}</td>
                <td style="font-size: 10px; color: #aaa; max-width: 200px; overflow: hidden;">${p._eligibility?.denyReason || 'Low score'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      updateCleanupBulkActions();
    }

    function toggleCleanupSelection(id) {
      if (cleanupSelectedIds.has(id)) {
        cleanupSelectedIds.delete(id);
      } else {
        cleanupSelectedIds.add(id);
      }
      updateCleanupBulkActions();
    }

    function toggleAllCleanupSelection(checked) {
      if (checked) {
        cleanupScanResults.forEach(p => cleanupSelectedIds.add(p.id));
      } else {
        cleanupSelectedIds.clear();
      }
      renderCleanupScanTable();
    }

    function updateCleanupBulkActions() {
      const bulkActions = document.getElementById("cleanupBulkActions");
      const count = cleanupSelectedIds.size;
      document.getElementById("cleanupSelectedCount").textContent = count;
      bulkActions.classList.toggle("hidden", count === 0);
    }

    function clearCleanupSelection() {
      cleanupSelectedIds.clear();
      renderCleanupScanTable();
    }

    async function quarantineSelected() {
      if (cleanupSelectedIds.size === 0) {
        showToast("No products selected", "error");
        return;
      }
      
      if (!confirm(`Quarantine ${cleanupSelectedIds.size} products?`)) return;
      
      try {
        const data = await apiFetch("/api/admin/cleanup/quarantine", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productIds: Array.from(cleanupSelectedIds) })
        });
        
        showToast(`Quarantined ${data.quarantined} products`);
        cleanupScanResults = cleanupScanResults.filter(p => !cleanupSelectedIds.has(p.id));
        cleanupSelectedIds.clear();
        renderCleanupScanTable();
        loadCleanupStats();
      } catch (err) {
        showToast("Quarantine failed: " + err.message, "error");
      }
    }

    async function quarantineAll() {
      if (cleanupScanResults.length === 0) {
        showToast("No products to quarantine", "error");
        return;
      }
      
      if (!confirm(`Quarantine ALL ${cleanupScanResults.length} ineligible products?`)) return;
      
      try {
        const ids = cleanupScanResults.map(p => p.id);
        const data = await apiFetch("/api/admin/cleanup/quarantine", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productIds: ids })
        });
        
        showToast(`Quarantined ${data.quarantined} products`);
        cleanupScanResults = [];
        cleanupSelectedIds.clear();
        renderCleanupScanTable();
        document.getElementById("cleanupScanResults").style.display = "none";
        loadCleanupStats();
      } catch (err) {
        showToast("Quarantine failed: " + err.message, "error");
      }
    }

    async function loadQuarantined() {
      try {
        const data = await apiFetch("/api/admin/cleanup/quarantined");
        quarantinedProducts = data.products || [];
        quarantinedSelectedIds.clear();
        
        if (quarantinedProducts.length === 0) {
          showToast("No quarantined products");
          document.getElementById("cleanupQuarantinedSection").style.display = "none";
          return;
        }
        
        renderQuarantinedTable();
        document.getElementById("cleanupQuarantinedSection").style.display = "block";
      } catch (err) {
        showToast("Failed to load quarantined: " + err.message, "error");
      }
    }

    function renderQuarantinedTable() {
      const container = document.getElementById("quarantinedTable");
      
      if (quarantinedProducts.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #aaa; padding: 20px;">No quarantined products</div>';
        return;
      }
      
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" onchange="toggleAllQuarantinedSelection(this.checked)" /></th>
              <th>Image</th>
              <th>Title</th>
              <th>Reason</th>
              <th>Quarantined At</th>
            </tr>
          </thead>
          <tbody>
            ${quarantinedProducts.map(p => `
              <tr>
                <td><input type="checkbox" ${quarantinedSelectedIds.has(p.id) ? 'checked' : ''} onchange="toggleQuarantinedSelection('${p.id}')" /></td>
                <td><img src="${p.image || '/placeholder.svg'}" class="product-thumb" onerror="this.src='/placeholder.svg'" /></td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${(p.title || 'Untitled').substring(0, 60)}</td>
                <td style="font-size: 10px; color: #aaa; max-width: 200px;">${p.quarantineReason || 'Manual'}</td>
                <td style="font-size: 10px; color: #aaa;">${p.quarantinedAt ? new Date(p.quarantinedAt).toLocaleDateString() : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      updateQuarantinedBulkActions();
    }

    function toggleQuarantinedSelection(id) {
      if (quarantinedSelectedIds.has(id)) {
        quarantinedSelectedIds.delete(id);
      } else {
        quarantinedSelectedIds.add(id);
      }
      updateQuarantinedBulkActions();
    }

    function toggleAllQuarantinedSelection(checked) {
      if (checked) {
        quarantinedProducts.forEach(p => quarantinedSelectedIds.add(p.id));
      } else {
        quarantinedSelectedIds.clear();
      }
      renderQuarantinedTable();
    }

    function updateQuarantinedBulkActions() {
      const bulkActions = document.getElementById("quarantinedBulkActions");
      const count = quarantinedSelectedIds.size;
      document.getElementById("quarantinedSelectedCount").textContent = count;
      bulkActions.classList.toggle("hidden", count === 0);
    }

    function clearQuarantinedSelection() {
      quarantinedSelectedIds.clear();
      renderQuarantinedTable();
    }

    async function undoQuarantineSelected() {
      if (quarantinedSelectedIds.size === 0) {
        showToast("No products selected", "error");
        return;
      }
      
      if (!confirm(`Restore ${quarantinedSelectedIds.size} products from quarantine?`)) return;
      
      try {
        const data = await apiFetch("/api/admin/cleanup/undo", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productIds: Array.from(quarantinedSelectedIds) })
        });
        
        showToast(`Restored ${data.restored} products`);
        loadQuarantined();
        loadCleanupStats();
      } catch (err) {
        showToast("Undo failed: " + err.message, "error");
      }
    }

    async function deleteQuarantinedSelected() {
      if (quarantinedSelectedIds.size === 0) {
        showToast("No products selected", "error");
        return;
      }
      
      if (!confirm(`PERMANENTLY DELETE ${quarantinedSelectedIds.size} quarantined products? This cannot be undone!`)) return;
      
      try {
        const data = await apiFetch("/api/admin/cleanup/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productIds: Array.from(quarantinedSelectedIds) })
        });
        
        showToast(`Deleted ${data.deleted} products`);
        loadQuarantined();
        loadCleanupStats();
      } catch (err) {
        showToast("Delete failed: " + err.message, "error");
      }
    }

    async function runCleanupValidation() {
      const btn = document.querySelector('button[onclick="runCleanupValidation()"]');
      if (btn) { btn.disabled = true; btn.textContent = "Running..."; }
      
      try {
        const data = await apiFetch("/api/admin/cleanup/validate");
        const results = data.results || [];
        
        const container = document.getElementById("validationResultsContent");
        container.innerHTML = `
          <div style="margin-bottom: 15px; display: flex; gap: 20px;">
            <div style="background: #1a3a2a; padding: 10px 20px; border-radius: 6px;">
              <span style="color: #00C4A7; font-weight: 600;">${data.passed || 0}</span>
              <span style="color: #aaa; font-size: 12px;"> Passed</span>
            </div>
            <div style="background: #3a1a1a; padding: 10px 20px; border-radius: 6px;">
              <span style="color: #ff6b6b; font-weight: 600;">${data.failed || 0}</span>
              <span style="color: #aaa; font-size: 12px;"> Failed</span>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>Expected</th>
                <th>Actual</th>
                <th>Score</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${results.map(r => `
                <tr>
                  <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${r.title}</td>
                  <td>${r.expected}</td>
                  <td>${r.actual}</td>
                  <td>${r.score}</td>
                  <td style="color: ${r.pass ? '#00C4A7' : '#ff6b6b'};">${r.pass ? '‚úì PASS' : '‚úó FAIL'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        
        document.getElementById("cleanupValidationResults").style.display = "block";
        showToast(`Validation: ${data.passed}/${data.total} passed`);
      } catch (err) {
        showToast("Validation failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "‚úÖ Run Validation Tests"; }
      }
    }

    // ============ INBOX FUNCTIONS ============
    let inboxMessages = [];
    let currentInboxMessage = null;

    async function loadInboxMessages() {
      const status = document.getElementById("inboxStatusFilter").value;
      const url = status ? `/api/admin/contact-messages?status=${status}` : '/api/admin/contact-messages';
      
      try {
        const data = await apiFetch(url);
        inboxMessages = data.messages || [];
        
        const unreadCount = inboxMessages.filter(m => m.status === 'unread').length;
        document.getElementById("inboxUnreadCount").textContent = unreadCount;
        document.getElementById("inboxTotalCount").textContent = data.total || inboxMessages.length;
        
        const badge = document.getElementById("inboxBadge");
        if (unreadCount > 0) {
          badge.textContent = unreadCount;
          badge.style.display = "inline";
        } else {
          badge.style.display = "none";
        }
        
        renderInboxTable();
      } catch (err) {
        document.getElementById("inboxTable").innerHTML = `<div class="error-msg">Failed to load messages: ${err.message}</div>`;
      }
    }

    function renderInboxTable() {
      const container = document.getElementById("inboxTable");
      
      if (inboxMessages.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #aaa; padding: 40px;">No messages yet</div>';
        return;
      }
      
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Status</th>
              <th>From</th>
              <th>Subject</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${inboxMessages.map(m => `
              <tr style="${m.status === 'unread' ? 'background: #1a2a2e;' : ''}">
                <td><span class="status-badge ${m.status === 'unread' ? 'status-warning' : m.status === 'replied' ? 'status-active' : 'status-inactive'}">${m.status}</span></td>
                <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
                  <div style="font-weight: 600;">${escapeHtml(m.name)}</div>
                  <div style="font-size: 10px; color: #aaa;">${escapeHtml(m.email)}</div>
                </td>
                <td style="cursor: pointer; color: #00C4A7;" onclick="openInboxMessage('${escapeAttr(m.id)}')">${getSubjectLabel(m.subject)}</td>
                <td style="font-size: 11px; color: #aaa;">${new Date(m.createdAt).toLocaleDateString()}</td>
                <td>
                  <button class="btn btn-sm" onclick="openInboxMessage('${escapeAttr(m.id)}')">View</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteInboxMessage('${escapeAttr(m.id)}')">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function getSubjectLabel(subject) {
      const labels = { order: 'Order Question', product: 'Product Inquiry', return: 'Return/Refund', shipping: 'Shipping Issue', feedback: 'Feedback', other: 'Other' };
      return labels[subject] || escapeHtml(subject);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
    
    function escapeAttr(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function openInboxMessage(id) {
      const msg = inboxMessages.find(m => m.id === id);
      if (!msg) return;
      
      currentInboxMessage = msg;
      
      if (msg.status === 'unread') {
        await apiFetch(`/api/admin/contact-messages/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'read' })
        });
        msg.status = 'read';
        loadInboxMessages();
      }
      
      document.getElementById("inboxDrawerBody").innerHTML = `
        <div class="drawer-field">
          <label>From</label>
          <div class="drawer-field-value">${escapeHtml(msg.name)} &lt;${escapeHtml(msg.email)}&gt;</div>
        </div>
        <div class="drawer-field">
          <label>Subject</label>
          <div class="drawer-field-value">${getSubjectLabel(msg.subject)}</div>
        </div>
        ${msg.orderNumber ? `
          <div class="drawer-field">
            <label>Order Number</label>
            <div class="drawer-field-value">${escapeHtml(msg.orderNumber)}</div>
          </div>
        ` : ''}
        <div class="drawer-field">
          <label>Date</label>
          <div class="drawer-field-value">${new Date(msg.createdAt).toLocaleString()}</div>
        </div>
        <div class="drawer-field">
          <label>Message</label>
          <div class="drawer-field-value" style="background: #262643; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(msg.message)}</div>
        </div>
        <div class="drawer-field" style="margin-top: 20px;">
          <label>Admin Notes</label>
          <textarea id="inboxNotes" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; min-height: 80px;">${escapeHtml(msg.adminNotes || '')}</textarea>
        </div>
        <div class="drawer-actions">
          <select id="inboxStatusSelect" style="padding: 8px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;">
            <option value="read" ${msg.status === 'read' ? 'selected' : ''}>Read</option>
            <option value="replied" ${msg.status === 'replied' ? 'selected' : ''}>Replied</option>
            <option value="archived" ${msg.status === 'archived' ? 'selected' : ''}>Archived</option>
          </select>
          <button class="btn" onclick="updateInboxMessage('${id}')">Save</button>
          <a href="mailto:${msg.email}?subject=Re: ${getSubjectLabel(msg.subject)}" class="btn btn-secondary">Reply via Email</a>
        </div>
      `;
      
      document.getElementById("inboxDrawerOverlay").classList.add("active");
      document.getElementById("inboxDrawer").classList.add("active");
    }

    function closeInboxDrawer() {
      document.getElementById("inboxDrawerOverlay").classList.remove("active");
      document.getElementById("inboxDrawer").classList.remove("active");
      currentInboxMessage = null;
    }

    async function updateInboxMessage(id) {
      const status = document.getElementById("inboxStatusSelect").value;
      const adminNotes = document.getElementById("inboxNotes").value;
      
      try {
        await apiFetch(`/api/admin/contact-messages/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status, adminNotes })
        });
        showToast("Message updated");
        closeInboxDrawer();
        loadInboxMessages();
      } catch (err) {
        showToast("Update failed: " + err.message, "error");
      }
    }

    async function deleteInboxMessage(id) {
      if (!confirm("Delete this message?")) return;
      
      try {
        await apiFetch(`/api/admin/contact-messages/${id}`, { method: 'DELETE' });
        showToast("Message deleted");
        loadInboxMessages();
      } catch (err) {
        showToast("Delete failed: " + err.message, "error");
      }
    }

    // ========== REVIEWS MANAGEMENT ==========
    let adminReviews = [];
    let currentReview = null;

    function escapeAttrReview(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function renderStarsAdmin(rating) {
      let stars = '';
      for (let i = 1; i <= 5; i++) {
        stars += i <= rating ? '‚òÖ' : '‚òÜ';
      }
      return stars;
    }

    async function loadAdminReviews() {
      const status = document.getElementById("reviewsStatusFilter").value;
      const url = status ? `/api/admin/reviews?status=${status}` : '/api/admin/reviews';
      
      try {
        const data = await apiFetch(url);
        adminReviews = data.reviews || [];
        
        document.getElementById("reviewsPendingCount").textContent = data.stats?.pending || 0;
        document.getElementById("reviewsApprovedCount").textContent = data.stats?.approved || 0;
        document.getElementById("reviewsRejectedCount").textContent = data.stats?.rejected || 0;
        
        const badge = document.getElementById("reviewsBadge");
        if (data.stats?.pending > 0) {
          badge.textContent = data.stats.pending;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
        
        renderReviewsTable();
      } catch (err) {
        document.getElementById("reviewsTable").innerHTML = `<div class="error-msg">Failed to load reviews: ${err.message}</div>`;
      }
    }

    function renderReviewsTable() {
      const container = document.getElementById("reviewsTable");
      
      if (adminReviews.length === 0) {
        container.innerHTML = `<div class="empty-state"><p>No reviews found</p></div>`;
        return;
      }
      
      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Product ID</th>
              <th>Author</th>
              <th>Rating</th>
              <th>Title</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${adminReviews.map(r => `
              <tr>
                <td>${new Date(r.createdAt).toLocaleDateString()}</td>
                <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(r.productId)}</td>
                <td>${escapeHtml(r.name)}</td>
                <td style="color: #ffc107;">${renderStarsAdmin(r.rating)}</td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; cursor: pointer; color: #00C4A7;" onclick="openReviewDrawer('${escapeAttrReview(r.id)}')">${escapeHtml(r.title)}</td>
                <td>
                  <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; background: ${r.status === 'pending' ? '#ffc107' : r.status === 'approved' ? '#00C4A7' : '#ff6b6b'}; color: ${r.status === 'pending' ? '#1a1a2e' : '#fff'};">${r.status}</span>
                </td>
                <td>
                  ${r.status === 'pending' ? `
                    <button class="btn btn-sm" style="background: #00C4A7; margin-right: 4px;" onclick="updateReviewStatus('${escapeAttrReview(r.id)}', 'approved')">Approve</button>
                    <button class="btn btn-sm btn-danger" onclick="updateReviewStatus('${escapeAttrReview(r.id)}', 'rejected')">Reject</button>
                  ` : `
                    <button class="btn btn-sm" onclick="openReviewDrawer('${escapeAttrReview(r.id)}')">View</button>
                  `}
                  <button class="btn btn-sm btn-danger" onclick="deleteAdminReview('${escapeAttrReview(r.id)}')">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function updateReviewStatus(id, status) {
      try {
        await apiFetch(`/api/admin/reviews/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        showToast(`Review ${status}`);
        loadAdminReviews();
      } catch (err) {
        showToast("Update failed: " + err.message, "error");
      }
    }

    async function openReviewDrawer(id) {
      const review = adminReviews.find(r => r.id === id);
      if (!review) return;
      
      currentReview = review;
      
      document.getElementById("reviewsDrawerBody").innerHTML = `
        <div class="drawer-field">
          <label>Product ID</label>
          <div class="drawer-field-value">${escapeHtml(review.productId)}</div>
        </div>
        <div class="drawer-field">
          <label>Author</label>
          <div class="drawer-field-value">${escapeHtml(review.name)} &lt;${escapeHtml(review.email)}&gt;</div>
        </div>
        <div class="drawer-field">
          <label>Rating</label>
          <div class="drawer-field-value" style="color: #ffc107; font-size: 18px;">${renderStarsAdmin(review.rating)} (${review.rating}/5)</div>
        </div>
        <div class="drawer-field">
          <label>Date</label>
          <div class="drawer-field-value">${new Date(review.createdAt).toLocaleString()}</div>
        </div>
        <div class="drawer-field">
          <label>Title</label>
          <div class="drawer-field-value" style="font-weight: 600;">${escapeHtml(review.title)}</div>
        </div>
        <div class="drawer-field">
          <label>Review</label>
          <div class="drawer-field-value" style="background: #262643; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(review.text)}</div>
        </div>
        <div class="drawer-field" style="margin-top: 20px;">
          <label>Admin Notes</label>
          <textarea id="reviewNotes" style="width: 100%; padding: 10px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff; min-height: 80px;">${escapeHtml(review.adminNotes || '')}</textarea>
        </div>
        <div class="drawer-actions">
          <select id="reviewStatusSelect" style="padding: 8px; background: #262643; border: 1px solid #333; border-radius: 4px; color: #fff;">
            <option value="pending" ${review.status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="approved" ${review.status === 'approved' ? 'selected' : ''}>Approved</option>
            <option value="rejected" ${review.status === 'rejected' ? 'selected' : ''}>Rejected</option>
          </select>
          <button class="btn" onclick="saveReviewChanges('${id}')">Save</button>
        </div>
      `;
      
      document.getElementById("reviewsDrawerOverlay").classList.add("active");
      document.getElementById("reviewsDrawer").classList.add("active");
    }

    function closeReviewsDrawer() {
      document.getElementById("reviewsDrawerOverlay").classList.remove("active");
      document.getElementById("reviewsDrawer").classList.remove("active");
      currentReview = null;
    }

    async function saveReviewChanges(id) {
      const status = document.getElementById("reviewStatusSelect").value;
      const adminNotes = document.getElementById("reviewNotes").value;
      
      try {
        await apiFetch(`/api/admin/reviews/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status, adminNotes })
        });
        showToast("Review updated");
        closeReviewsDrawer();
        loadAdminReviews();
      } catch (err) {
        showToast("Update failed: " + err.message, "error");
      }
    }

    async function deleteAdminReview(id) {
      if (!confirm("Delete this review?")) return;
      
      try {
        await apiFetch(`/api/admin/reviews/${id}`, { method: 'DELETE' });
        showToast("Review deleted");
        loadAdminReviews();
      } catch (err) {
        showToast("Delete failed: " + err.message, "error");
      }
    }

    // ========== BACKUP FUNCTIONS ==========
    async function loadBackups() {
      const listEl = document.getElementById('backupsList');
      const lastTimeEl = document.getElementById('lastBackupTime');
      
      try {
        listEl.innerHTML = '<div class="loading">Loading backups...</div>';
        const data = await apiFetch('/api/admin/backups');
        
        if (data.lastBackupAt) {
          lastTimeEl.textContent = 'Last backup: ' + new Date(data.lastBackupAt).toLocaleString();
        }
        
        if (!data.backups || data.backups.length === 0) {
          listEl.innerHTML = '<p style="color: #aaa;">No backups found. Create one to get started.</p>';
          return;
        }
        
        listEl.innerHTML = `
          <table style="width: 100%;">
            <thead>
              <tr>
                <th>Filename</th>
                <th>Size</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.backups.map(b => `
                <tr>
                  <td style="font-family: monospace; font-size: 11px;">${b.filename}</td>
                  <td>${b.sizeFormatted}</td>
                  <td>${new Date(b.createdAt).toLocaleString()}</td>
                  <td>
                    <button class="btn btn-sm btn-secondary" onclick="restoreBackup('${b.filename}')">Restore</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        listEl.innerHTML = `<div class="error-msg">Failed to load backups: ${err.message}</div>`;
      }
    }
    
    async function createManualBackup() {
      const resultEl = document.getElementById('backupResult');
      
      try {
        resultEl.innerHTML = '<span style="color: #aaa;">Creating backup...</span>';
        const data = await apiFetch('/api/admin/backups/create', { method: 'POST' });
        
        if (data.success) {
          resultEl.innerHTML = `<div class="success-msg">Backup created: ${data.filename}</div>`;
          loadBackups();
        } else {
          resultEl.innerHTML = `<div class="error-msg">Failed: ${data.error}</div>`;
        }
      } catch (err) {
        resultEl.innerHTML = `<div class="error-msg">Error: ${err.message}</div>`;
      }
    }
    
    async function restoreBackup(filename) {
      if (!confirm(`Are you sure you want to restore from "${filename}"?\n\nThis will replace your current catalog with the backup. A new backup of the current state will be created first.`)) {
        return;
      }
      
      const listEl = document.getElementById('backupsList');
      
      try {
        const data = await apiFetch('/api/admin/backups/restore', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename })
        });
        
        if (data.success) {
          showToast(`Restored ${data.productCount} products from backup`);
          loadBackups();
        } else {
          showToast('Restore failed: ' + data.error, 'error');
        }
      } catch (err) {
        showToast('Restore error: ' + err.message, 'error');
      }
    }
    // ========== END BACKUP FUNCTIONS ==========

    async function loadSettings() {
      try {
        const data = await apiFetch('/api/admin/settings-status');
        
        const checklistItems = [
          { key: 'stripe', label: 'Stripe payment gateway configured', description: 'STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET are set' },
          { key: 'cj', label: 'CJ Dropshipping connected', description: 'CJ API credentials configured and authenticated' },
          { key: 'email', label: 'Email notifications configured', description: 'MAIL_USER and MAIL_PASS are set' },
          { key: 'openai', label: 'AI assistant configured', description: 'OpenAI API key is set for product recommendations' },
          { key: 'products', label: 'Products imported', description: 'At least 10 active products in catalog' },
          { key: 'legal', label: 'Legal pages created', description: 'Privacy, Terms, Returns, Shipping pages exist' }
        ];
        
        let completed = 0;
        const total = checklistItems.length;
        
        const checklistHtml = checklistItems.map(item => {
          const ok = data[item.key];
          if (ok) completed++;
          return `
            <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: ${ok ? 'rgba(0,196,167,0.1)' : 'rgba(255,107,107,0.1)'}; border-radius: 8px; border: 1px solid ${ok ? 'rgba(0,196,167,0.2)' : 'rgba(255,107,107,0.2)'};">
              <div style="width: 24px; height: 24px; border-radius: 50%; background: ${ok ? '#00C4A7' : '#ff6b6b'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <span style="color: #fff; font-size: 14px;">${ok ? '‚úì' : '!'}</span>
              </div>
              <div>
                <div style="font-weight: 600; color: ${ok ? '#00C4A7' : '#ff6b6b'};">${item.label}</div>
                <div style="font-size: 12px; color: #888; margin-top: 2px;">${item.description}</div>
              </div>
            </div>
          `;
        }).join('');
        
        document.getElementById('goLiveChecklist').innerHTML = checklistHtml;
        
        const percent = Math.round((completed / total) * 100);
        document.getElementById('goLivePercent').textContent = percent + '%';
        document.getElementById('goLiveBar').style.width = percent + '%';
        document.getElementById('goLiveBar').style.background = percent === 100 ? '#00C4A7' : percent >= 50 ? '#ffc107' : '#ff6b6b';
        
        document.getElementById('stripeSettings').innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Stripe Secret Key</span>
              <span style="color: ${data.stripe_secret ? '#00C4A7' : '#ff6b6b'}; font-weight: 600;">${data.stripe_secret ? '‚úì Configured' : '‚úó Not set'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Stripe Webhook Secret</span>
              <span style="color: ${data.stripe_webhook ? '#00C4A7' : '#ff6b6b'}; font-weight: 600;">${data.stripe_webhook ? '‚úì Configured' : '‚úó Not set'}</span>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
              Set these in your environment secrets to enable Stripe payments.
            </div>
          </div>
        `;
        
        document.getElementById('cjSettings').innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">CJ API Key</span>
              <span style="color: ${data.cj_api ? '#00C4A7' : '#ff6b6b'}; font-weight: 600;">${data.cj_api ? '‚úì Configured' : '‚úó Not set'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">CJ Email</span>
              <span style="color: ${data.cj_email ? '#00C4A7' : '#ff6b6b'}; font-weight: 600;">${data.cj_email ? '‚úì Configured' : '‚úó Not set'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">CJ Authentication</span>
              <span style="color: ${data.cj_token ? '#00C4A7' : '#ff6b6b'}; font-weight: 600;">${data.cj_token ? '‚úì Token active' : '‚úó Not authenticated'}</span>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
              CJ Dropshipping API is used for product sourcing and order fulfillment.
            </div>
          </div>
        `;
        
        document.getElementById('emailSettings').innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Mail User</span>
              <span style="color: ${data.mail_user ? '#00C4A7' : '#ff6b6b'}; font-weight: 600;">${data.mail_user ? '‚úì Configured' : '‚úó Not set'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Mail Password</span>
              <span style="color: ${data.mail_pass ? '#00C4A7' : '#ff6b6b'}; font-weight: 600;">${data.mail_pass ? '‚úì Configured' : '‚úó Not set'}</span>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
              Email is used for order confirmations and customer notifications.
            </div>
          </div>
        `;
        
        document.getElementById('openaiSettings').innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">OpenAI API Key</span>
              <span style="color: ${data.openai ? '#00C4A7' : '#ff6b6b'}; font-weight: 600;">${data.openai ? '‚úì Configured' : '‚úó Not set'}</span>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
              OpenAI powers the Pawsy AI assistant for product recommendations.
            </div>
          </div>
        `;
        
        const lookerUrl = data.looker_url || '';
        document.getElementById('analyticsSettings').innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Google Analytics 4</span>
              <span style="color: ${data.ga4 ? '#00C4A7' : '#888'}; font-weight: 600;">${data.ga4 ? '‚úì ' + data.ga4_id : '‚óã Not configured'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Meta Pixel</span>
              <span style="color: ${data.meta_pixel ? '#00C4A7' : '#888'}; font-weight: 600;">${data.meta_pixel ? '‚úì ' + data.meta_pixel_id : '‚óã Not configured'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Looker Studio Dashboard</span>
              <span style="color: ${lookerUrl ? '#00C4A7' : '#888'}; font-weight: 600;">${lookerUrl ? '‚úì Configured' : '‚óã Not set'}</span>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
              Set GA4_MEASUREMENT_ID, META_PIXEL_ID, and LOOKER_STUDIO_REPORT_URL in environment secrets. Analytics only load after visitor consent.
            </div>
            ${data.ga4 ? `<a href="https://analytics.google.com" target="_blank" class="btn" style="margin-top: 8px; display: inline-block; text-align: center;">Open Google Analytics</a>` : ''}
            ${lookerUrl ? `
              <div style="margin-top: 16px; border-radius: 8px; overflow: hidden; background: #0f0f1e;">
                <iframe src="${lookerUrl}" style="width: 100%; height: 600px; border: none; display: block;"></iframe>
              </div>
            ` : `
              <div style="margin-top: 16px; padding: 20px; background: #0f0f1e; border-radius: 8px; border: 1px dashed #444;">
                <h4 style="color: #fff; margin-bottom: 12px;">Embed Your Analytics Dashboard</h4>
                <p style="color: #aaa; font-size: 13px; margin-bottom: 12px;">
                  Create a dashboard in <a href="https://lookerstudio.google.com" target="_blank" style="color: #00C4A7;">Looker Studio</a>, connect your GA4 property, and paste the embed URL in secrets as LOOKER_STUDIO_REPORT_URL.
                </p>
              </div>
            `}
          </div>
        `;
        
        loadBuildInfo();
        
      } catch (err) {
        document.getElementById('goLiveChecklist').innerHTML = `<div class="error-msg">Failed to load settings: ${err.message}</div>`;
      }
    }

    async function runMigration() {
      const btn = document.getElementById('migrateBtn');
      const result = document.getElementById('systemToolsResult');
      btn.disabled = true;
      btn.textContent = '‚è≥ Running...';
      result.innerHTML = '<div style="color: #aaa;">Migrating product data...</div>';
      
      try {
        const res = await apiFetch('/api/admin/migrate-products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        result.innerHTML = `
          <div class="success-msg">
            <strong>Migration Complete</strong><br>
            Processed: ${res.processed || 0} products<br>
            Updated: ${res.updated || 0} products
          </div>
        `;
        showToast('Migration completed successfully', 'success');
      } catch (err) {
        result.innerHTML = `<div class="error-msg">Migration failed: ${err.message}</div>`;
        showToast('Migration failed', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Migrate Products';
      }
    }

    async function runReindex() {
      const btn = document.getElementById('reindexBtn');
      const result = document.getElementById('systemToolsResult');
      btn.disabled = true;
      btn.textContent = '‚è≥ Rebuilding...';
      result.innerHTML = '<div style="color: #aaa;">Rebuilding AI search index (this may take a few minutes)...</div>';
      
      try {
        const res = await apiFetch('/api/admin/ai/reindex/full', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        result.innerHTML = `
          <div class="success-msg">
            <strong>AI Reindex Started</strong><br>
            Job ID: ${res.jobId || 'N/A'}<br>
            ${res.message || 'Index rebuild in progress'}
          </div>
        `;
        showToast('AI reindex started', 'success');
      } catch (err) {
        result.innerHTML = `<div class="error-msg">Reindex failed: ${err.message}</div>`;
        showToast('Reindex failed', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üß† Rebuild AI Index';
      }
    }

    function forceClientRefresh() {
      if (confirm('This will clear all browser caches and reload. Continue?')) {
        try {
          localStorage.clear();
          sessionStorage.clear();
          if ('caches' in window) {
            caches.keys().then(function(keys) {
              keys.forEach(function(key) {
                caches.delete(key);
              });
            });
          }
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(regs) {
              regs.forEach(function(r) { r.unregister(); });
            });
          }
          showToast('Cache cleared! Reloading...', 'success');
          setTimeout(() => {
            window.location.reload(true);
          }, 500);
        } catch (e) {
          window.location.reload(true);
        }
      }
    }

    async function loadBuildInfo() {
      try {
        const res = await fetch('/api/version');
        const data = await res.json();
        document.getElementById('buildInfo').innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Build ID</span>
              <span style="color: #00C4A7; font-weight: 600; font-family: monospace;">${data.build_id || data.buildId || 'N/A'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Built At</span>
              <span style="color: #fff; font-family: monospace;">${data.built_at || data.builtAt || 'N/A'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Git Commit</span>
              <span style="color: #fff; font-family: monospace;">${data.commit || 'N/A'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Environment</span>
              <span style="color: #fff;">${data.slug || 'N/A'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #262643; border-radius: 6px;">
              <span style="color: #aaa;">Node Version</span>
              <span style="color: #fff;">${data.node_version || 'N/A'}</span>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
              Compare this Build ID with the one shown in the storefront footer to verify deployment is current.
            </div>
          </div>
        `;
      } catch (err) {
        document.getElementById('buildInfo').innerHTML = `<div class="error-msg">Failed to load build info: ${err.message}</div>`;
      }
    }

    // Wait for DOM before initializing admin (prevents redirect loop)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAdmin);
    } else {
      initAdmin();
    }

    // ============================================
    // Image Audit Tab Functions
    // ============================================
    
    let iaPollingInterval = null;

    async function loadImageAuditStats() {
      try {
        const res = await apiFetch('/api/admin/image-audit/stats');
        const stats = await res.json();
        document.getElementById('iaTotal').textContent = stats.total || 0;
        document.getElementById('iaWithText').textContent = stats.with_text || 0;
        document.getElementById('iaInfographics').textContent = stats.infographics || 0;
        document.getElementById('iaProducts').textContent = stats.products_audited || 0;
      } catch (err) {
        console.error('Failed to load image audit stats:', err);
      }
    }

    async function startImageAudit(onlyNew = false) {
      try {
        document.getElementById('imageAuditProgress').style.display = 'block';
        document.getElementById('iaProgressText').textContent = 'Starting audit...';
        document.getElementById('iaProgressBar').style.width = '0%';
        
        apiFetch('/api/admin/image-audit/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ onlyNew })
        });
        
        iaPollingInterval = setInterval(pollImageAuditProgress, 2000);
      } catch (err) {
        alert('Failed to start audit: ' + err.message);
      }
    }

    async function pollImageAuditProgress() {
      try {
        const res = await apiFetch('/api/admin/image-audit/progress');
        const progress = await res.json();
        
        if (progress.status === 'running') {
          const pct = progress.total > 0 ? Math.round((progress.processed / progress.total) * 100) : 0;
          document.getElementById('iaProgressBar').style.width = pct + '%';
          document.getElementById('iaProgressText').textContent = `Processing ${progress.processed} of ${progress.total} products (${pct}%)`;
          document.getElementById('iaProgressDetails').textContent = progress.currentProduct ? `Current: ${progress.currentProduct}` : '';
        } else if (progress.status === 'completed' || progress.status === 'failed' || progress.status === 'cancelled') {
          clearInterval(iaPollingInterval);
          iaPollingInterval = null;
          document.getElementById('iaProgressText').textContent = `Audit ${progress.status}. Processed ${progress.processed} products.`;
          document.getElementById('iaProgressBar').style.width = '100%';
          loadImageAuditStats();
        }
      } catch (err) {
        console.error('Progress poll error:', err);
      }
    }

    async function cancelImageAudit() {
      try {
        await apiFetch('/api/admin/image-audit/cancel', { method: 'POST' });
        if (iaPollingInterval) {
          clearInterval(iaPollingInterval);
          iaPollingInterval = null;
        }
        document.getElementById('iaProgressText').textContent = 'Audit cancelled';
      } catch (err) {
        console.error('Cancel error:', err);
      }
    }

    async function auditSingleProduct() {
      const productId = document.getElementById('iaSingleProductId').value.trim();
      if (!productId) {
        alert('Please enter a product ID');
        return;
      }
      
      const resultDiv = document.getElementById('iaSingleResult');
      resultDiv.innerHTML = '<div class="loading">Auditing images...</div>';
      
      try {
        const res = await apiFetch(`/api/admin/image-audit/product/${productId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.error) {
          resultDiv.innerHTML = `<div class="error-msg">${data.error}</div>`;
          return;
        }
        
        const results = data.results || [];
        if (results.length === 0) {
          resultDiv.innerHTML = '<div class="success-msg">No HTTP images found for this product.</div>';
          return;
        }
        
        resultDiv.innerHTML = `
          <div class="success-msg">Audited ${results.length} images</div>
          <table style="margin-top: 10px;">
            <tr><th>Image</th><th>Has Text</th><th>Language</th><th>Infographic</th></tr>
            ${results.map(r => `
              <tr>
                <td><img src="${r.url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" onerror="this.src='/images/placeholder.png'" /></td>
                <td>${r.hasText ? '<span class="status-warning">Yes</span>' : '<span class="status-ok">No</span>'}</td>
                <td>${r.lang || '-'}</td>
                <td>${r.isInfographic ? '<span class="status-warning">Yes</span>' : '<span class="status-ok">No</span>'}</td>
              </tr>
            `).join('')}
          </table>
        `;
        loadImageAuditStats();
      } catch (err) {
        resultDiv.innerHTML = `<div class="error-msg">Error: ${err.message}</div>`;
      }
    }

    async function loadInfographics() {
      const lang = document.getElementById('iaLangFilter').value;
      const listDiv = document.getElementById('iaInfographicsList');
      listDiv.innerHTML = '<div class="loading">Loading infographics...</div>';
      
      try {
        const url = lang ? `/api/admin/image-audit/infographics?lang=${lang}` : '/api/admin/image-audit/infographics';
        const res = await apiFetch(url);
        const data = await res.json();
        
        if (!data.infographics || data.infographics.length === 0) {
          listDiv.innerHTML = '<div style="color: #aaa; padding: 20px; text-align: center;">No infographics found. Run an audit first.</div>';
          return;
        }
        
        listDiv.innerHTML = `
          <table>
            <tr><th>Image</th><th>Product</th><th>Language</th><th>OCR Text</th></tr>
            ${data.infographics.slice(0, 50).map(i => `
              <tr>
                <td><img src="${i.image_url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;" onerror="this.src='/images/placeholder.png'" /></td>
                <td><a href="/product/${i.product_id}" target="_blank" style="color: #00C4A7;">${i.product_id}</a></td>
                <td><span style="background: #262643; padding: 2px 8px; border-radius: 4px;">${i.detected_lang || '?'}</span></td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${(i.ocr_text || '').replace(/"/g, '&quot;')}">${(i.ocr_text || '').slice(0, 100)}</td>
              </tr>
            `).join('')}
          </table>
          ${data.infographics.length > 50 ? `<div style="color: #aaa; padding: 10px; text-align: center;">Showing 50 of ${data.infographics.length} infographics</div>` : ''}
        `;
      } catch (err) {
        listDiv.innerHTML = `<div class="error-msg">Error: ${err.message}</div>`;
      }
    }

    // ============================================
    // Google Ads Tab Functions
    // ============================================
    
    let adsPage = 1;
    let allThemes = [];
    let allAdsProducts = [];

    async function loadGoogleAdsTab() {
      await Promise.all([
        loadGoogleAdsStats(),
        loadThemesForSelect(),
        loadProductsForSelect(),
        loadGeneratedAds(),
        loadThemesTable()
      ]);
    }

    async function loadGoogleAdsStats() {
      try {
        const [adsRes, themesRes] = await Promise.all([
          apiFetch('/api/admin/ads'),
          apiFetch('/api/admin/themes')
        ]);
        const ads = await adsRes.json();
        const themes = await themesRes.json();
        
        const searchAds = ads.filter(a => a.type === 'search');
        const pmaxAds = ads.filter(a => a.type === 'pmax');
        
        document.getElementById('adsCount').textContent = ads.length;
        document.getElementById('searchAdsCount').textContent = searchAds.length;
        document.getElementById('pmaxAdsCount').textContent = pmaxAds.length;
        document.getElementById('themesCount').textContent = themes.length;
      } catch (err) {
        console.error('Failed to load Google Ads stats:', err);
      }
    }

    async function loadThemesForSelect() {
      try {
        const res = await apiFetch('/api/admin/themes');
        allThemes = await res.json();
        
        const themeSelect = document.getElementById('adsThemeSelect');
        const bulkThemeSelect = document.getElementById('bulkTheme');
        
        themeSelect.innerHTML = '<option value="">Select a theme</option>' + 
          allThemes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        
        bulkThemeSelect.innerHTML = '<option value="auto">Auto-suggest per product</option>' + 
          allThemes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      } catch (err) {
        console.error('Failed to load themes:', err);
      }
    }

    async function loadProductsForSelect() {
      try {
        const res = await apiFetch('/api/admin/products?limit=500&status=active');
        const data = await res.json();
        allAdsProducts = data.products || [];
        
        const productSelect = document.getElementById('adsProductSelect');
        productSelect.innerHTML = '<option value="">Select a product</option>' + 
          allAdsProducts.map(p => `<option value="${p.id}">${p.title} (${p.id})</option>`).join('');
      } catch (err) {
        console.error('Failed to load products:', err);
      }
    }

    async function suggestThemeForProduct() {
      const productId = document.getElementById('adsProductSelect').value;
      if (!productId) {
        showToast('Please select a product first', 'error');
        return;
      }
      
      try {
        const res = await apiFetch(`/api/admin/ads/suggest-theme/${productId}`);
        const data = await res.json();
        
        document.getElementById('suggestedTheme').style.display = 'block';
        document.getElementById('suggestedThemeName').textContent = data.theme?.name || 'No suggestion';
        
        if (data.theme) {
          document.getElementById('adsThemeSelect').value = data.theme.id;
        }
      } catch (err) {
        showToast('Failed to suggest theme: ' + err.message, 'error');
      }
    }

    async function generateAdsForProduct() {
      const productId = document.getElementById('adsProductSelect').value;
      const themeId = document.getElementById('adsThemeSelect').value;
      const adType = document.getElementById('adsTypeSelect').value;
      
      if (!productId) {
        showToast('Please select a product', 'error');
        return;
      }
      
      try {
        const res = await apiFetch('/api/admin/ads/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId, themeId, adType })
        });
        const data = await res.json();
        
        showToast(`Generated ${data.generated || 0} ad assets`, 'success');
        loadGoogleAdsStats();
        loadGeneratedAds();
      } catch (err) {
        showToast('Failed to generate ads: ' + err.message, 'error');
      }
    }

    async function bulkGenerateAds() {
      const category = document.getElementById('bulkCategory').value;
      const themeId = document.getElementById('bulkTheme').value;
      const limit = parseInt(document.getElementById('bulkLimit').value);
      const skipExisting = document.getElementById('bulkSkipExisting').checked;
      
      document.getElementById('bulkProgress').style.display = 'block';
      document.getElementById('bulkProgressText').textContent = 'Starting bulk generation...';
      document.getElementById('bulkProgressBar').style.width = '0%';
      
      try {
        const res = await apiFetch('/api/admin/ads/bulk-generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category, themeId: themeId === 'auto' ? null : themeId, limit, skipExisting })
        });
        const data = await res.json();
        
        document.getElementById('bulkProgressBar').style.width = '100%';
        document.getElementById('bulkProgressText').textContent = 
          `Completed! Generated ${data.generated || 0} ads for ${data.products || 0} products.`;
        
        showToast(`Bulk generation complete: ${data.generated || 0} ads`, 'success');
        loadGoogleAdsStats();
        loadGeneratedAds();
      } catch (err) {
        document.getElementById('bulkProgressText').textContent = 'Error: ' + err.message;
        showToast('Bulk generation failed: ' + err.message, 'error');
      }
    }

    async function loadGeneratedAds() {
      const search = document.getElementById('adsSearch').value;
      const typeFilter = document.getElementById('adsTypeFilter').value;
      
      try {
        const res = await apiFetch('/api/admin/ads');
        let ads = await res.json();
        
        if (search) {
          const s = search.toLowerCase();
          ads = ads.filter(a => 
            (a.productTitle || '').toLowerCase().includes(s) ||
            (a.productId || '').toLowerCase().includes(s)
          );
        }
        
        if (typeFilter !== 'all') {
          ads = ads.filter(a => a.type === typeFilter);
        }
        
        if (ads.length === 0) {
          document.getElementById('generatedAdsTable').innerHTML = 
            '<div style="text-align: center; color: #aaa; padding: 30px;">No ad assets found. Generate some ads above!</div>';
          return;
        }
        
        let html = `
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Type</th>
                <th>Headlines</th>
                <th>Descriptions</th>
                <th>Theme</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        for (const ad of ads.slice((adsPage - 1) * 25, adsPage * 25)) {
          const headlines = ad.headlines?.length || 0;
          const descriptions = ad.descriptions?.length || 0;
          const created = ad.createdAt ? new Date(ad.createdAt).toLocaleDateString() : '-';
          
          html += `
            <tr>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${ad.productTitle || ad.productId}
              </td>
              <td><span class="status-badge ${ad.type === 'search' ? 'status-active' : 'status-inactive'}">${ad.type}</span></td>
              <td>${headlines}</td>
              <td>${descriptions}</td>
              <td>${ad.themeName || '-'}</td>
              <td>${created}</td>
              <td>
                <button class="btn btn-sm" onclick="viewAdDetails('${ad.id}')">View</button>
                <button class="btn btn-sm btn-danger" onclick="deleteAd('${ad.id}')">Delete</button>
              </td>
            </tr>
          `;
        }
        
        html += '</tbody></table>';
        document.getElementById('generatedAdsTable').innerHTML = html;
        
        const totalPages = Math.ceil(ads.length / 25);
        document.getElementById('adsPagination').innerHTML = `
          <div class="pagination-info">Showing ${Math.min(ads.length, 25)} of ${ads.length} ads</div>
          <div class="pagination-btns">
            <button class="btn btn-sm" ${adsPage <= 1 ? 'disabled' : ''} onclick="adsPage--; loadGeneratedAds();">Prev</button>
            <span style="padding: 0 10px; color: #aaa;">Page ${adsPage} of ${totalPages || 1}</span>
            <button class="btn btn-sm" ${adsPage >= totalPages ? 'disabled' : ''} onclick="adsPage++; loadGeneratedAds();">Next</button>
          </div>
        `;
      } catch (err) {
        document.getElementById('generatedAdsTable').innerHTML = 
          `<div class="error-msg">Failed to load ads: ${err.message}</div>`;
      }
    }

    async function viewAdDetails(adId) {
      try {
        const res = await apiFetch('/api/admin/ads');
        const ads = await res.json();
        const ad = ads.find(a => a.id === adId);
        
        if (!ad) {
          showToast('Ad not found', 'error');
          return;
        }
        
        let content = `
          <div style="margin-bottom: 20px;">
            <h4 style="color: #00C4A7; margin-bottom: 10px;">${ad.productTitle || ad.productId}</h4>
            <div style="font-size: 12px; color: #aaa; margin-bottom: 5px;">Type: ${ad.type}</div>
            <div style="font-size: 12px; color: #aaa;">Theme: ${ad.themeName || 'None'}</div>
          </div>
        `;
        
        if (ad.headlines?.length) {
          content += `
            <div style="margin-bottom: 20px;">
              <h5 style="color: #fff; margin-bottom: 10px;">Headlines (${ad.headlines.length})</h5>
              <div style="background: #262643; border-radius: 4px; padding: 10px; max-height: 150px; overflow-y: auto;">
                ${ad.headlines.map((h, i) => `<div style="padding: 5px 0; border-bottom: 1px solid #333; font-size: 12px;">${i+1}. ${h}</div>`).join('')}
              </div>
            </div>
          `;
        }
        
        if (ad.descriptions?.length) {
          content += `
            <div style="margin-bottom: 20px;">
              <h5 style="color: #fff; margin-bottom: 10px;">Descriptions (${ad.descriptions.length})</h5>
              <div style="background: #262643; border-radius: 4px; padding: 10px; max-height: 150px; overflow-y: auto;">
                ${ad.descriptions.map((d, i) => `<div style="padding: 5px 0; border-bottom: 1px solid #333; font-size: 12px;">${i+1}. ${d}</div>`).join('')}
              </div>
            </div>
          `;
        }
        
        if (ad.type === 'pmax') {
          if (ad.longHeadlines?.length) {
            content += `
              <div style="margin-bottom: 20px;">
                <h5 style="color: #fff; margin-bottom: 10px;">Long Headlines (${ad.longHeadlines.length})</h5>
                <div style="background: #262643; border-radius: 4px; padding: 10px; max-height: 100px; overflow-y: auto;">
                  ${ad.longHeadlines.map((h, i) => `<div style="padding: 5px 0; border-bottom: 1px solid #333; font-size: 12px;">${i+1}. ${h}</div>`).join('')}
                </div>
              </div>
            `;
          }
          
          if (ad.callToActions?.length) {
            content += `
              <div>
                <h5 style="color: #fff; margin-bottom: 10px;">Call to Actions</h5>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  ${ad.callToActions.map(c => `<span style="background: #00C4A7; color: #1a1a2e; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${c}</span>`).join('')}
                </div>
              </div>
            `;
          }
        }
        
        document.getElementById('drawerBody').innerHTML = content;
        document.getElementById('drawerOverlay').classList.add('active');
        document.getElementById('productDrawer').classList.add('active');
      } catch (err) {
        showToast('Failed to load ad details: ' + err.message, 'error');
      }
    }

    async function deleteAd(adId) {
      if (!confirm('Are you sure you want to delete this ad asset?')) return;
      
      try {
        await apiFetch(`/api/admin/ads/${adId}`, { method: 'DELETE' });
        showToast('Ad deleted successfully', 'success');
        loadGoogleAdsStats();
        loadGeneratedAds();
      } catch (err) {
        showToast('Failed to delete ad: ' + err.message, 'error');
      }
    }

    async function loadThemesTable() {
      try {
        const res = await apiFetch('/api/admin/themes');
        const themes = await res.json();
        
        if (themes.length === 0) {
          document.getElementById('themesTable').innerHTML = 
            '<div style="text-align: center; color: #aaa; padding: 20px;">No themes found.</div>';
          return;
        }
        
        let html = `
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Category</th>
                <th>Keywords</th>
                <th>Tone</th>
                <th>Default</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        for (const theme of themes) {
          html += `
            <tr>
              <td style="font-weight: 600; color: #00C4A7;">${theme.name}</td>
              <td>${theme.category || 'All'}</td>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${(theme.keywords || []).slice(0, 3).join(', ')}${theme.keywords?.length > 3 ? '...' : ''}
              </td>
              <td>${theme.tone || '-'}</td>
              <td>${theme.isDefault ? '<span class="status-badge status-active">Yes</span>' : '-'}</td>
            </tr>
          `;
        }
        
        html += '</tbody></table>';
        document.getElementById('themesTable').innerHTML = html;
      } catch (err) {
        document.getElementById('themesTable').innerHTML = 
          `<div class="error-msg">Failed to load themes: ${err.message}</div>`;
      }
    }

    function downloadSearchCSV() {
      window.location.href = '/api/admin/ads/export/search.csv';
    }

    function downloadPMaxCSV() {
      window.location.href = '/api/admin/ads/export/pmax.csv';
    }

    // Override switchTab to load Google Ads data when tab is activated
    const originalSwitchTab = switchTab;
    switchTab = function(tab) {
      originalSwitchTab(tab);
      if (tab === 'googleads') {
        loadGoogleAdsTab();
      }
      if (tab === 'herostudio') {
        loadHeroes();
      }
    };

    // Hero Studio Functions
    let heroesData = { heroes: [], activeHeroes: {} };

    async function loadHeroes() {
      try {
        const data = await apiFetch('/api/admin/heroes');
        
        if (!data.ok) throw new Error(data.error || 'Failed to load heroes');
        
        heroesData = data;
        renderHeroesGrid();
        renderActiveHeroes();
      } catch (err) {
        document.getElementById('heroesGrid').innerHTML = 
          `<div class="error-msg">Failed to load heroes: ${err.message}</div>`;
      }
    }

    function renderHeroesGrid() {
      const grid = document.getElementById('heroesGrid');
      
      if (!heroesData.heroes || heroesData.heroes.length === 0) {
        grid.innerHTML = `
          <div style="text-align: center; color: #aaa; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 10px;">üé®</div>
            <div>No heroes generated yet</div>
            <div style="font-size: 12px; margin-top: 5px;">Use the panel on the left to generate your first hero</div>
          </div>
        `;
        return;
      }
      
      let html = '';
      for (const hero of heroesData.heroes.slice().reverse()) {
        const isActive = heroesData.activeHeroes[hero.category] === hero.id;
        const previewImage = hero.paths?.desktop || hero.paths?.ultrawide || hero.paths?.mobile;
        
        html += `
          <div style="background: #262643; border-radius: 8px; overflow: hidden; ${isActive ? 'border: 2px solid #00C4A7;' : ''}">
            <div style="position: relative;">
              <img src="${previewImage}" alt="${hero.category}" 
                   style="width: 100%; height: 120px; object-fit: cover;" 
                   onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 50%22><rect fill=%22%23262643%22 width=%22100%22 height=%2250%22/><text x=%2250%22 y=%2225%22 fill=%22%23666%22 font-size=%228%22 text-anchor=%22middle%22>No Preview</text></svg>'" />
              ${isActive ? '<div style="position: absolute; top: 8px; right: 8px; background: #00C4A7; color: #1a1a2e; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">ACTIVE</div>' : ''}
            </div>
            <div style="padding: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-weight: 600; color: #fff; text-transform: capitalize;">${hero.category.replace('-', ' ')}</div>
                <div style="font-size: 10px; color: #aaa;">${hero.stylePreset || 'custom'}</div>
              </div>
              <div style="font-size: 10px; color: #666; margin-bottom: 10px;">
                ${new Date(hero.createdAt).toLocaleDateString()}
              </div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                ${Object.keys(hero.paths || {}).map(size => 
                  `<span style="background: #333; padding: 2px 6px; border-radius: 3px; font-size: 9px; color: #aaa;">${size}</span>`
                ).join('')}
              </div>
              <div style="display: flex; gap: 8px; margin-top: 12px;">
                ${!isActive ? `<button class="btn btn-sm" onclick="activateHero('${hero.id}')">Set Active</button>` : ''}
                <button class="btn btn-sm btn-secondary" onclick="previewHero('${hero.id}')">Preview</button>
                <button class="btn btn-sm btn-danger" onclick="deleteHero('${hero.id}')">Delete</button>
              </div>
            </div>
          </div>
        `;
      }
      
      grid.innerHTML = html;
    }

    function renderActiveHeroes() {
      const grid = document.getElementById('activeHeroesGrid');
      const categories = ['dogs', 'cats', 'dogs-toys', 'dogs-food', 'cats-toys', 'cats-food'];
      
      let html = '';
      for (const cat of categories) {
        const activeId = heroesData.activeHeroes[cat];
        const hero = activeId ? heroesData.heroes.find(h => h.id === activeId) : null;
        
        html += `
          <div style="background: #262643; border-radius: 8px; padding: 12px;">
            <div style="font-weight: 600; color: #fff; margin-bottom: 8px; text-transform: capitalize;">${cat.replace('-', ' ')}</div>
            ${hero ? `
              <img src="${hero.paths?.desktop || hero.paths?.mobile}" 
                   alt="${cat}" 
                   style="width: 100%; height: 80px; object-fit: cover; border-radius: 4px;" />
              <div style="font-size: 10px; color: #aaa; margin-top: 6px;">ID: ${hero.id.slice(-8)}</div>
            ` : `
              <div style="height: 80px; background: #1a1a2e; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 12px;">
                No active hero
              </div>
            `}
          </div>
        `;
      }
      
      grid.innerHTML = html;
    }

    async function generateHero() {
      const category = document.getElementById('heroCategory').value;
      const stylePreset = document.getElementById('heroStyle').value;
      const customKeywords = document.getElementById('heroKeywords').value;
      const includeBrandText = document.getElementById('heroBrandText').checked;
      
      document.getElementById('generateHeroBtn').disabled = true;
      document.getElementById('heroGenerating').style.display = 'block';
      
      try {
        const data = await apiFetch('/api/admin/heroes/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category, stylePreset, customKeywords, includeBrandText })
        });
        
        if (!data.ok) {
          const errorMsg = data.details ? `${data.error}: ${data.details}` : (data.error || 'Generation failed');
          throw new Error(errorMsg);
        }
        
        showToast('Hero images generated successfully!', 'success');
        document.getElementById('heroKeywords').value = '';
        loadHeroes();
      } catch (err) {
        const fullMessage = err.message.includes('Generation failed') ? err.message : `Generation failed: ${err.message}`;
        showToast(fullMessage, 'error');
      } finally {
        document.getElementById('generateHeroBtn').disabled = false;
        document.getElementById('heroGenerating').style.display = 'none';
      }
    }

    async function activateHero(heroId) {
      try {
        const data = await apiFetch(`/api/admin/heroes/${heroId}/activate`, { method: 'POST' });
        
        if (!data.ok) throw new Error(data.error || 'Activation failed');
        
        showToast('Hero activated!', 'success');
        loadHeroes();
      } catch (err) {
        showToast('Activation failed: ' + err.message, 'error');
      }
    }

    async function deleteHero(heroId) {
      if (!confirm('Are you sure you want to delete this hero? This cannot be undone.')) return;
      
      try {
        const data = await apiFetch(`/api/admin/heroes/${heroId}`, { method: 'DELETE' });
        
        if (!data.ok) throw new Error(data.error || 'Delete failed');
        
        showToast('Hero deleted', 'success');
        loadHeroes();
      } catch (err) {
        showToast('Delete failed: ' + err.message, 'error');
      }
    }

    function previewHero(heroId) {
      const hero = heroesData.heroes.find(h => h.id === heroId);
      if (!hero || !hero.paths) return;
      
      let content = `
        <div style="margin-bottom: 20px;">
          <h4 style="color: #00C4A7; margin-bottom: 10px; text-transform: capitalize;">${hero.category.replace('-', ' ')} Hero</h4>
          <div style="font-size: 12px; color: #aaa;">Style: ${hero.stylePreset || 'custom'}</div>
          <div style="font-size: 11px; color: #666; margin-top: 5px;">Created: ${new Date(hero.createdAt).toLocaleString()}</div>
        </div>
      `;
      
      for (const [size, path] of Object.entries(hero.paths)) {
        content += `
          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #fff; margin-bottom: 8px; text-transform: uppercase;">${size}</div>
            <img src="${path}" alt="${size}" style="width: 100%; border-radius: 4px;" />
            <a href="${path}" target="_blank" style="font-size: 11px; color: #00C4A7; display: block; margin-top: 5px;">Open full size</a>
          </div>
        `;
      }
      
      if (hero.promptUsed) {
        content += `
          <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
            <div style="font-size: 11px; color: #aaa; margin-bottom: 5px;">Prompt Used:</div>
            <div style="font-size: 11px; color: #666; font-style: italic;">${hero.promptUsed}</div>
          </div>
        `;
      }
      
      document.getElementById('drawerHeader').textContent = 'Hero Preview';
      document.getElementById('drawerBody').innerHTML = content;
      document.getElementById('drawerOverlay').classList.add('active');
      document.getElementById('productDrawer').classList.add('active');
    }

    // ===== EXPERIMENTS TAB FUNCTIONS =====
    let experimentData = null;

    async function loadExperiments() {
      try {
        const data = await apiFetch('/api/admin/ab/experiments');
        if (!data.ok) throw new Error(data.error || 'Failed to load experiments');
        
        const exp = data.experiments.find(e => e.id === 'pdpHero');
        if (exp) {
          experimentData = exp;
          const btn = document.getElementById('experimentToggleBtn');
          btn.textContent = exp.enabled ? 'Disable' : 'Enable';
          btn.className = exp.enabled ? 'btn btn-danger' : 'btn';
        }
        loadExperimentSummary();
      } catch (err) {
        console.error('Failed to load experiments:', err);
      }
    }

    async function toggleExperiment(experimentId) {
      try {
        const data = await apiFetch(`/api/admin/ab/experiments/${experimentId}/toggle`, {
          method: 'POST'
        });
        if (!data.ok) throw new Error(data.error || 'Toggle failed');
        
        showToast(data.enabled ? 'Experiment enabled' : 'Experiment disabled', 'success');
        loadExperiments();
      } catch (err) {
        showToast('Failed to toggle: ' + err.message, 'error');
      }
    }

    async function loadExperimentSummary() {
      const container = document.getElementById('experimentResults');
      try {
        const data = await apiFetch('/api/admin/ab/summary/pdpHero');
        if (!data.ok) throw new Error(data.error || 'Failed to load summary');
        
        const summary = data.summary;
        const va = summary.variants.A;
        const vb = summary.variants.B;
        
        container.innerHTML = `
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="text-align: left; padding: 10px; border-bottom: 1px solid #333;">Metric</th>
                  <th style="text-align: center; padding: 10px; border-bottom: 1px solid #333;">${va.label} (A)</th>
                  <th style="text-align: center; padding: 10px; border-bottom: 1px solid #333;">${vb.label} (B)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding: 10px; border-bottom: 1px solid #262643;">PDP Views</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643;">${va.PDP_VIEW}</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643;">${vb.PDP_VIEW}</td>
                </tr>
                <tr>
                  <td style="padding: 10px; border-bottom: 1px solid #262643;">Add to Cart</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643;">${va.ADD_TO_CART}</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643;">${vb.ADD_TO_CART}</td>
                </tr>
                <tr>
                  <td style="padding: 10px; border-bottom: 1px solid #262643;">ATC Rate</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643; color: ${parseFloat(va.atcRate) >= parseFloat(vb.atcRate) ? '#00C4A7' : '#fff'}; font-weight: 600;">${va.atcRate}%</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643; color: ${parseFloat(vb.atcRate) >= parseFloat(va.atcRate) ? '#00C4A7' : '#fff'}; font-weight: 600;">${vb.atcRate}%</td>
                </tr>
                <tr>
                  <td style="padding: 10px; border-bottom: 1px solid #262643;">Checkout Rate</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643;">${va.checkoutRate}%</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643;">${vb.checkoutRate}%</td>
                </tr>
                <tr>
                  <td style="padding: 10px; border-bottom: 1px solid #262643;">Purchases</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643;">${va.PURCHASE}</td>
                  <td style="text-align: center; padding: 10px; border-bottom: 1px solid #262643;">${vb.PURCHASE}</td>
                </tr>
                <tr>
                  <td style="padding: 10px;">Conversion Rate</td>
                  <td style="text-align: center; padding: 10px; color: ${parseFloat(va.conversionRate) >= parseFloat(vb.conversionRate) ? '#00C4A7' : '#fff'}; font-weight: 600;">${va.conversionRate}%</td>
                  <td style="text-align: center; padding: 10px; color: ${parseFloat(vb.conversionRate) >= parseFloat(va.conversionRate) ? '#00C4A7' : '#fff'}; font-weight: 600;">${vb.conversionRate}%</td>
                </tr>
              </tbody>
            </table>
          </div>
          ${summary.winner ? `
            <div style="margin-top: 20px; padding: 16px; background: #1a3a2a; border-radius: 8px; text-align: center;">
              <div style="font-size: 14px; color: #00C4A7; font-weight: 600;">
                ${summary.winner === 'tie' ? 'Results are tied' : `Variant ${summary.winner} (${summary.winner === 'A' ? va.label : vb.label}) is winning`}
              </div>
              ${summary.lift ? `<div style="font-size: 12px; color: #aaa; margin-top: 5px;">Lift: +${summary.lift}%</div>` : ''}
            </div>
          ` : `
            <div style="margin-top: 20px; padding: 16px; background: #262643; border-radius: 8px; text-align: center; color: #aaa; font-size: 13px;">
              Not enough data to determine a winner yet
            </div>
          `}
        `;
      } catch (err) {
        container.innerHTML = `<div class="error-msg">Failed to load: ${err.message}</div>`;
      }
    }

    // ===== SEO GENERATOR TAB FUNCTIONS =====
    let selectedSeoProduct = null;
    let currentSeoData = null;
    let productSeoLocales = {};
    const LOCALE_FLAGS = { 'en-US': 'üá∫üá∏', 'nl-NL': 'üá≥üá±', 'de-DE': 'üá©üá™', 'fr-FR': 'üá´üá∑', 'es-ES': 'üá™üá∏' };
    const LOCALE_NAMES = { 'en-US': 'English', 'nl-NL': 'Dutch', 'de-DE': 'German', 'fr-FR': 'French', 'es-ES': 'Spanish' };

    async function loadSeoStats() {
      try {
        const data = await apiFetch('/api/admin/seo/stats');
        if (data.stats) {
          document.getElementById('seoProductCount').textContent = data.stats.total || 0;
          document.getElementById('seoTotalEntries').textContent = data.stats.withSeo || 0;
          document.getElementById('seoPublished').textContent = data.stats.publishedSeo || 0;
          document.getElementById('seoDrafts').textContent = (data.stats.withSeo || 0) - (data.stats.publishedSeo || 0);
        }
      } catch (err) {
        console.error('Failed to load SEO stats:', err);
      }
    }

    async function searchSeoProducts() {
      const query = document.getElementById('seoProductSearch').value.trim();
      
      const container = document.getElementById('seoProductResults');
      container.innerHTML = '<div class="loading">Searching...</div>';
      
      try {
        const data = await apiFetch(`/api/admin/products/search?q=${encodeURIComponent(query)}&limit=20`);
        
        if (!data.products || data.products.length === 0) {
          container.innerHTML = '<div style="color: #666; font-size: 12px;">No products found. Try a different search term.</div>';
          return;
        }
        
        let html = '';
        for (const p of data.products) {
          const hasSeoIcon = p.hasSeo ? '<span style="color: #00C4A7; margin-left: 8px;" title="Has SEO">‚úì</span>' : '';
          html += `
            <div onclick="selectSeoProduct('${p.id}')" 
                 style="display: flex; gap: 12px; padding: 10px; cursor: pointer; border-bottom: 1px solid #262643; transition: background 0.2s;"
                 onmouseover="this.style.background='#262643'" onmouseout="this.style.background='transparent'"
                 data-product='${JSON.stringify(p).replace(/'/g, "&apos;")}'>
              <img src="${p.image || '/images/placeholder.png'}" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;" onerror="this.src='/images/placeholder.png'" />
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 13px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.title}${hasSeoIcon}</div>
                <div style="font-size: 11px; color: #666;">ID: ${p.id} | ${p.category || 'No category'}</div>
              </div>
            </div>
          `;
        }
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = `<div class="error-msg">Search failed: ${err.message}</div>`;
      }
    }
    
    let seoSearchDebounce = null;
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('seoProductSearch');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          clearTimeout(seoSearchDebounce);
          seoSearchDebounce = setTimeout(() => searchSeoProducts(), 300);
        });
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            clearTimeout(seoSearchDebounce);
            searchSeoProducts();
          }
        });
      }
    });

    async function selectSeoProduct(productId) {
      const productEl = document.querySelector(`[data-product*="${productId}"]`);
      if (!productEl) return;
      
      try {
        selectedSeoProduct = JSON.parse(productEl.dataset.product.replace(/&apos;/g, "'"));
        document.getElementById('seoProductImage').src = selectedSeoProduct.image || '/images/placeholder.png';
        document.getElementById('seoProductTitle').textContent = selectedSeoProduct.title;
        document.getElementById('seoProductId').textContent = selectedSeoProduct.id;
        document.getElementById('seoSelectedProduct').style.display = 'block';
        document.getElementById('seoPreview').style.display = 'none';
        currentSeoData = null;
        
        // Load existing SEO for all locales
        await loadProductSeoLocales();
        await loadExistingSeo();
      } catch (err) {
        console.error('Failed to select product:', err);
      }
    }

    async function loadProductSeoLocales() {
      if (!selectedSeoProduct) return;
      productSeoLocales = {};
      
      try {
        const data = await apiFetch(`/api/admin/seo/${selectedSeoProduct.id}`);
        if (data.locales) {
          data.locales.forEach(seo => {
            productSeoLocales[seo.locale] = seo;
          });
        }
        updateLocaleStatusIndicators();
      } catch (err) {
        console.error('Failed to load product SEO locales:', err);
      }
    }

    function updateLocaleStatusIndicators() {
      const container = document.getElementById('seoLocaleStatus');
      if (!container) return;
      
      const locales = ['en-US', 'nl-NL', 'de-DE', 'fr-FR', 'es-ES'];
      container.innerHTML = locales.map(locale => {
        const seo = productSeoLocales[locale];
        const status = seo ? seo.status : 'none';
        const statusColor = status === 'published' ? '#00C4A7' : status === 'draft' ? '#ffa500' : '#666';
        const statusLabel = status === 'published' ? 'Published' : status === 'draft' ? 'Draft' : 'None';
        
        return `
          <div style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: #1a1a2e; border-radius: 4px; font-size: 11px;">
            <span>${LOCALE_FLAGS[locale]}</span>
            <span style="color: ${statusColor};">${statusLabel}</span>
          </div>
        `;
      }).join('');
    }

    async function loadExistingSeo() {
      if (!selectedSeoProduct) return;
      
      const locale = document.getElementById('seoLocaleSelect').value;
      const seo = productSeoLocales[locale];
      
      if (seo) {
        currentSeoData = seo;
        populateSeoForm(seo);
        document.getElementById('seoPreview').style.display = 'block';
      } else {
        currentSeoData = null;
        clearSeoForm();
        document.getElementById('seoPreview').style.display = 'none';
      }
    }

    function populateSeoForm(seo) {
      const locale = document.getElementById('seoLocaleSelect').value;
      document.getElementById('seoTitle').value = seo.seo_title || '';
      document.getElementById('seoH1').value = seo.h1 || '';
      document.getElementById('seoMetaDesc').value = seo.meta_description || '';
      document.getElementById('seoOgTitle').value = seo.og_title || '';
      document.getElementById('seoOgDesc').value = seo.og_description || '';
      
      // Parse JSON fields
      try {
        const bullets = JSON.parse(seo.bullets_json || '[]');
        document.getElementById('seoBullets').value = bullets.join('\n');
      } catch { document.getElementById('seoBullets').value = ''; }
      
      try {
        const faqs = JSON.parse(seo.faqs_json || '[]');
        document.getElementById('seoFaq').value = faqs.map(f => `Q: ${f.q} | A: ${f.a}`).join('\n');
      } catch { document.getElementById('seoFaq').value = ''; }
      
      try {
        const keywords = JSON.parse(seo.keywords_json || '[]');
        document.getElementById('seoKeywords').value = keywords.join(', ');
      } catch { document.getElementById('seoKeywords').value = ''; }
      
      // Update status indicators
      document.getElementById('seoPreviewLocale').textContent = `${LOCALE_FLAGS[locale]} ${LOCALE_NAMES[locale]}`;
      const statusEl = document.getElementById('seoPreviewStatus');
      if (seo.status === 'published') {
        statusEl.textContent = 'Published';
        statusEl.style.background = '#1a3a2a';
        statusEl.style.color = '#00C4A7';
      } else {
        statusEl.textContent = 'Draft';
        statusEl.style.background = '#3a2a1a';
        statusEl.style.color = '#ffa500';
      }
      
      // Update char counts
      updateCharCount('seoTitle', 60);
      updateCharCount('seoMetaDesc', 155);
    }

    function clearSeoForm() {
      document.getElementById('seoTitle').value = '';
      document.getElementById('seoH1').value = '';
      document.getElementById('seoMetaDesc').value = '';
      document.getElementById('seoOgTitle').value = '';
      document.getElementById('seoOgDesc').value = '';
      document.getElementById('seoBullets').value = '';
      document.getElementById('seoFaq').value = '';
      document.getElementById('seoKeywords').value = '';
    }

    function updateCharCount(fieldId, max) {
      const field = document.getElementById(fieldId);
      const countEl = document.getElementById(fieldId + 'Count');
      if (field && countEl) {
        const len = field.value.length;
        countEl.textContent = `(${len}/${max})`;
        countEl.style.color = len > max ? '#ff6b6b' : '#666';
      }
    }

    async function generateProductSeo() {
      if (!selectedSeoProduct) return;
      
      const locale = document.getElementById('seoLocaleSelect').value;
      const tonePreset = document.getElementById('seoToneSelect').value;
      
      document.getElementById('generateSeoBtn').disabled = true;
      document.getElementById('seoGenerating').style.display = 'block';
      
      try {
        const data = await apiFetch('/api/admin/seo/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: selectedSeoProduct.id, locale, tonePreset })
        });
        
        if (data.error) throw new Error(data.error);
        
        await loadProductSeoLocales();
        await loadExistingSeo();
        
        document.getElementById('seoPreview').style.display = 'block';
        showToast(`SEO generated for ${LOCALE_NAMES[locale]}!`, 'success');
      } catch (err) {
        showToast('Generation failed: ' + err.message, 'error');
      } finally {
        document.getElementById('generateSeoBtn').disabled = false;
        document.getElementById('seoGenerating').style.display = 'none';
      }
    }

    function collectSeoFormData() {
      const bullets = document.getElementById('seoBullets').value.split('\n').filter(b => b.trim());
      const faqLines = document.getElementById('seoFaq').value.split('\n').filter(l => l.trim());
      const faqs = faqLines.map(line => {
        const match = line.match(/Q:\s*(.+?)\s*\|\s*A:\s*(.+)/i);
        return match ? { q: match[1].trim(), a: match[2].trim() } : null;
      }).filter(Boolean);
      const keywords = document.getElementById('seoKeywords').value.split(',').map(k => k.trim()).filter(Boolean);
      
      return {
        seo_title: document.getElementById('seoTitle').value,
        h1: document.getElementById('seoH1').value,
        meta_description: document.getElementById('seoMetaDesc').value,
        og_title: document.getElementById('seoOgTitle').value,
        og_description: document.getElementById('seoOgDesc').value,
        bullets_json: JSON.stringify(bullets),
        faqs_json: JSON.stringify(faqs),
        keywords_json: JSON.stringify(keywords)
      };
    }

    async function saveSeoAsDraft() {
      if (!selectedSeoProduct) return;
      
      const locale = document.getElementById('seoLocaleSelect').value;
      const formData = collectSeoFormData();
      formData.status = 'draft';
      
      try {
        const data = await apiFetch('/api/seo/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: selectedSeoProduct.id, locale, data: formData })
        });
        
        if (data.error) throw new Error(data.error);
        
        await loadProductSeoLocales();
        await loadExistingSeo();
        loadSeoStats();
        showToast('SEO saved as draft!', 'success');
      } catch (err) {
        showToast('Save failed: ' + err.message, 'error');
      }
    }

    async function publishSeo() {
      if (!selectedSeoProduct) return;
      
      const locale = document.getElementById('seoLocaleSelect').value;
      const formData = collectSeoFormData();
      formData.status = 'published';
      
      try {
        // First save the content
        await apiFetch('/api/seo/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: selectedSeoProduct.id, locale, data: formData })
        });
        
        // Then publish
        const data = await apiFetch(`/api/admin/seo/${selectedSeoProduct.id}/${locale}/publish`, {
          method: 'POST'
        });
        
        if (data.error) throw new Error(data.error);
        
        await loadProductSeoLocales();
        await loadExistingSeo();
        loadSeoStats();
        showToast(`SEO published for ${LOCALE_NAMES[locale]}!`, 'success');
      } catch (err) {
        showToast('Publish failed: ' + err.message, 'error');
      }
    }

    let bulkSeoPollingInterval = null;
    
    async function startBulkSeoGeneration() {
      const locale = document.getElementById('bulkSeoLocale').value;
      const tonePreset = document.getElementById('bulkSeoTone').value;
      const category = document.getElementById('bulkSeoCategory').value.trim() || null;
      const batchSize = parseInt(document.getElementById('bulkSeoLimit').value);
      const skipPublished = document.getElementById('bulkSeoSkipExisting').checked;
      
      const btn = document.getElementById('bulkSeoBtn');
      const progressDiv = document.getElementById('bulkSeoProgress');
      const resultsDiv = document.getElementById('bulkSeoResults');
      
      btn.disabled = true;
      btn.textContent = 'Starting...';
      document.getElementById('bulkSeoCancelBtn').style.display = 'inline-block';
      progressDiv.style.display = 'block';
      resultsDiv.style.display = 'none';
      
      document.getElementById('bulkSeoProgressBar').style.width = '5%';
      document.getElementById('bulkSeoStatus').textContent = `Starting bulk SEO for ${LOCALE_NAMES[locale]}...`;
      
      try {
        const data = await apiFetch('/api/admin/seo/bulk/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ locale, tonePreset, category, batchSize, skipPublished })
        });
        
        if (data.error) throw new Error(data.error);
        
        btn.textContent = 'Running...';
        startBulkSeoPolling();
        
      } catch (err) {
        resultsDiv.style.display = 'block';
        document.getElementById('bulkSeoResultsContent').innerHTML = `
          <div style="color: #ff6b6b;">Failed to start: ${err.message}</div>
        `;
        showToast('Bulk start failed: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Start Bulk Generation';
      }
    }
    
    function startBulkSeoPolling() {
      if (bulkSeoPollingInterval) clearInterval(bulkSeoPollingInterval);
      
      bulkSeoPollingInterval = setInterval(async () => {
        try {
          const status = await apiFetch('/api/admin/seo/bulk/status');
          updateBulkSeoProgress(status);
          
          if (!status.running) {
            clearInterval(bulkSeoPollingInterval);
            bulkSeoPollingInterval = null;
            finishBulkSeoJob(status);
          }
        } catch (err) {
          console.error('Polling error:', err);
        }
      }, 1000);
    }
    
    function updateBulkSeoProgress(status) {
      const pct = status.total > 0 ? Math.round((status.progress / status.total) * 100) : 0;
      document.getElementById('bulkSeoProgressBar').style.width = `${pct}%`;
      
      let statusText = `Progress: ${status.progress}/${status.total}`;
      if (status.currentProduct) {
        statusText += ` | Current: ${status.currentProduct.title?.substring(0, 30) || status.currentProduct.id}...`;
      }
      statusText += ` | Generated: ${status.generated} | Failed: ${status.failed}`;
      document.getElementById('bulkSeoStatus').textContent = statusText;
    }
    
    function finishBulkSeoJob(status) {
      const btn = document.getElementById('bulkSeoBtn');
      const resultsDiv = document.getElementById('bulkSeoResults');
      
      btn.disabled = false;
      btn.textContent = 'Start Bulk Generation';
      document.getElementById('bulkSeoCancelBtn').style.display = 'none';
      document.getElementById('bulkSeoProgressBar').style.width = '100%';
      
      resultsDiv.style.display = 'block';
      
      let errorsHtml = '';
      if (status.errors && status.errors.length > 0) {
        errorsHtml = `<div style="margin-top: 8px; color: #ff6b6b; font-size: 11px;">
          Errors (${status.errors.length}): ${status.errors.slice(0, 3).map(e => e.error || e.productId).join(', ')}
          ${status.errors.length > 3 ? '...' : ''}
        </div>`;
      }
      
      document.getElementById('bulkSeoResultsContent').innerHTML = `
        <div style="color: #00C4A7; margin-bottom: 8px;">${status.cancelRequested ? 'Bulk job cancelled' : 'Bulk generation complete!'}</div>
        <div>Generated: <strong>${status.generated}</strong></div>
        <div>Failed: <strong>${status.failed}</strong></div>
        <div>Total processed: <strong>${status.progress}/${status.total}</strong></div>
        ${errorsHtml}
      `;
      
      loadSeoStats();
      showToast(`Bulk SEO: ${status.generated} generated, ${status.failed} failed`, status.failed > 0 ? 'warning' : 'success');
    }
    
    async function cancelBulkSeoJob() {
      try {
        await apiFetch('/api/admin/seo/bulk/cancel', { method: 'POST' });
        showToast('Cancel requested...', 'info');
      } catch (err) {
        showToast('Cancel failed: ' + err.message, 'error');
      }
    }

    // ===== TOP PICKS TAB FUNCTIONS =====
    let topPicksData = { scored: [], stats: {} };

    async function loadTopPicksStats() {
      try {
        const data = await apiFetch('/api/admin/top-picks/stats');
        
        if (data.ok) {
          const stats = data.stats;
          document.getElementById('tpEligible').textContent = stats.eligible || 0;
          document.getElementById('tpWithImages').textContent = stats.withImages || 0;
          document.getElementById('tpMissingImages').textContent = stats.missingImages || 0;
          document.getElementById('tpQuarantined').textContent = stats.quarantined || 0;
          document.getElementById('tpTotalEvents').textContent = stats.totalEvents || 0;
          if (stats.lastRecalculated) {
            document.getElementById('lastRecalculated').textContent = 
              'Last calculated: ' + new Date(stats.lastRecalculated).toLocaleString();
          }
        }
      } catch (err) {
        console.error('Failed to load top picks stats:', err);
      }
    }

    async function recalculateScores() {
      const btn = document.getElementById('recalculateBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Calculating...';
      
      try {
        const data = await apiFetch('/api/admin/top-picks/recalculate', {
          method: 'POST'
        });
        
        if (!data.ok) throw new Error(data.error || 'Recalculation failed');
        
        showToast(`Scores recalculated for ${data.count} products`, 'success');
        loadTopPicksStats();
        loadScoredProducts();
      } catch (err) {
        showToast('Recalculation failed: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Recalculate Scores';
      }
    }

    async function loadScoredProducts() {
      const scope = document.getElementById('topPicksScope').value;
      const container = document.getElementById('scoredProductsTable');
      container.innerHTML = '<div class="loading">Loading...</div>';
      
      try {
        const data = await apiFetch(`/api/admin/top-picks/scored?scope=${scope}`);
        
        if (!data.ok) throw new Error(data.error || 'Failed to load');
        
        if (!data.products || data.products.length === 0) {
          container.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">No scored products. Click "Recalculate Scores" to generate scores.</div>';
          return;
        }
        
        let html = `
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Score</th>
                <th>Title</th>
                <th>Category</th>
                <th>Pet Type</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        data.products.slice(0, 50).forEach((p, idx) => {
          const isFeatured = data.featured?.includes(p.id);
          const isQuarantined = data.quarantined?.includes(p.id);
          
          html += `
            <tr style="${isQuarantined ? 'opacity: 0.5;' : ''}">
              <td style="font-weight: 600; color: ${idx < 3 ? '#00C4A7' : '#fff'};">#${idx + 1}</td>
              <td>
                <span style="background: ${p.score >= 70 ? '#1a3a2a' : p.score >= 50 ? '#3a3a1a' : '#3a1a1a'}; 
                       color: ${p.score >= 70 ? '#00C4A7' : p.score >= 50 ? '#ffc107' : '#ff6b6b'}; 
                       padding: 2px 8px; border-radius: 4px; font-weight: 600;">${p.score}</span>
              </td>
              <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.title}</td>
              <td>${p.category || '-'}</td>
              <td style="text-transform: capitalize;">${p.petType || '-'}</td>
              <td>
                <button class="btn btn-sm ${isFeatured ? 'btn-secondary' : ''}" 
                        onclick="featureProduct('${p.id}', '${scope}', ${!isFeatured})">
                  ${isFeatured ? 'Unfeature' : 'Feature'}
                </button>
                <button class="btn btn-sm ${isQuarantined ? 'btn-secondary' : 'btn-danger'}" 
                        onclick="quarantineProduct('${p.id}', ${!isQuarantined})">
                  ${isQuarantined ? 'Restore' : 'Quarantine'}
                </button>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = `<div class="error-msg">Failed to load: ${err.message}</div>`;
      }
    }

    async function featureProduct(productId, scope, featured) {
      try {
        const data = await apiFetch('/api/admin/top-picks/feature', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId, scope, featured })
        });
        if (!data.ok) throw new Error(data.error);
        showToast(featured ? 'Product featured' : 'Product unfeatured', 'success');
        loadScoredProducts();
      } catch (err) {
        showToast('Failed: ' + err.message, 'error');
      }
    }

    async function quarantineProduct(productId, quarantine) {
      try {
        const data = await apiFetch('/api/admin/top-picks/quarantine', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId, quarantine })
        });
        if (!data.ok) throw new Error(data.error);
        showToast(quarantine ? 'Product quarantined' : 'Product restored', 'success');
        loadScoredProducts();
        loadTopPicksStats();
      } catch (err) {
        showToast('Failed: ' + err.message, 'error');
      }
    }

    // --- CJ Match Import Functions ---
    async function loadCjMatchStats() {
      try {
        const data = await apiFetch('/api/admin/cj-match/stats');
        const statsDiv = document.getElementById('cjMatchStats');
        if (data.ok) {
          statsDiv.innerHTML = `
            <strong>Current CJ Coverage:</strong> 
            ${data.withAnyCj}/${data.total} products have CJ IDs 
            (${data.withCjId} with cj_product_id, ${data.withCjSpu} with cj_spu, ${data.withNeither} with neither)
          `;
        } else {
          statsDiv.textContent = 'Failed to load stats: ' + (data.error || 'Unknown error');
        }
      } catch (err) {
        document.getElementById('cjMatchStats').textContent = 'Error loading stats: ' + err.message;
      }
    }

    async function previewCjMatch() {
      const fileInput = document.getElementById('cjMatchFile');
      if (!fileInput.files || !fileInput.files[0]) {
        showToast('Please select a CSV file first', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      
      const resultDiv = document.getElementById('cjMatchResult');
      resultDiv.innerHTML = '<p style="color: #aaa;">Previewing...</p>';
      
      try {
        const resp = await fetch('/api/admin/cj-match/import?dryRun=true', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const data = await resp.json();
        
        if (!data.ok) {
          resultDiv.innerHTML = `<p style="color: #ff6b6b;">Error: ${data.error || 'Unknown error'}</p>`;
          return;
        }
        
        resultDiv.innerHTML = `
          <div style="background: #262643; padding: 12px; border-radius: 4px; margin-bottom: 12px;">
            <strong style="color: #00C4A7;">Preview Results (Dry Run - No Changes Made)</strong><br>
            Total Rows: ${data.totalRows}<br>
            Matched: ${data.matched}<br>
            Would Update: <span style="color: #00C4A7;">${data.updated}</span><br>
            New CJ IDs: <span style="color: #00C4A7;">${data.newCjIds}</span><br>
            Already Had CJ: ${data.alreadyHasCj}<br>
            Skipped: ${data.skipped}<br>
            Failed: <span style="color: ${data.failed > 0 ? '#ff6b6b' : '#aaa'};">${data.failed}</span>
          </div>
          ${data.updates && data.updates.length > 0 ? `
            <div style="margin-bottom: 12px;">
              <strong style="color: #aaa;">Sample Updates (first ${data.updates.length}):</strong>
              <table style="width: 100%; font-size: 11px; margin-top: 8px; border-collapse: collapse;">
                <tr style="background: #262643;">
                  <th style="text-align: left; padding: 6px; border-bottom: 1px solid #333;">Product ID</th>
                  <th style="text-align: left; padding: 6px; border-bottom: 1px solid #333;">Title</th>
                  <th style="text-align: left; padding: 6px; border-bottom: 1px solid #333;">New CJ ID</th>
                  <th style="text-align: left; padding: 6px; border-bottom: 1px solid #333;">New SPU</th>
                </tr>
                ${data.updates.slice(0, 20).map(u => `
                  <tr>
                    <td style="padding: 4px; border-bottom: 1px solid #262643; font-family: monospace; font-size: 10px;">${u.product_id}</td>
                    <td style="padding: 4px; border-bottom: 1px solid #262643;">${u.title}</td>
                    <td style="padding: 4px; border-bottom: 1px solid #262643; color: #00C4A7;">${u.new_cj_product_id || '-'}</td>
                    <td style="padding: 4px; border-bottom: 1px solid #262643; color: #00C4A7;">${u.new_cj_spu || '-'}</td>
                  </tr>
                `).join('')}
              </table>
            </div>
          ` : ''}
          ${data.errors && data.errors.length > 0 ? `
            <div style="color: #ff6b6b;">
              <strong>Errors (${data.errors.length}):</strong><br>
              ${data.errors.slice(0, 10).map(e => `Row ${e.row}: ${e.error}`).join('<br>')}
            </div>
          ` : ''}
        `;
      } catch (err) {
        resultDiv.innerHTML = `<p style="color: #ff6b6b;">Request failed: ${err.message}</p>`;
      }
    }

    async function applyCjMatch() {
      const fileInput = document.getElementById('cjMatchFile');
      if (!fileInput.files || !fileInput.files[0]) {
        showToast('Please select a CSV file first', 'error');
        return;
      }
      
      if (!confirm('This will update your catalog with CJ IDs from the CSV. Continue?')) {
        return;
      }
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      
      const resultDiv = document.getElementById('cjMatchResult');
      resultDiv.innerHTML = '<p style="color: #aaa;">Applying changes...</p>';
      
      try {
        const resp = await fetch('/api/admin/cj-match/import', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const data = await resp.json();
        
        if (!data.ok) {
          resultDiv.innerHTML = `<p style="color: #ff6b6b;">Error: ${data.error || 'Unknown error'}</p>`;
          return;
        }
        
        showToast(`Updated ${data.updated} products with CJ IDs`, 'success');
        loadCjMatchStats();
        loadEnrichStats();
        
        resultDiv.innerHTML = `
          <div style="background: #1a3a2a; padding: 12px; border-radius: 4px; border: 1px solid #00C4A7;">
            <strong style="color: #00C4A7;">Import Complete!</strong><br>
            Total Rows: ${data.totalRows}<br>
            Matched: ${data.matched}<br>
            Updated: <span style="color: #00C4A7; font-weight: bold;">${data.updated}</span><br>
            New CJ IDs Added: <span style="color: #00C4A7;">${data.newCjIds}</span><br>
            Skipped: ${data.skipped}<br>
            Failed: ${data.failed}<br>
            ${data.backupPath ? `<span style="font-size: 11px; color: #aaa;">Backup saved to: ${data.backupPath}</span>` : ''}
          </div>
        `;
      } catch (err) {
        resultDiv.innerHTML = `<p style="color: #ff6b6b;">Request failed: ${err.message}</p>`;
      }
    }

    // --- Enrichment Functions ---
    let enrichRefreshInterval = null;

    async function loadEnrichStats() {
      try {
        const data = await apiFetch('/api/admin/enrich/stats');
        if (data.ok && data.stats) {
          document.getElementById('enrichStatTotal').textContent = data.stats.total || 0;
          document.getElementById('enrichStatCjId').textContent = data.stats.withCjId || 0;
          document.getElementById('enrichStatSuccess').textContent = data.stats.enriched || 0;
          document.getElementById('enrichStatFailed').textContent = data.stats.failed || 0;
          document.getElementById('enrichStatMultiImg').textContent = data.stats.withMultipleImages || 0;
        }
      } catch (err) {
        console.error('Failed to load enrich stats:', err);
      }
    }

    async function loadEnrichStatus() {
      try {
        const data = await apiFetch('/api/admin/enrich/status');
        if (!data.ok) throw new Error(data.error || 'Failed to load status');
        
        renderEnrichJob(data.currentJob);
        renderEnrichRecentJobs(data.recentJobs || []);
        loadEnrichStats();
      } catch (err) {
        console.error('Failed to load enrich status:', err);
      }
    }

    function renderEnrichJob(job) {
      const container = document.getElementById('enrichJobInfo');
      const runBtn = document.getElementById('enrichRunBtn');
      const stopBtn = document.getElementById('enrichStopBtn');
      
      if (!job) {
        container.innerHTML = '<p style="color: #666; font-size: 13px;">No active job. Click "Run Enrichment" to start.</p>';
        runBtn.disabled = false;
        stopBtn.disabled = true;
        return;
      }
      
      const isRunning = job.status === 'running' || job.status === 'cancelling';
      const pct = job.total > 0 ? Math.round((job.processed / job.total) * 100) : 0;
      
      runBtn.disabled = isRunning;
      stopBtn.disabled = !isRunning;
      
      container.innerHTML = `
        <div style="display: grid; gap: 12px;">
          <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div><strong style="color: #aaa;">Job ID:</strong> <span style="color: #00C4A7; font-family: monospace;">${job.jobId}</span></div>
            <div><strong style="color: #aaa;">Status:</strong> <span style="color: ${isRunning ? '#00C4A7' : job.status === 'completed' ? '#00C4A7' : '#ff6b6b'}; text-transform: capitalize;">${job.status}</span></div>
            <div><strong style="color: #aaa;">Started:</strong> ${job.startedAt ? new Date(job.startedAt).toLocaleString() : '-'}</div>
          </div>
          
          <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div><strong style="color: #aaa;">Processed:</strong> ${job.processed}/${job.total}</div>
            <div><strong style="color: #aaa;">Success:</strong> <span style="color: #00C4A7;">${job.successCount}</span></div>
            <div><strong style="color: #aaa;">Failed:</strong> <span style="color: #ff6b6b;">${job.failCount}</span></div>
          </div>
          
          <div style="margin-top: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span style="font-size: 12px; color: #aaa;">Progress</span>
              <span style="font-size: 12px; color: #00C4A7; font-weight: 600;">${pct}%</span>
            </div>
            <div style="height: 8px; background: #262643; border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; background: #00C4A7; width: ${pct}%; transition: width 0.3s;"></div>
            </div>
          </div>
        </div>
      `;
      
      // Show errors
      if (job.errors && job.errors.length > 0) {
        renderEnrichErrors(job.errors);
      }
      
      // Auto-refresh if running
      if (isRunning && !enrichRefreshInterval) {
        enrichRefreshInterval = setInterval(loadEnrichStatus, 3000);
      } else if (!isRunning && enrichRefreshInterval) {
        clearInterval(enrichRefreshInterval);
        enrichRefreshInterval = null;
      }
    }

    function renderEnrichErrors(errors) {
      const container = document.getElementById('enrichErrors');
      if (!errors || errors.length === 0) {
        container.innerHTML = '<p style="color: #666; font-size: 13px;">No errors.</p>';
        return;
      }
      
      const recentErrors = errors.slice(-20).reverse();
      container.innerHTML = recentErrors.map(e => `
        <div style="padding: 8px; background: #2a1a1a; border-radius: 4px; margin-bottom: 8px; font-size: 12px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span style="color: #ff6b6b; font-weight: 600;">${e.productId}</span>
            <span style="color: #666; font-size: 11px;">${e.timestamp ? new Date(e.timestamp).toLocaleTimeString() : ''}</span>
          </div>
          <div style="color: #aaa;">${e.error}</div>
        </div>
      `).join('');
    }

    function renderEnrichRecentJobs(jobs) {
      const container = document.getElementById('enrichRecentJobs');
      if (!jobs || jobs.length === 0) {
        container.innerHTML = '<p style="color: #666; font-size: 13px;">No previous jobs.</p>';
        return;
      }
      
      container.innerHTML = `
        <table style="width: 100%; font-size: 12px;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 8px; border-bottom: 1px solid #262643;">Job ID</th>
              <th style="text-align: left; padding: 8px; border-bottom: 1px solid #262643;">Status</th>
              <th style="text-align: center; padding: 8px; border-bottom: 1px solid #262643;">Processed</th>
              <th style="text-align: center; padding: 8px; border-bottom: 1px solid #262643;">Success</th>
              <th style="text-align: center; padding: 8px; border-bottom: 1px solid #262643;">Failed</th>
              <th style="text-align: left; padding: 8px; border-bottom: 1px solid #262643;">Started</th>
            </tr>
          </thead>
          <tbody>
            ${jobs.map(j => `
              <tr>
                <td style="padding: 8px; font-family: monospace; color: #00C4A7;">${j.jobId.substring(0, 20)}</td>
                <td style="padding: 8px; text-transform: capitalize; color: ${j.status === 'completed' ? '#00C4A7' : j.status === 'running' ? '#ffc107' : '#ff6b6b'};">${j.status}</td>
                <td style="padding: 8px; text-align: center;">${j.processed}/${j.total}</td>
                <td style="padding: 8px; text-align: center; color: #00C4A7;">${j.successCount}</td>
                <td style="padding: 8px; text-align: center; color: #ff6b6b;">${j.failCount}</td>
                <td style="padding: 8px; color: #666;">${j.startedAt ? new Date(j.startedAt).toLocaleString() : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function startEnrichJob() {
      const force = document.getElementById('enrichForce').checked;
      const overwrite = document.getElementById('enrichOverwrite').checked;
      
      const runBtn = document.getElementById('enrichRunBtn');
      runBtn.disabled = true;
      runBtn.textContent = '‚è≥ Starting...';
      
      try {
        const data = await apiFetch('/api/admin/enrich/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ force, overwriteFields: overwrite })
        });
        
        if (!data.ok) throw new Error(data.error || 'Failed to start job');
        
        showToast('Enrichment job started', 'success');
        loadEnrichStatus();
      } catch (err) {
        showToast('Failed to start: ' + err.message, 'error');
        runBtn.disabled = false;
      }
      runBtn.textContent = '‚ñ∂Ô∏è Run Enrichment';
    }

    async function resumeEnrichJob() {
      try {
        const data = await apiFetch('/api/admin/enrich/status');
        if (!data.ok || !data.recentJobs || data.recentJobs.length === 0) {
          showToast('No job to resume', 'error');
          return;
        }
        
        const lastJob = data.recentJobs.find(j => j.status === 'stopped' || j.status === 'failed');
        if (!lastJob) {
          showToast('No stopped/failed job to resume', 'error');
          return;
        }
        
        const resumeData = await apiFetch('/api/admin/enrich/resume', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jobId: lastJob.jobId })
        });
        
        if (!resumeData.ok) throw new Error(resumeData.error || 'Failed to resume');
        
        showToast('Job resumed', 'success');
        loadEnrichStatus();
      } catch (err) {
        showToast('Failed to resume: ' + err.message, 'error');
      }
    }

    async function stopEnrichJob() {
      try {
        const data = await apiFetch('/api/admin/enrich/cancel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!data.success) throw new Error(data.error || 'Failed to cancel');
        
        showToast('Cancel requested - job will stop within 5-15 seconds', 'success');
        setTimeout(loadEnrichStatus, 2000);
      } catch (err) {
        showToast('Failed to cancel: ' + err.message, 'error');
      }
    }

    // Translation Functions
    async function loadTranslationStats() {
      try {
        const data = await apiFetch('/api/admin/translation/stats');
        if (data.ok) {
          document.getElementById('transStatTotal').textContent = data.stats.totalProducts;
          document.getElementById('transStatPending').textContent = data.stats.translationStatus.pending;
          document.getElementById('transStatPartial').textContent = data.stats.translationStatus.partial;
          document.getElementById('transStatComplete').textContent = data.stats.translationStatus.complete;
          
          const langNames = { nl: 'Dutch', de: 'German', fr: 'French', es: 'Spanish' };
          const langStatsEl = document.getElementById('transLangStats');
          langStatsEl.innerHTML = Object.entries(data.stats.byLang).map(([lang, stats]) => `
            <div style="background: #262643; padding: 12px; border-radius: 4px;">
              <div style="font-size: 14px; font-weight: 600; color: #00C4A7; margin-bottom: 8px;">${langNames[lang] || lang.toUpperCase()}</div>
              <div style="font-size: 12px; color: #aaa;">
                <span style="color: #00C4A7;">‚úì ${stats.translated}</span> / 
                <span style="color: #ff6b6b;">${stats.missing} missing</span>
              </div>
              <div style="margin-top: 6px; height: 4px; background: #1a1a2e; border-radius: 2px; overflow: hidden;">
                <div style="height: 100%; background: #00C4A7; width: ${Math.round(stats.translated / (stats.translated + stats.missing) * 100)}%;"></div>
              </div>
            </div>
          `).join('');
        }
      } catch (err) {
        console.error('Failed to load translation stats:', err);
      }
    }

    async function loadTranslationStatus() {
      try {
        const data = await apiFetch('/api/admin/translation/status');
        const infoEl = document.getElementById('transJobInfo');
        const runBtn = document.getElementById('transRunBtn');
        const stopBtn = document.getElementById('transStopBtn');
        
        if (data.running && data.job) {
          const job = data.job;
          runBtn.disabled = true;
          stopBtn.disabled = false;
          
          infoEl.innerHTML = `
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 13px; color: #ffc107;">‚è≥ Running...</span>
                <span style="font-size: 12px; color: #aaa;">${job.progress}%</span>
              </div>
              <div style="height: 8px; background: #262643; border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; background: #00C4A7; width: ${job.progress}%; transition: width 0.3s;"></div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 12px;">
                <div><span style="color: #aaa;">Processed:</span> ${job.processed}/${job.total}</div>
                <div><span style="color: #aaa;">Success:</span> <span style="color: #00C4A7;">${job.successful}</span></div>
                <div><span style="color: #aaa;">Failed:</span> <span style="color: #ff6b6b;">${job.failed}</span></div>
                <div><span style="color: #aaa;">Skipped:</span> ${job.skipped}</div>
              </div>
              ${job.currentProductId ? `<div style="font-size: 11px; color: #666;">Current: ${job.currentProductId}</div>` : ''}
            </div>
          `;
          
          setTimeout(loadTranslationStatus, 2000);
        } else {
          runBtn.disabled = false;
          stopBtn.disabled = true;
          
          if (data.lastJob) {
            const job = data.lastJob;
            infoEl.innerHTML = `
              <div style="font-size: 13px;">
                <span style="color: ${job.status === 'completed' ? '#00C4A7' : '#ff6b6b'}; text-transform: capitalize;">${job.status}</span>
                <span style="color: #666;"> ‚Äî ${job.processed}/${job.total} processed, ${job.successful} successful</span>
              </div>
            `;
          } else {
            infoEl.innerHTML = '<p style="color: #666; font-size: 13px;">No active job. Click "Run Translation" to start.</p>';
          }
        }
        
        loadTranslationHistory();
      } catch (err) {
        console.error('Failed to load translation status:', err);
      }
    }

    async function loadTranslationHistory() {
      try {
        const data = await apiFetch('/api/admin/translation/history?limit=10');
        const container = document.getElementById('transRecentJobs');
        
        if (!data.ok || !data.history || data.history.length === 0) {
          container.innerHTML = '<p style="color: #666; font-size: 13px;">No previous jobs.</p>';
          return;
        }
        
        container.innerHTML = `
          <table style="width: 100%; font-size: 12px;">
            <thead>
              <tr>
                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #262643;">Job ID</th>
                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #262643;">Status</th>
                <th style="text-align: center; padding: 8px; border-bottom: 1px solid #262643;">Processed</th>
                <th style="text-align: center; padding: 8px; border-bottom: 1px solid #262643;">Success</th>
                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #262643;">Started</th>
              </tr>
            </thead>
            <tbody>
              ${data.history.map(j => `
                <tr>
                  <td style="padding: 8px; font-family: monospace; color: #00C4A7;">${j.id.substring(0, 16)}</td>
                  <td style="padding: 8px; text-transform: capitalize; color: ${j.status === 'completed' ? '#00C4A7' : j.status === 'running' ? '#ffc107' : '#ff6b6b'};">${j.status}</td>
                  <td style="padding: 8px; text-align: center;">${j.processed}/${j.total}</td>
                  <td style="padding: 8px; text-align: center; color: #00C4A7;">${j.successful}</td>
                  <td style="padding: 8px; color: #666;">${j.startedAt ? new Date(j.startedAt).toLocaleString() : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error('Failed to load translation history:', err);
      }
    }

    async function startTranslationJob() {
      const includeSpecs = document.getElementById('transIncludeSpecs').checked;
      const runBtn = document.getElementById('transRunBtn');
      runBtn.disabled = true;
      runBtn.textContent = '‚è≥ Starting...';
      
      try {
        const data = await apiFetch('/api/admin/translation/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ includeSpecs })
        });
        
        if (!data.success) throw new Error(data.error || 'Failed to start job');
        
        showToast('Translation job started', 'success');
        loadTranslationStatus();
      } catch (err) {
        showToast('Failed to start: ' + err.message, 'error');
        runBtn.disabled = false;
      }
      runBtn.textContent = '‚ñ∂Ô∏è Run Translation';
    }

    async function stopTranslationJob() {
      try {
        const data = await apiFetch('/api/admin/translation/stop', { method: 'POST' });
        
        if (!data.success) throw new Error(data.error || 'Failed to stop');
        
        showToast('Stop requested', 'success');
        setTimeout(loadTranslationStatus, 1000);
      } catch (err) {
        showToast('Failed to stop: ' + err.message, 'error');
      }
    }

    async function runImageAnalysisBatch() {
      const useOCR = document.getElementById('imageUseOCR').checked;
      const resultEl = document.getElementById('imageAnalysisResult');
      resultEl.innerHTML = '<p style="color: #ffc107; font-size: 12px;">‚è≥ Analyzing images...</p>';
      
      try {
        const data = await apiFetch('/api/admin/images/analyze-batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ useOCR })
        });
        
        if (!data.ok) throw new Error(data.error || 'Analysis failed');
        
        resultEl.innerHTML = `
          <p style="color: #00C4A7; font-size: 12px;">
            ‚úì Analysis complete: ${data.processed} products analyzed, ${data.reordered} reordered
            ${data.errors > 0 ? `<span style="color: #ff6b6b;">(${data.errors} errors)</span>` : ''}
          </p>
        `;
      } catch (err) {
        resultEl.innerHTML = `<p style="color: #ff6b6b; font-size: 12px;">Error: ${err.message}</p>`;
      }
    }

    // Override switchTab to load new tab data
    const baseSwitchTab = switchTab;
    switchTab = function(tab) {
      baseSwitchTab(tab);
      if (tab === 'experiments') {
        loadExperiments();
      }
      if (tab === 'seogen') {
        loadSeoStats();
      }
      if (tab === 'toppicks') {
        loadTopPicksStats();
        loadScoredProducts();
      }
      if (tab === 'enrich') {
        loadEnrichStats();
        loadEnrichStatus();
      }
      if (tab === 'languages') {
        loadTranslationStats();
        loadTranslationStatus();
      }
    };

    // ============ PET AUDIT FUNCTIONS ============
    let petAuditScanData = null;

    async function petAuditScan() {
      const btn = document.getElementById("petAuditScanBtn");
      if (btn) { btn.disabled = true; btn.textContent = "Scanning..."; }
      try {
        const data = await apiFetch("/api/admin/pet-audit/scan", { method: "POST" });
        petAuditScanData = data;
        document.getElementById("petAuditTotal").textContent = data.total || 0;
        document.getElementById("petAuditNonPetCount").textContent = data.nonPetCount || 0;
        document.getElementById("petAuditLastRun").textContent = new Date().toLocaleTimeString();
        let tableHtml = '<table style="width: 100%; font-size: 12px;"><thead><tr><th>Title</th><th>Score</th><th>Usage</th><th>Reasons</th></tr></thead><tbody>';
        (data.sample || []).forEach(p => {
          tableHtml += `<tr><td>${p.title}</td><td style="color: ${p.score < 0 ? '#ff6b6b' : '#ffa500'};">${p.score}</td><td>${p.usage}</td><td style="max-width: 200px; overflow: hidden; font-size: 10px;">${(p.reasons || []).join(", ")}</td></tr>`;
        });
        tableHtml += '</tbody></table>';
        document.getElementById("petAuditTable").innerHTML = tableHtml;
        document.getElementById("petAuditResults").style.display = "block";
        document.getElementById("petAuditApplySoftBtn").disabled = false;
        document.getElementById("petAuditApplyHardBtn").disabled = false;
        showToast(`Scan complete: ${data.nonPetCount} non-pet products found`);
      } catch (err) {
        showToast("Scan failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "üîç Scan for Non-Pet Products"; }
      }
    }

    async function petAuditApplySoft() {
      if (!petAuditScanData) { showToast("Run scan first", "error"); return; }
      if (!window.confirm(`Hide ${petAuditScanData.nonPetCount} non-pet products? (Soft delete, reversible)`)) return;
      const btn = document.getElementById("petAuditApplySoftBtn");
      if (btn) { btn.disabled = true; btn.textContent = "Hiding..."; }
      try {
        const data = await apiFetch("/api/admin/pet-audit/apply", { method: "POST", body: JSON.stringify({ mode: "soft" }) });
        showToast(`Hidden ${data.updated} products`);
        document.getElementById("petAuditUndoBtn").disabled = false;
      } catch (err) {
        showToast("Apply failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "üîí Soft Delete (Hide)"; }
      }
    }

    async function petAuditApplyHard() {
      if (!petAuditScanData) { showToast("Run scan first", "error"); return; }
      if (!window.confirm(`PERMANENTLY DELETE ${petAuditScanData.nonPetCount} products? This cannot be undone.`)) return;
      const btn = document.getElementById("petAuditApplyHardBtn");
      if (btn) { btn.disabled = true; btn.textContent = "Deleting..."; }
      try {
        const data = await apiFetch("/api/admin/pet-audit/apply", { method: "POST", body: JSON.stringify({ mode: "hard" }) });
        showToast(`Deleted ${data.hardDeleted} products`);
        petAuditScanData = null;
        document.getElementById("petAuditResults").style.display = "none";
      } catch (err) {
        showToast("Delete failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "‚ö†Ô∏è Hard Delete (Permanent)"; }
      }
    }

    async function petAuditUndo() {
      if (!window.confirm("Restore all soft-deleted products?")) return;
      const btn = document.getElementById("petAuditUndoBtn");
      if (btn) { btn.disabled = true; btn.textContent = "Restoring..."; }
      try {
        const data = await apiFetch("/api/admin/pet-audit/undo-soft-delete", { method: "POST" });
        showToast(`Restored ${data.restored} products`);
        document.getElementById("petAuditUndoBtn").disabled = true;
      } catch (err) {
        showToast("Undo failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "‚Ü©Ô∏è Restore Soft Deleted"; }
      }
    }

    async function petRebuildClassification() {
      if (!window.confirm("Rebuild pet eligibility + bucket classification for ALL products? This may take a few minutes.")) return;
      const btn = document.getElementById("petRebuildBtn");
      if (btn) { btn.disabled = true; btn.textContent = "Rebuilding..."; }
      try {
        const data = await apiFetch("/api/admin/pet-rebuild-classification", { method: "POST" });
        showToast(`Rebuilt ${data.updated} products (${data.eligible} eligible, ${data.ineligible} ineligible)`);
      } catch (err) {
        showToast("Rebuild failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "üîÑ Rebuild Usage + Buckets"; }
      }
    }

    async function rebuildPetTypeClassification() {
      if (!window.confirm("Rebuild Pet Type Classification (dog/cat/both/null) for ALL products?")) return;
      const btn = document.getElementById("rebuildPetTypeBtn");
      const resultDiv = document.getElementById("petClassificationResult");
      if (btn) { btn.disabled = true; btn.textContent = "Classifying..."; }
      try {
        const data = await apiFetch("/api/admin/pets/rebuild", { method: "POST" });
        if (data.counts) {
          document.getElementById("petClassDog").textContent = data.counts.dog || 0;
          document.getElementById("petClassCat").textContent = data.counts.cat || 0;
          document.getElementById("petClassBoth").textContent = data.counts.both || 0;
          document.getElementById("petClassNull").textContent = data.counts.null || 0;
          resultDiv.style.display = "block";
        }
        showToast(`Pet classification complete: ${data.counts.dog} dog, ${data.counts.cat} cat, ${data.counts.both} both, ${data.counts.null} non-pet`);
      } catch (err) {
        showToast("Classification failed: " + err.message, "error");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "üêæ Rebuild Pet Classification"; }
      }
    }

    // ============ PURGE NON-PET FUNCTIONS ============
    let purgePreviewData = null;

    async function purgePreview() {
      const btn = document.getElementById("purgePreviewBtn");
      btn.disabled = true;
      btn.textContent = "Scanning...";
      try {
        const data = await apiFetch("/api/admin/catalog/purge-non-pet", {
          method: "POST",
          body: JSON.stringify({ mode: "deactivate", dryRun: true })
        });
        purgePreviewData = data;
        document.getElementById("purgeAffectedCount").textContent = data.affected?.length || 0;
        document.getElementById("purgeCategoryFixes").textContent = data.categoryFixes || 0;
        document.getElementById("purgeNewTotal").textContent = data.newTotal || "-";
        
        if (data.affected && data.affected.length > 0) {
          document.getElementById("purgeDeactivateBtn").disabled = false;
          document.getElementById("purgeDeleteBtn").disabled = false;
          
          let html = data.affected.slice(0, 50).map(p => 
            `<div style="padding: 4px 0; border-bottom: 1px solid #333;">
              <strong>${p.slug || p.product_id}</strong>: ${p.title || ""}
              <span style="color: #ff6b6b; font-size: 10px;">(${(p.reasons || []).join(", ")})</span>
            </div>`
          ).join("");
          document.getElementById("purgeResultsTable").innerHTML = html;
          document.getElementById("purgeResults").style.display = "block";
        }
        showToast(`Found ${data.affected?.length || 0} non-pet products`);
      } catch (err) {
        showToast("Preview failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "üëÅÔ∏è Preview Cleanup";
      }
    }

    async function purgeDeactivate() {
      if (!confirm("Deactivate all non-pet products? They will be hidden from the storefront.")) return;
      const btn = document.getElementById("purgeDeactivateBtn");
      btn.disabled = true;
      btn.textContent = "Processing...";
      try {
        const data = await apiFetch("/api/admin/catalog/purge-non-pet", {
          method: "POST",
          body: JSON.stringify({ mode: "deactivate", dryRun: false })
        });
        document.getElementById("purgeLastRun").textContent = new Date().toLocaleString();
        showToast(`Deactivated ${data.deactivated || 0} products. Category fixes: ${data.categoryFixes || 0}`);
        document.getElementById("purgeDeactivateBtn").disabled = true;
        document.getElementById("purgeDeleteBtn").disabled = true;
      } catch (err) {
        showToast("Deactivate failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "üîí Deactivate Non-Pet";
      }
    }

    function purgeDelete() {
      document.getElementById("purgeConfirmDelete").style.display = "block";
      document.getElementById("purgeConfirmInput").value = "";
      document.getElementById("purgeConfirmInput").focus();
    }

    async function purgeDeleteConfirm() {
      const input = document.getElementById("purgeConfirmInput").value;
      if (input !== "DELETE") {
        showToast("Please type DELETE to confirm", "error");
        return;
      }
      document.getElementById("purgeConfirmDelete").style.display = "none";
      const btn = document.getElementById("purgeDeleteBtn");
      btn.disabled = true;
      btn.textContent = "Deleting...";
      try {
        const data = await apiFetch("/api/admin/catalog/purge-non-pet", {
          method: "POST",
          body: JSON.stringify({ mode: "delete", dryRun: false })
        });
        document.getElementById("purgeLastRun").textContent = new Date().toLocaleString();
        document.getElementById("purgeNewTotal").textContent = data.newTotal || "-";
        showToast(`Deleted ${data.deleted || 0} products permanently`);
        document.getElementById("purgeDeactivateBtn").disabled = true;
        document.getElementById("purgeDeleteBtn").disabled = true;
        document.getElementById("purgeResults").style.display = "none";
      } catch (err) {
        showToast("Delete failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "üóëÔ∏è Delete Non-Pet (Danger)";
      }
    }

    // ============ CJ COST SYNC FUNCTIONS ============
    async function cjCostPreview() {
      const btn = document.getElementById("cjCostPreviewBtn");
      const limitInput = document.getElementById("cjCostLimit");
      const limit = limitInput.value ? parseInt(limitInput.value) : null;
      btn.disabled = true;
      btn.textContent = "Fetching...";
      try {
        const data = await apiFetch("/api/admin/cj/sync-costs", {
          method: "POST",
          body: JSON.stringify({ dryRun: true, limit })
        });
        document.getElementById("cjCostProductsWithCj").textContent = data.productsWithCj || "-";
        document.getElementById("cjCostUpdated").textContent = data.updated || 0;
        document.getElementById("cjCostFailed").textContent = data.failed || 0;
        document.getElementById("cjCostProgress").textContent = `${data.processed || 0}/${data.productsWithCj || 0}`;
        
        if (data.errors && data.errors.length > 0) {
          let html = data.errors.slice(0, 20).map(e => 
            `<div style="padding: 4px 0; border-bottom: 1px solid #333; color: #ff6b6b;">${e.product_id}: ${e.error}</div>`
          ).join("");
          document.getElementById("cjCostErrorsList").innerHTML = html;
          document.getElementById("cjCostErrors").style.display = "block";
        } else {
          document.getElementById("cjCostErrors").style.display = "none";
        }
        
        document.getElementById("cjCostApplyBtn").disabled = false;
        showToast(`Dry-run: ${data.updated || 0} costs found, ${data.failed || 0} failed`);
      } catch (err) {
        showToast("CJ cost preview failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "üëÅÔ∏è Preview (Dry-Run)";
      }
    }

    async function cjCostApply() {
      if (!confirm("Apply CJ costs to catalog? This will update product cost fields.")) return;
      const btn = document.getElementById("cjCostApplyBtn");
      const limitInput = document.getElementById("cjCostLimit");
      const limit = limitInput.value ? parseInt(limitInput.value) : null;
      btn.disabled = true;
      btn.textContent = "Syncing...";
      try {
        const data = await apiFetch("/api/admin/cj/sync-costs", {
          method: "POST",
          body: JSON.stringify({ dryRun: false, limit })
        });
        document.getElementById("cjCostUpdated").textContent = data.updated || 0;
        document.getElementById("cjCostFailed").textContent = data.failed || 0;
        document.getElementById("cjCostProgress").textContent = `${data.processed || 0}/${data.productsWithCj || 0}`;
        showToast(`Applied costs: ${data.updated || 0} updated, ${data.variantsUpdated || 0} variants`);
      } catch (err) {
        showToast("CJ cost sync failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "‚úÖ Apply Costs";
      }
    }

    // ============ PRICING & CSV FUNCTIONS ============
    let pricingSelectedFile = null;
    let pricingPreviewData = null;

    function downloadPricingCSV() {
      window.location.href = "/api/admin/pricing/products/export.csv";
      showToast("CSV download started");
    }

    function handlePricingFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      pricingSelectedFile = file;
      document.getElementById("pricingFileName").textContent = "üìÑ " + file.name;
      document.getElementById("pricingFileName").style.display = "block";
      document.getElementById("previewImportBtn").disabled = false;
      document.getElementById("applyImportBtn").disabled = true;
      document.getElementById("pricingPreview").style.display = "none";
      showToast("File loaded: " + file.name);
    }

    async function previewPricingImport() {
      if (!pricingSelectedFile) {
        showToast("Please select a CSV file first", "error");
        return;
      }

      const btn = document.getElementById("previewImportBtn");
      btn.disabled = true;
      btn.textContent = "Analyzing...";

      try {
        const fd = new FormData();
        fd.append("file", pricingSelectedFile);
        
        const response = await fetch("/api/admin/pricing/products/import?mode=dryrun", {
          method: "POST",
          body: fd,
          credentials: "include",
          headers: getAdminHeaders()
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || "Import preview failed");
        }

        pricingPreviewData = data;

        let statsHtml = `
          <div class="stat" style="min-width: 120px;"><div class="stat-label">Total Rows</div><div class="stat-value">${data.total_rows}</div></div>
          <div class="stat" style="min-width: 120px;"><div class="stat-label">Products to Update</div><div class="stat-value">${data.matched_products}</div></div>
          <div class="stat" style="min-width: 120px;"><div class="stat-label">Price Changes</div><div class="stat-value">${data.summary?.price_updates || 0}</div></div>
          <div class="stat" style="min-width: 120px;"><div class="stat-label">Errors</div><div class="stat-value" style="color: ${data.errors?.length > 0 ? '#ff6b6b' : '#00C4A7'};">${data.errors?.length || 0}</div></div>
        `;
        const detectionHtml = `<div style="font-size: 11px; color: #888; margin-top: 8px;">Detected delimiter: <b>${data.delimiter || ','}</b> | BOM stripped: <b>${data.bomStripped ? 'Yes' : 'No'}</b></div>`;
        document.getElementById("pricingPreviewStats").innerHTML = statsHtml + detectionHtml;

        if (data.errors && data.errors.length > 0) {
          let errorsHtml = '<div style="background: #2a1a1a; border-radius: 4px; padding: 10px; max-height: 150px; overflow-y: auto;">';
          data.errors.slice(0, 20).forEach(err => {
            errorsHtml += `<div style="color: #ff6b6b; font-size: 12px; margin-bottom: 4px;">Row ${err.row}: ${err.error}</div>`;
          });
          if (data.errors.length > 20) {
            errorsHtml += `<div style="color: #aaa; font-size: 11px;">... and ${data.errors.length - 20} more errors</div>`;
          }
          errorsHtml += '</div>';
          document.getElementById("pricingPreviewErrors").innerHTML = errorsHtml;
        } else {
          document.getElementById("pricingPreviewErrors").innerHTML = '';
        }

        const tbody = document.querySelector("#pricingPreviewTable tbody");
        tbody.innerHTML = '';
        (data.updates_preview || []).slice(0, 100).forEach(update => {
          update.changes.forEach(change => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td style="font-family: monospace; font-size: 11px;">${update.productId}${update.variantId ? '<br><span style="color: #aaa;">var: ' + update.variantId + '</span>' : ''}</td>
              <td>${change.field}</td>
              <td style="color: #ff6b6b;">${typeof change.oldValue === 'number' ? '$' + change.oldValue.toFixed(2) : change.oldValue}</td>
              <td style="color: #00C4A7;">${typeof change.newValue === 'number' ? '$' + change.newValue.toFixed(2) : change.newValue}</td>
            `;
            tbody.appendChild(tr);
          });
        });

        document.getElementById("pricingPreview").style.display = "block";
        // Enable Apply Changes if preview was successful and we have valid rows
        document.getElementById("applyImportBtn").disabled = !(data.ok === true && data.matched_products > 0);
        showToast(`Preview ready: ${data.matched_products} products will be updated`);

      } catch (err) {
        showToast("Preview failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Preview Changes (Dry-run)";
      }
    }

    async function applyPricingImport() {
      if (!pricingSelectedFile) {
        showToast("Please select a CSV file first", "error");
        return;
      }

      if (!pricingPreviewData || pricingPreviewData.matched_products === 0) {
        showToast("Please run preview first", "error");
        return;
      }

      if (!window.confirm(`Apply ${pricingPreviewData.summary?.total_changes || 0} changes to ${pricingPreviewData.matched_products} products?`)) {
        return;
      }

      const btn = document.getElementById("applyImportBtn");
      btn.disabled = true;
      btn.textContent = "Applying...";

      try {
        const fd = new FormData();
        fd.append("file", pricingSelectedFile);
        
        const response = await fetch("/api/admin/pricing/products/import?mode=apply", {
          method: "POST",
          body: fd,
          credentials: "include",
          headers: getAdminHeaders()
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || "Import apply failed");
        }

        showToast(`Success! Updated ${data.updated_products} products (${data.total_changes} changes)`);
        pricingSelectedFile = null;
        pricingPreviewData = null;
        document.getElementById("pricingFileName").style.display = "none";
        document.getElementById("pricingPreview").style.display = "none";
        document.getElementById("previewImportBtn").disabled = true;
        document.getElementById("applyImportBtn").disabled = true;
        document.getElementById("pricingCsvFile").value = "";

      } catch (err) {
        showToast("Apply failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Apply Changes";
      }
    }

    let catalogSelectedFile = null;
    let catalogPreviewData = null;

    function downloadCatalogCSV() {
      window.open('/api/admin/catalog/export.csv', '_blank');
      showToast("Downloading catalog CSV...");
    }

    function handleCatalogFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate filename - warn about LOG/EXCLUDED files
      const fname = file.name.toLowerCase();
      if (fname.includes("excluded") || fname.includes("_log") || fname.includes("-log")) {
        showToast("‚ö†Ô∏è This appears to be a LOG file. Please upload the IMPORT_READY catalog CSV.", "error");
        event.target.value = "";
        return;
      }
      
      catalogSelectedFile = file;
      document.getElementById("catalogFileName").textContent = "üìÑ " + file.name;
      document.getElementById("catalogFileName").style.display = "block";
      document.getElementById("previewCatalogBtn").disabled = false;
      document.getElementById("applyCatalogBtn").disabled = true;
      document.getElementById("catalogPreview").style.display = "none";
      showToast("Catalog file loaded: " + file.name);
    }

    async function previewCatalogImport() {
      if (!catalogSelectedFile) {
        showToast("Please select a CSV file first", "error");
        return;
      }

      const btn = document.getElementById("previewCatalogBtn");
      btn.disabled = true;
      btn.textContent = "Analyzing...";

      try {
        const fd = new FormData();
        fd.append("file", catalogSelectedFile);
        
        const response = await fetch("/api/admin/catalog/preview", {
          headers: getAdminHeaders(),
          method: "POST",
          body: fd,
          credentials: "include"
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || "Catalog preview failed");
        }

        catalogPreviewData = data;

        const c = data.counts || {};
        let statsHtml = `
          <div class="stat" style="min-width: 100px; background: #0a2f0a;"><div class="stat-label">Total Rows</div><div class="stat-value">${c.totalRows || 0}</div></div>
          <div class="stat" style="min-width: 100px; background: #0a2f0a;"><div class="stat-label">Valid</div><div class="stat-value" style="color: #4ade80;">${c.validRows || 0}</div></div>
          <div class="stat" style="min-width: 100px; background: #0a2f0a;"><div class="stat-label">Creates</div><div class="stat-value" style="color: #60a5fa;">${c.creates || 0}</div></div>
          <div class="stat" style="min-width: 100px; background: #0a2f0a;"><div class="stat-label">Updates</div><div class="stat-value" style="color: #fbbf24;">${c.updates || 0}</div></div>
          <div class="stat" style="min-width: 100px; background: #0a2f0a;"><div class="stat-label">Disables</div><div class="stat-value" style="color: #f87171;">${c.disables || 0}</div></div>
          <div class="stat" style="min-width: 100px; background: #0a2f0a;"><div class="stat-label">Disabled (Rule)</div><div class="stat-value" style="color: #f87171;">${c.disabledByRule || 0}</div></div>
          <div class="stat" style="min-width: 100px; background: #0a2f0a;"><div class="stat-label">Invalid</div><div class="stat-value" style="color: ${c.invalidRows > 0 ? '#ff6b6b' : '#4ade80'};">${c.invalidRows || 0}</div></div>
        `;
        document.getElementById("catalogPreviewStats").innerHTML = statsHtml;

        if (data.invalid && data.invalid.length > 0) {
          let errorsHtml = '<div style="background: #2a1a1a; border-radius: 4px; padding: 10px; max-height: 150px; overflow-y: auto;">';
          data.invalid.slice(0, 20).forEach(err => {
            errorsHtml += '<div style="color: #ff6b6b; font-size: 12px; margin-bottom: 4px;">Row ' + err.rowNumber + ': ' + err.reason + '</div>';
          });
          if (data.invalid.length > 20) {
            errorsHtml += '<div style="color: #aaa; font-size: 11px;">... and ' + (data.invalid.length - 20) + ' more errors</div>';
          }
          errorsHtml += '</div>';
          document.getElementById("catalogPreviewErrors").innerHTML = errorsHtml;
        } else {
          document.getElementById("catalogPreviewErrors").innerHTML = '';
        }

        if (data.changes && data.changes.length > 0) {
          let changesHtml = '<h4 style="color: #4ade80; margin-bottom: 10px;">Sample Changes (max 100)</h4><table style="width: 100%; font-size: 12px;"><thead><tr><th>Product ID</th><th>Slug</th><th>Action</th><th>Fields Changed</th></tr></thead><tbody>';
          data.changes.slice(0, 50).forEach(ch => {
            let actionColor = '#fbbf24'; // default update color
            if (ch.action === 'create') actionColor = '#60a5fa';
            else if (ch.action === 'disable_rule') actionColor = '#f87171'; // red for rule-disabled
            changesHtml += '<tr><td style="color: #aaa;">' + ch.product_id + '</td><td>' + (ch.slug || '-') + '</td><td style="color: ' + actionColor + ';">' + ch.action + (ch.ruleReason ? ' (' + ch.ruleReason.substring(0, 30) + ')' : '') + '</td><td style="color: #86efac;">' + (ch.fieldsChanged || []).join(', ') + '</td></tr>';
          });
          changesHtml += '</tbody></table>';
          document.getElementById("catalogPreviewChanges").innerHTML = changesHtml;
        } else if (data.disabledByRuleIds && data.disabledByRuleIds.length > 0) {
          // Show rule-disabled products even if no other changes
          let changesHtml = '<h4 style="color: #f87171; margin-bottom: 10px;">Products to Disable by Rule (' + data.disabledByRuleIds.length + ')</h4><table style="width: 100%; font-size: 12px;"><thead><tr><th>Product ID</th><th>Title</th><th>Reason</th></tr></thead><tbody>';
          data.disabledByRuleIds.slice(0, 50).forEach(item => {
            changesHtml += '<tr><td style="color: #aaa;">' + item.id + '</td><td>' + (item.title || '-') + '</td><td style="color: #f87171;">' + (item.reason || 'non-pet') + '</td></tr>';
          });
          changesHtml += '</tbody></table>';
          document.getElementById("catalogPreviewChanges").innerHTML = changesHtml;
        } else {
          document.getElementById("catalogPreviewChanges").innerHTML = '<div style="color: #86efac;">No changes detected.</div>';
        }

        document.getElementById("catalogPreview").style.display = "block";
        // Enable Apply when:
        // 1. Preview succeeded (ok=true)
        // 2. No invalid rows OR we have valid rows
        // 3. ANY change exists: creates, updates, disables, disabledByRule, OR valid unchanged rows
        const hasChanges = (c.creates || 0) + (c.updates || 0) + (c.disables || 0) + (c.disabledByRule || 0) > 0;
        const hasValidRows = (c.validRows || 0) > 0 && (c.invalidRows || 0) === 0;
        const canApply = data.ok && (hasChanges || hasValidRows);
        document.getElementById("applyCatalogBtn").disabled = !canApply;
        console.log('[CatalogPreview] canApply:', canApply, 'hasChanges:', hasChanges, 'hasValidRows:', hasValidRows, 'counts:', c);
        const parts = [];
        if (c.creates > 0) parts.push(c.creates + " creates");
        if (c.updates > 0) parts.push(c.updates + " updates");
        if ((c.disables || 0) + (c.disabledByRule || 0) > 0) parts.push(((c.disables || 0) + (c.disabledByRule || 0)) + " disables");
        showToast("Catalog preview ready: " + (parts.length > 0 ? parts.join(", ") : "no changes"));

      } catch (err) {
        showToast("Preview failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Preview Catalog Changes";
      }
    }

    async function applyCatalogImport() {
      if (!catalogSelectedFile) {
        showToast("Please select a CSV file first", "error");
        return;
      }

      if (!catalogPreviewData) {
        showToast("Please run preview first", "error");
        return;
      }

      const c = catalogPreviewData.counts || {};
      const totalChanges = (c.creates || 0) + (c.updates || 0) + (c.disables || 0) + (c.disabledByRule || 0);
      if (totalChanges === 0) {
        showToast("No changes to apply", "error");
        return;
      }

      const parts = [];
      if (c.creates > 0) parts.push(c.creates + " creates");
      if (c.updates > 0) parts.push(c.updates + " updates");
      const disableCount = (c.disables || 0) + (c.disabledByRule || 0);
      if (disableCount > 0) parts.push(disableCount + " disables");
      if (!window.confirm("Apply catalog changes: " + parts.join(", ") + "?")) {
        return;
      }

      const btn = document.getElementById("applyCatalogBtn");
      btn.disabled = true;
      btn.textContent = "Applying...";

      try {
        const fd = new FormData();
        fd.append("file", catalogSelectedFile);
        
        const response = await fetch("/api/admin/catalog/apply", {
          method: "POST",
          body: fd,
          credentials: "include",
          headers: getAdminHeaders()
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || "Catalog apply failed");
        }

        const dc = data.counts || {};
        const successParts = [];
        if (dc.created > 0) successParts.push(dc.created + " created");
        if (dc.updated > 0) successParts.push(dc.updated + " updated");
        const totalDisabled = (dc.disabled || 0) + (dc.disabledByRule || 0);
        if (totalDisabled > 0) successParts.push(totalDisabled + " disabled");
        showToast("Success! " + (successParts.length > 0 ? successParts.join(", ") : "No changes") + " (fingerprint: " + data.fingerprint + ")");
        catalogSelectedFile = null;
        catalogPreviewData = null;
        document.getElementById("catalogFileName").style.display = "none";
        document.getElementById("catalogPreview").style.display = "none";
        document.getElementById("previewCatalogBtn").disabled = true;
        document.getElementById("applyCatalogBtn").disabled = true;
        document.getElementById("catalogCsvFile").value = "";

      } catch (err) {
        showToast("Apply failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Apply Catalog Changes";
      }
    }

    async function disableNonPetProducts() {
      if (!window.confirm("This will disable ALL non-pet products in the catalog. Products matching blacklist patterns (jewelry, makeup, clothing, etc.) will be marked as inactive. Continue?")) {
        return;
      }

      const btn = document.getElementById("disableNonPetBtn");
      btn.disabled = true;
      btn.textContent = "Disabling...";

      try {
        const response = await fetch("/api/admin/catalog/disable-non-pet", {
          method: "POST",
          credentials: "include",
          headers: getAdminHeaders()
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || "Failed to disable non-pet products");
        }

        let msg = data.message;
        if (data.stats) {
          msg = `Disabled ${data.stats.disabled} non-pet products. ${data.stats.alreadyDisabled} already disabled. ${data.stats.petProducts} pet products remain.`;
        }
        showToast(msg);
        
        if (data.disabledItems && data.disabledItems.length > 0) {
          let html = '<h4 style="color: #ef4444; margin-bottom: 10px;">Disabled Items:</h4><ul style="font-size: 12px; max-height: 200px; overflow-y: auto;">';
          data.disabledItems.forEach(item => {
            html += `<li style="margin-bottom: 4px;"><strong>${item.title}</strong> - ${item.reason || 'non-pet'}</li>`;
          });
          html += '</ul>';
          
          const preview = document.getElementById("catalogPreview");
          preview.innerHTML = html;
          preview.style.display = "block";
        }

      } catch (err) {
        showToast("Failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "üö´ Disable Non-Pet Products";
      }
    }

    async function previewReprice() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = "Calculating...";

      try {
        const data = await apiFetch("/api/admin/pricing/pricing/reprice?mode=dryrun", { method: "POST" });
        
        let html = `
          <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">
            <div class="stat" style="min-width: 120px;"><div class="stat-label">Products to Reprice</div><div class="stat-value">${data.products_to_update}</div></div>
            <div class="stat" style="min-width: 120px;"><div class="stat-label">Price Increases</div><div class="stat-value" style="color: #00C4A7;">+${data.summary?.increases || 0}</div></div>
            <div class="stat" style="min-width: 120px;"><div class="stat-label">Price Decreases</div><div class="stat-value" style="color: #ff6b6b;">-${data.summary?.decreases || 0}</div></div>
            <div class="stat" style="min-width: 120px;"><div class="stat-label">Avg Change</div><div class="stat-value">$${data.summary?.avg_price_change || 0}</div></div>
          </div>
          <div style="max-height: 300px; overflow-y: auto;">
            <table>
              <thead><tr><th>Product</th><th>Cost</th><th>Current</th><th>Suggested</th><th>Multiplier</th></tr></thead>
              <tbody>
        `;
        (data.preview || []).slice(0, 50).forEach(p => {
          html += `<tr>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; font-size: 11px;">${p.title || p.productId}</td>
            <td>$${p.cost.toFixed(2)}</td>
            <td style="color: #aaa;">$${p.currentPrice.toFixed(2)}</td>
            <td style="color: #00C4A7;">$${p.suggestedPrice.toFixed(2)}</td>
            <td>x${p.multiplier.toFixed(1)}</td>
          </tr>`;
        });
        html += '</tbody></table></div>';

        document.getElementById("repricePreview").innerHTML = html;
        document.getElementById("repricePreview").style.display = "block";
        showToast(`Preview ready: ${data.products_to_update} products can be repriced`);

      } catch (err) {
        showToast("Preview failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Preview Reprice";
      }
    }

    async function applyReprice() {
      if (!window.confirm("Apply automatic repricing to ALL products? This will update prices based on the pricing engine.")) {
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.textContent = "Repricing...";

      try {
        const data = await apiFetch("/api/admin/pricing/pricing/reprice?mode=apply", { method: "POST" });
        showToast(`Success! Repriced ${data.updated_count} products`);
        document.getElementById("repricePreview").style.display = "none";
      } catch (err) {
        showToast("Reprice failed: " + err.message, "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Apply Reprice to All";
      }
    }

    async function loadPricingAudit() {
      const container = document.getElementById("pricingAuditLog");
      container.innerHTML = '<div class="loading">Loading audit log...</div>';

      try {
        const data = await apiFetch("/api/admin/pricing/pricing/audit?limit=50");
        
        if (!data.entries || data.entries.length === 0) {
          container.innerHTML = '<p style="color: #aaa;">No audit entries yet.</p>';
          return;
        }

        let html = '<table style="font-size: 11px;"><thead><tr><th>Date</th><th>Product</th><th>Old</th><th>New</th><th>Source</th></tr></thead><tbody>';
        data.entries.forEach(e => {
          html += `<tr>
            <td style="white-space: nowrap;">${new Date(e.timestamp).toLocaleString()}</td>
            <td style="font-family: monospace;">${e.productId?.slice(0, 8)}...</td>
            <td style="color: #ff6b6b;">$${parseFloat(e.oldValue).toFixed(2)}</td>
            <td style="color: #00C4A7;">$${parseFloat(e.newValue).toFixed(2)}</td>
            <td>${e.source}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        showToast(`Loaded ${data.entries.length} audit entries`);

      } catch (err) {
        container.innerHTML = `<p style="color: #ff6b6b;">Error: ${err.message}</p>`;
      }
    }

    // Drag and drop for pricing upload
    document.addEventListener("DOMContentLoaded", function() {
      const zone = document.getElementById("pricingUploadZone");
      if (zone) {
        zone.addEventListener("dragover", e => {
          e.preventDefault();
          zone.style.borderColor = "#00C4A7";
          zone.style.background = "#1a2a2e";
        });
        zone.addEventListener("dragleave", e => {
          zone.style.borderColor = "#262643";
          zone.style.background = "transparent";
        });
        zone.addEventListener("drop", e => {
          e.preventDefault();
          zone.style.borderColor = "#262643";
          zone.style.background = "transparent";
          const file = e.dataTransfer.files[0];
          if (file && file.name.endsWith(".csv")) {
            handlePricingFileSelect({ target: { files: [file] } });
          } else {
            showToast("Please drop a CSV file", "error");
          }
        });
      }
    });
  </script>
</body>
</html>
