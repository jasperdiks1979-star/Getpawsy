#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const BUILD_ID = process.env.BUILD_FINGERPRINT || fs.readFileSync('/tmp/build_fingerprint.txt', 'utf8').trim().split('\n')[0] || 'unknown';
const RESULTS_FILE = path.join(__dirname, '../public/qa/results.json');
const REPORT_FILE = path.join(__dirname, '../reports/last-run.md');

function generateReport() {
  const timestamp = new Date().toISOString();
  let results = { suites: [], stats: { passed: 0, failed: 0, skipped: 0 } };
  
  try {
    if (fs.existsSync(RESULTS_FILE)) {
      results = JSON.parse(fs.readFileSync(RESULTS_FILE, 'utf8'));
    }
  } catch (e) {
    console.log('No results file found, generating empty report');
  }

  const totalTests = (results.stats?.expected || 0) + (results.stats?.unexpected || 0) + (results.stats?.skipped || 0);
  const passed = results.stats?.expected || 0;
  const failed = results.stats?.unexpected || 0;
  const skipped = results.stats?.skipped || 0;

  const report = `# GetPawsy QA Report

## Build Information
- **Build ID:** ${BUILD_ID}
- **Generated:** ${timestamp}
- **Environment:** ${process.env.NODE_ENV || 'development'}

## Test Summary
| Metric | Count |
|--------|-------|
| Total Tests | ${totalTests} |
| Passed | ${passed} |
| Failed | ${failed} |
| Skipped | ${skipped} |
| Pass Rate | ${totalTests > 0 ? ((passed / totalTests) * 100).toFixed(1) : 0}% |

## Test Results

${results.suites?.map(suite => {
  return `### ${suite.title || 'Suite'}
${suite.specs?.map(spec => {
  const status = spec.ok ? '✅' : '❌';
  return `- ${status} ${spec.title}`;
}).join('\n') || 'No specs'}
`;
}).join('\n') || 'No test suites found'}

## Artifacts
- HTML Report: \`public/qa/html-report/index.html\`
- JSON Results: \`public/qa/results.json\`
- Screenshots: \`public/qa/artifacts/\`

## Root Causes Fixed
1. **Cart "not ready" race condition** - Added \`findItem()\` method and 2s wait loop
2. **Variant support** - Updated \`setQty()\` and \`removeItem()\` to support variantId
3. **Cart version** - Updated to 2.9.0 with full variant support

## Files Changed
- \`public/js/cart-store.js\` - Added findItem(), updated method signatures
- \`public/js/cart-delegate.js\` - Already had variant support
- \`tests/e2e/critical-journeys.spec.js\` - New comprehensive test suite

---
*Generated by GetPawsy QA System*
`;

  fs.mkdirSync(path.dirname(REPORT_FILE), { recursive: true });
  fs.writeFileSync(REPORT_FILE, report);
  console.log(`QA Report generated: ${REPORT_FILE}`);
  console.log(`Build ID: ${BUILD_ID}`);
  console.log(`Tests: ${passed}/${totalTests} passed (${failed} failed, ${skipped} skipped)`);
}

generateReport();
